<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>p4est: particles/particles2.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">p4est
   &#160;<span id="projectnumber">2.8.7</span>
   </div>
   <div id="projectbrief">p4est is a software library for parallel adaptive mesh refinement.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">particles/particles2.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>2D version of a generic particle tracking demo (3D counterpart: <a class="el" href="particles_2particles3_8c-example.html">particles/particles3.c</a>).For a high-level description of the concepts implemented and references to important <a class="el" href="structp4est.html" title="The p4est forest datatype.">p4est</a> calls please see <a class="el" href="example_particles.html">A particle tracking example</a>.</p>
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">  This file is part of p4est.</span></div>
<div class="line"><span class="comment">  p4est is a C library to manage a collection (a forest) of multiple</span></div>
<div class="line"><span class="comment">  connected adaptive quadtrees or octrees in parallel.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  Copyright (C) 2010 The University of Texas System</span></div>
<div class="line"><span class="comment">  Additional copyright (C) 2011 individual authors</span></div>
<div class="line"><span class="comment">  Written by Carsten Burstedde, Lucas C. Wilcox, and Tobin Isaac</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  p4est is free software; you can redistribute it and/or modify</span></div>
<div class="line"><span class="comment">  it under the terms of the GNU General Public License as published by</span></div>
<div class="line"><span class="comment">  the Free Software Foundation; either version 2 of the License, or</span></div>
<div class="line"><span class="comment">  (at your option) any later version.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  p4est is distributed in the hope that it will be useful,</span></div>
<div class="line"><span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><span class="comment">  GNU General Public License for more details.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  You should have received a copy of the GNU General Public License</span></div>
<div class="line"><span class="comment">  along with p4est; if not, write to the Free Software Foundation, Inc.,</span></div>
<div class="line"><span class="comment">  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * The particle demo compiles from this file twice into one 2D version</span></div>
<div class="line"><span class="comment"> * and one 3D version.  Most of the code is dimension independent.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef P4_TO_P8</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p4est__bits_8h.html">p4est_bits.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p4est__build_8h.html">p4est_build.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p4est__communication_8h.html">p4est_communication.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p4est__extended_8h.html">p4est_extended.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p4est__search_8h.html">p4est_search.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p4est__vtk_8h.html">p4est_vtk.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p8est__bits_8h.html">p8est_bits.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p8est__build_8h.html">p8est_build.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p8est__communication_8h.html">p8est_communication.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p8est__extended_8h.html">p8est_extended.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p8est__search_8h.html">p8est_search.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p8est__vtk_8h.html">p8est_vtk.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* P4_TO_P8 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#include &lt;sc_notify.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sc_options.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;particles_global.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define PARTICLES_xstr(s) PARTICLES_str(s)</span></div>
<div class="line"><span class="preprocessor">#define PARTICLES_str(s) #s</span></div>
<div class="line"><span class="preprocessor">#define PARTICLES_48() PARTICLES_xstr(P4EST_CHILDREN)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Send full particle information in first message, comment out if not */</span></div>
<div class="line"><span class="preprocessor">#define PART_SENDFULL</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Context data to compute initial particle positions */</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>pi_data</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">double</span>              sigma;</div>
<div class="line">  <span class="keywordtype">double</span>              invs2;</div>
<div class="line">  <span class="keywordtype">double</span>              gnorm;</div>
<div class="line">  <span class="keywordtype">double</span>              center[3];</div>
<div class="line">}</div>
<div class="line">pi_data_t;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Data type for payload data inside each quadrant */</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>qu_data</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">union</span></div>
<div class="line">  {</div>
<div class="line">    <span class="comment">/* Offset into local array of all particles after this quadrant */</span></div>
<div class="line">    <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      lpend;</div>
<div class="line">    <span class="keywordtype">double</span>              d;</div>
<div class="line">  } u;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* counts of local particles remaining on this quadrant and received ones */</span></div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      premain, preceive;</div>
<div class="line">}</div>
<div class="line">qu_data_t;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Property data stored in a flat array over all particles */</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>pa_data</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">double</span>              xv[6];</div>
<div class="line">  <span class="keywordtype">double</span>              wo[6];</div>
<div class="line">  <span class="keywordtype">double</span>              up[6];</div>
<div class="line">  <span class="keywordtype">double</span>              rm[3];</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>      id;</div>
<div class="line">}</div>
<div class="line">pa_data_t;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">ppad (part_global_t * g, <span class="keyword">const</span> <span class="keywordtype">char</span> *lead)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span>              zz;</div>
<div class="line">  pa_data_t          *pad;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;padata != NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (lead != NULL) {</div>
<div class="line">    P4EST_VERBOSEF (<span class="stringliteral">&quot;PPAD %s\n&quot;</span>, lead);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (zz = 0; zz &lt; g-&gt;padata-&gt;elem_count; ++zz) {</div>
<div class="line">    pad = (pa_data_t *) sc_array_index (g-&gt;padata, zz);</div>
<div class="line">    P4EST_VERBOSEF (<span class="stringliteral">&quot;PPAD L %d I %d\n&quot;</span>, (<span class="keywordtype">int</span>) zz, (<span class="keywordtype">int</span>) pad-&gt;id);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">lrem (part_global_t * g, <span class="keyword">const</span> <span class="keywordtype">char</span> *lead)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span>              zz;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      lrem;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;iremain != NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (lead != NULL) {</div>
<div class="line">    P4EST_VERBOSEF (<span class="stringliteral">&quot;LREM %s\n&quot;</span>, lead);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (zz = 0; zz &lt; g-&gt;iremain-&gt;elem_count; ++zz) {</div>
<div class="line">    lrem = *(<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> *) sc_array_index (g-&gt;iremain, zz);</div>
<div class="line">    P4EST_VERBOSEF (<span class="stringliteral">&quot;LREM Z %d N %d\n&quot;</span>, (<span class="keywordtype">int</span>) zz, (<span class="keywordtype">int</span>) lrem);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef PART_SENDFULL</span></div>
<div class="line"><span class="preprocessor">#define PART_MSGSIZE (sizeof (pa_data_t))</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">#define PART_MSGSIZE (3 * sizeof (double))</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Hash table entry for a process that we send messages to */</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>comm_psend</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 rank;</div>
<div class="line">  sc_array_t          message;     <span class="comment">/*&lt; Message data to send */</span></div>
<div class="line">}</div>
<div class="line">comm_psend_t;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Array entry for a process that we send messages to */</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>comm_prank</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 rank;</div>
<div class="line">  comm_psend_t       *psend;        <span class="comment">/*&lt; Points to hash table entry */</span></div>
<div class="line">}</div>
<div class="line">comm_prank_t;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> comm_tag</div>
<div class="line">{</div>
<div class="line">  COMM_TAG_PART = P4EST_COMM_TAG_LAST,</div>
<div class="line">  COMM_TAG_FIXED,</div>
<div class="line">  COMM_TAG_CUSTOM,</div>
<div class="line">  COMM_TAG_LAST</div>
<div class="line">}</div>
<div class="line">comm_tag_t;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> planet_xyz[3][3] = {</div>
<div class="line">  {.48, .58, .59},</div>
<div class="line">  {.58, .41, .46},</div>
<div class="line">  {.51, .52, .42}</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> planet_mass[3] = { .049, .167, .06 };</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> pidensy_sigma = .07;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> pidensy_center[3] = { .3, .4, .5 };</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define PART_NQPOINTS 3</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">double</span>       qpoints[PART_NQPOINTS];</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">double</span>       qweights[PART_NQPOINTS];</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> rk1b[1] = { 0. };   <span class="comment">/*&lt; avoid -pedantic warning for [0] */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> rk1g[1] = { 1. };</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> rk2b[1] = { 1. };</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> rk2g[2] = { .5, .5 };</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> rk3b[2] = { 1. / 3., 2. / 3. };</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> rk3g[3] = { .25, 0., .75 };</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> rk4b[3] = { .5, .5, 1. };</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> rk4g[4] = { 1. / 6., 1. / 3., 1. / 3., 1. / 6. };</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> *prk[4][2] = {</div>
<div class="line">  {rk1b, rk1g},</div>
<div class="line">  {rk2b, rk2g},</div>
<div class="line">  {rk3b, rk3g},</div>
<div class="line">  {rk4b, rk4g}</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>  *snames[PART_STATS_LAST] = {</div>
<div class="line">  <span class="stringliteral">&quot;Notify&quot;</span>,</div>
<div class="line">  <span class="stringliteral">&quot;Binary&quot;</span>,</div>
<div class="line">  <span class="stringliteral">&quot;Nary&quot;</span>,</div>
<div class="line">  <span class="stringliteral">&quot;Comm&quot;</span>,</div>
<div class="line">  <span class="stringliteral">&quot;Wait_A&quot;</span>,</div>
<div class="line">  <span class="stringliteral">&quot;Wait_B&quot;</span>,</div>
<div class="line">  <span class="stringliteral">&quot;Num_Peers&quot;</span>,</div>
<div class="line">  <span class="stringliteral">&quot;Search_P&quot;</span>,</div>
<div class="line">  <span class="stringliteral">&quot;Search_L&quot;</span>,</div>
<div class="line">  <span class="stringliteral">&quot;Trans_F&quot;</span>,</div>
<div class="line">  <span class="stringliteral">&quot;Trans_C&quot;</span>,</div>
<div class="line">  <span class="stringliteral">&quot;Build&quot;</span>,</div>
<div class="line">  <span class="stringliteral">&quot;Pertree_F&quot;</span>,</div>
<div class="line">  <span class="stringliteral">&quot;Pertree_B&quot;</span>,</div>
<div class="line">  <span class="stringliteral">&quot;RK&quot;</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">p4est_free_int (<span class="keywordtype">int</span> **pptr)</div>
<div class="line">{</div>
<div class="line">  P4EST_ASSERT (pptr != NULL);</div>
<div class="line">  <a name="a0"></a><a class="code" href="p4est__base_8h.html#a0b2d45f13b66edfed0ccfde75808c745">P4EST_FREE</a> (*pptr);</div>
<div class="line">  *pptr = NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">part_string_to_int (<span class="keyword">const</span> <span class="keywordtype">char</span> *str, <span class="keywordtype">int</span> n, ...)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 i, j;</div>
<div class="line">  <span class="keywordtype">int</span>                *pi;</div>
<div class="line">  <span class="keywordtype">char</span>                buf[BUFSIZ];</div>
<div class="line">  va_list             ap;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (n &gt;= 0);</div>
<div class="line">  <span class="keywordflow">if</span> (str == NULL || n == 0) {</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* use a once-loop for clean early return */</span></div>
<div class="line">  va_start (ap, n);</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    <span class="keywordflow">if</span> (n == 1) {</div>
<div class="line">      pi = va_arg (ap, <span class="keywordtype">int</span> *);</div>
<div class="line">      *pi = atoi (str);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    j = snprintf (buf, BUFSIZ, <span class="stringliteral">&quot;%s&quot;</span>, <span class="stringliteral">&quot;%d&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (j &gt;= BUFSIZ) {</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (i = 1; i &lt; n; ++i) {</div>
<div class="line">      j += snprintf (buf + j, BUFSIZ - j, <span class="stringliteral">&quot;:%s&quot;</span>, <span class="stringliteral">&quot;%d&quot;</span>);</div>
<div class="line">      <span class="keywordflow">if</span> (j &gt;= BUFSIZ) {</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* we ignore return values and rely on defaults */</span></div>
<div class="line">    vsscanf (str, buf, ap);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">while</span> (0);</div>
<div class="line">  va_end (ap);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span>        *</div>
<div class="line">sc_array_index_begin (sc_array_t * arr)</div>
<div class="line">{</div>
<div class="line">  P4EST_ASSERT (arr != NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (arr-&gt;elem_count == 0) {</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (arr-&gt;array != NULL);</div>
<div class="line">  <span class="keywordflow">return</span> (<span class="keywordtype">void</span> *) arr-&gt;array;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef P4EST_ENABLE_DEBUG</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span>        *</div>
<div class="line">sc_array_index_end (sc_array_t * arr)</div>
<div class="line">{</div>
<div class="line">  P4EST_ASSERT (arr != NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (arr-&gt;elem_count == 0) {</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (arr-&gt;array != NULL);</div>
<div class="line">  <span class="keywordflow">return</span> (<span class="keywordtype">void</span> *) (arr-&gt;array + arr-&gt;elem_count * arr-&gt;elem_size);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* With two initialized arrays of same metadata, copy array data */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">sc_array_paste (sc_array_t * dest, sc_array_t * src)</div>
<div class="line">{</div>
<div class="line">  P4EST_ASSERT (dest-&gt;elem_size == src-&gt;elem_size);</div>
<div class="line">  P4EST_ASSERT (dest-&gt;elem_count == src-&gt;elem_count);</div>
<div class="line"> </div>
<div class="line">  memcpy (dest-&gt;array, src-&gt;array, src-&gt;elem_count * src-&gt;elem_size);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Initialize one array with contents from other, reinit the other */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">sc_array_swap_init (sc_array_t * array, sc_array_t * from, <span class="keywordtype">size_t</span> elem_size)</div>
<div class="line">{</div>
<div class="line">  *array = *from;</div>
<div class="line">  sc_array_init (from, elem_size);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Turn statistics collected so far into one value */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">sc_stats_collapse (sc_statinfo_t * stats)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">double</span>              value;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (stats-&gt;dirty);</div>
<div class="line">  <span class="keywordflow">if</span> (stats-&gt;count) {</div>
<div class="line">    value = stats-&gt;sum_values / (double) stats-&gt;count;</div>
<div class="line">    stats-&gt;sum_values = value;</div>
<div class="line">    stats-&gt;sum_squares = value * value;</div>
<div class="line">    stats-&gt;min = stats-&gt;max = value;</div>
<div class="line">    stats-&gt;count = 1;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">comm_prank_compare (<span class="keyword">const</span> <span class="keywordtype">void</span> *v1, <span class="keyword">const</span> <span class="keywordtype">void</span> *v2)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> sc_int_compare (&amp;((<span class="keyword">const</span> comm_prank_t *) v1)-&gt;rank,</div>
<div class="line">                         &amp;((<span class="keyword">const</span> comm_prank_t *) v2)-&gt;rank);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">double</span></div>
<div class="line">gaussnorm (<span class="keywordtype">double</span> sigma)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> pow (2. * M_PI * sigma * sigma, -.5 * <a name="a1"></a><a class="code" href="p4est__connectivity_8h.html#a2c4786e65053166a16b7afb2711d35cb">P4EST_DIM</a>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">double</span></div>
<div class="line">pidense (<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y, <span class="keywordtype">double</span> z, <span class="keywordtype">void</span> *data)</div>
<div class="line">{</div>
<div class="line">  pi_data_t          *piddata = (pi_data_t *) data;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (piddata != NULL);</div>
<div class="line">  P4EST_ASSERT (piddata-&gt;sigma &gt; 0.);</div>
<div class="line">  P4EST_ASSERT (piddata-&gt;invs2 &gt; 0.);</div>
<div class="line">  P4EST_ASSERT (piddata-&gt;gnorm &gt; 0.);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> piddata-&gt;gnorm * exp (-.5 * (SC_SQR (x - piddata-&gt;center[0]) +</div>
<div class="line">                                      SC_SQR (y - piddata-&gt;center[1]) +</div>
<div class="line">                                      SC_SQR (z - piddata-&gt;center[2])) *</div>
<div class="line">                               piddata-&gt;invs2);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">loopquad (part_global_t * g, <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> tt, <a name="_a2"></a><a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quad,</div>
<div class="line">          <span class="keywordtype">double</span> lxyz[3], <span class="keywordtype">double</span> hxyz[3], <span class="keywordtype">double</span> dxyz[3])</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">int</span>                 i;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a05ea8ceb664ae2403fbcf7b1dcc70ea0">p4est_qcoord_t</a>      qh;</div>
<div class="line"> </div>
<div class="line">  qh = <a name="a3"></a><a class="code" href="p4est_8h.html#a95dd59166894e55562dd7bb741bb78c5">P4EST_QUADRANT_LEN</a> (quad-&gt;<a name="a4"></a><a class="code" href="structp4est__quadrant.html#a0f92ad9bd71d9e3f82246d2768ff23ad">level</a>);</div>
<div class="line">  <a name="a5"></a><a class="code" href="p4est_8h.html#a90acb1ef22be84e31afdec64aab60567">p4est_qcoord_to_vertex</a> (g-&gt;conn, tt, quad-&gt;<a name="a6"></a>x, quad-&gt;<a name="a7"></a><a class="code" href="structp4est__quadrant.html#ad226034132b973fe7955ef797938dea0">y</a>,</div>
<div class="line">#ifdef P4_TO_P8</div>
<div class="line">                          quad-&gt;z,</div>
<div class="line">#endif</div>
<div class="line">                          lxyz);</div>
<div class="line">  <a class="code" href="p4est_8h.html#a90acb1ef22be84e31afdec64aab60567">p4est_qcoord_to_vertex</a> (g-&gt;conn, tt, quad-&gt;x + qh, quad-&gt;<a class="code" href="structp4est__quadrant.html#ad226034132b973fe7955ef797938dea0">y</a> + qh,</div>
<div class="line">#ifdef P4_TO_P8</div>
<div class="line">                          quad-&gt;z + qh,</div>
<div class="line">#endif</div>
<div class="line">                          hxyz);</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; 3; ++i) {</div>
<div class="line">    lxyz[i] /= g-&gt;bricklength;</div>
<div class="line">    hxyz[i] /= g-&gt;bricklength;</div>
<div class="line">    dxyz[i] = hxyz[i] - lxyz[i];</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">run_pre (part_global_t * g, pi_data_t * piddata)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 i;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* prepare parallel statistics */</span></div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; PART_STATS_LAST; ++i) {</div>
<div class="line">    sc_stats_init (g-&gt;si + i, snames[i]);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* prepare quadrature rule */</span></div>
<div class="line">  P4EST_ASSERT (PART_NQPOINTS == 3);</div>
<div class="line">  qpoints[2] = sqrt (3. / 5.);</div>
<div class="line">  qpoints[1] = 0.;</div>
<div class="line">  qpoints[0] = -qpoints[2];</div>
<div class="line">  qweights[0] = qweights[2] = 5. / 9.;</div>
<div class="line">  qweights[1] = 8. / 9.;</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; 3; ++i) {</div>
<div class="line">    qpoints[i] = .5 * (1. + qpoints[i]);</div>
<div class="line">    qweights[i] *= .5;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* the length of the brick is a power of 2 */</span></div>
<div class="line">  g-&gt;bricklength = (1 &lt;&lt; g-&gt;bricklev);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* initial particle density */</span></div>
<div class="line">  piddata-&gt;sigma = pidensy_sigma;</div>
<div class="line">  piddata-&gt;invs2 = 1. / SC_SQR (piddata-&gt;sigma);</div>
<div class="line">  piddata-&gt;gnorm = gaussnorm (piddata-&gt;sigma);</div>
<div class="line">  piddata-&gt;center[0] = pidensy_center[0];</div>
<div class="line">  piddata-&gt;center[1] = pidensy_center[1];</div>
<div class="line"><span class="preprocessor">#ifndef P4_TO_P8</span></div>
<div class="line">  piddata-&gt;center[2] = 0.;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  piddata-&gt;center[2] = pidensy_center[2];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  g-&gt;pidense = pidense;</div>
<div class="line">  g-&gt;piddata = piddata;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* allocate arrays that are reused a lot */</span></div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; 2; ++i) {</div>
<div class="line">    g-&gt;ilh[i] = sc_array_new (<span class="keyword">sizeof</span> (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>));</div>
<div class="line">    g-&gt;jlh[i] = sc_array_new (<span class="keyword">sizeof</span> (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>));</div>
<div class="line"><span class="preprocessor">#ifdef P4_TO_P8</span></div>
<div class="line">    g-&gt;klh[i] = sc_array_new (<span class="keyword">sizeof</span> (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>));</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    P4EST_ASSERT (g-&gt;klh[i] == NULL);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">run_post (part_global_t * g)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 i;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* clean up simulation memory */</span></div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; 2; ++i) {</div>
<div class="line">    sc_array_destroy_null (&amp;g-&gt;ilh[i]);</div>
<div class="line">    sc_array_destroy_null (&amp;g-&gt;jlh[i]);</div>
<div class="line"><span class="preprocessor">#ifdef P4_TO_P8</span></div>
<div class="line">    sc_array_destroy_null (&amp;g-&gt;klh[i]);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    P4EST_ASSERT (g-&gt;klh[i] == NULL);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* analyze parallel statistics */</span></div>
<div class="line">  <span class="keywordflow">if</span> (g-&gt;collapse) {</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; PART_STATS_LAST; ++i) {</div>
<div class="line">      sc_stats_collapse (g-&gt;si + i);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  sc_stats_compute (g-&gt;mpicomm, PART_STATS_LAST, g-&gt;si);</div>
<div class="line">  sc_stats_print (<a name="a8"></a><a class="code" href="p4est__base_8h.html#a43e4ed63c500a6dd8731d796703c39d1">p4est_package_id</a>, SC_LP_ESSENTIAL,</div>
<div class="line">                  PART_STATS_LAST, g-&gt;si, 1, 1);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">double</span></div>
<div class="line">integrate (part_global_t * g, <span class="keyword">const</span> <span class="keywordtype">double</span> lxyz[3], <span class="keyword">const</span> <span class="keywordtype">double</span> dxyz[3])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 i, j, k;</div>
<div class="line">  <span class="keywordtype">double</span>              wk, wkj, wkji;</div>
<div class="line">  <span class="keywordtype">double</span>              qpi[3], qpj[3], qpk[3];</div>
<div class="line">  <span class="keywordtype">double</span>              d;</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** run quadrature rule ***/</span></div>
<div class="line">  P4EST_ASSERT (PART_NQPOINTS == 3);</div>
<div class="line">  <span class="keywordflow">for</span> (k = 0; k &lt; 3; ++k) {</div>
<div class="line">    P4EST_ASSERT (qpoints[k] &gt;= 0. &amp;&amp; qpoints[k] &lt;= 1.);</div>
<div class="line">    qpi[k] = lxyz[0] + qpoints[k] * dxyz[0];</div>
<div class="line">    qpj[k] = lxyz[1] + qpoints[k] * dxyz[1];</div>
<div class="line">    qpk[k] = lxyz[2] + qpoints[k] * dxyz[2];</div>
<div class="line">  }</div>
<div class="line">  d = 0.;</div>
<div class="line"><span class="preprocessor">#ifdef P4_TO_P8</span></div>
<div class="line">  <span class="keywordflow">for</span> (k = 0; k &lt; 3; ++k) {</div>
<div class="line">    wk = qweights[k] * dxyz[2];</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  k = 1;</div>
<div class="line">  wk = 1.;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  <span class="keywordflow">for</span> (j = 0; j &lt; 3; ++j) {</div>
<div class="line">    wkj = wk * qweights[j] * dxyz[1];</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; 3; ++i) {</div>
<div class="line">      wkji = wkj * qweights[i] * dxyz[0];</div>
<div class="line">      d += wkji * g-&gt;pidense (qpi[i], qpj[j], qpk[k], g-&gt;piddata);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#ifdef P4_TO_P8</span></div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line">  {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  <span class="keywordflow">return</span> d;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">initrp_refine (<a name="_a9"></a><a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>,</div>
<div class="line">               <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree, <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quadrant)</div>
<div class="line">{</div>
<div class="line">  qu_data_t          *qud = (qu_data_t *) quadrant-&gt;<a name="a10"></a><a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a name="a11"></a><a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">  part_global_t      *g = (part_global_t *) <a class="code" href="structp4est.html">p4est</a>-&gt;<a name="a12"></a><a class="code" href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">user_pointer</a>;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      ilem_particles;</div>
<div class="line"> </div>
<div class="line">  ilem_particles =</div>
<div class="line">    (<a name="a13"></a><a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) round (qud-&gt;u.d * g-&gt;num_particles / g-&gt;global_density);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> (<span class="keywordtype">double</span>) ilem_particles &gt; g-&gt;elem_particles;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">initrp (part_global_t * g)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 mpiret;</div>
<div class="line">  <span class="keywordtype">int</span>                 cycle, max_cycles;</div>
<div class="line">  <span class="keywordtype">double</span>              lxyz[3], hxyz[3], dxyz[3];</div>
<div class="line">  <span class="keywordtype">double</span>              d, ld;</div>
<div class="line">  <span class="keywordtype">double</span>              refine_maxd, refine_maxl;</div>
<div class="line">  <span class="keywordtype">double</span>              loclp[2], glolp[2];</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a>      tt;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      lq;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      ilem_particles;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>      old_gnum, new_gnum;</div>
<div class="line">  <a name="_a14"></a><a class="code" href="structp4est__tree.html">p4est_tree_t</a>       *tree;</div>
<div class="line">  <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a>   *quad;</div>
<div class="line">  qu_data_t          *qud;</div>
<div class="line"> </div>
<div class="line">  glolp[0] = glolp[1] = 0.;</div>
<div class="line">  max_cycles = g-&gt;maxlevel - g-&gt;minlevel;</div>
<div class="line">  <span class="keywordflow">for</span> (cycle = 0;; ++cycle) {</div>
<div class="line"><span class="comment">    /*** iterate through local cells to determine local particle density ***/</span></div>
<div class="line">    ld = 0.;</div>
<div class="line">    refine_maxd = refine_maxl = 0.;</div>
<div class="line">    <span class="keywordflow">for</span> (tt = g-&gt;p4est-&gt;first_local_tree; tt &lt;= g-&gt;<a class="code" href="structp4est.html">p4est</a>-&gt;<a name="a15"></a><a class="code" href="structp4est.html#abd072c07f3197827fe22c16379de6ab8">last_local_tree</a>;</div>
<div class="line">         ++tt) {</div>
<div class="line">      tree = p4est_tree_array_index (g-&gt;p4est-&gt;trees, tt);</div>
<div class="line">      <span class="keywordflow">for</span> (lq = 0; lq &lt; (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) tree-&gt;<a name="a16"></a><a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>.elem_count; ++lq) {</div>
<div class="line">        quad = p4est_quadrant_array_index (&amp;tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>, lq);</div>
<div class="line">        qud = (qu_data_t *) quad-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">        loopquad (g, tt, quad, lxyz, hxyz, dxyz);</div>
<div class="line"> </div>
<div class="line"><span class="comment">        /***  integrate density over quadrant ***/</span></div>
<div class="line">        qud-&gt;u.d = d = integrate (g, lxyz, dxyz);</div>
<div class="line">        ld += d;</div>
<div class="line"> </div>
<div class="line"><span class="comment">        /*** maximum particle count and level ***/</span></div>
<div class="line">        refine_maxd = SC_MAX (refine_maxd, d);</div>
<div class="line">        refine_maxl = SC_MAX (refine_maxl, (<span class="keywordtype">double</span>) quad-&gt;<a class="code" href="structp4est__quadrant.html#a0f92ad9bd71d9e3f82246d2768ff23ad">level</a>);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="comment">    /*** get global integral over density ***/</span></div>
<div class="line">    mpiret = sc_MPI_Allreduce (&amp;ld, &amp;g-&gt;global_density, 1, sc_MPI_DOUBLE,</div>
<div class="line">                               sc_MPI_SUM, g-&gt;mpicomm);</div>
<div class="line">    SC_CHECK_MPI (mpiret);</div>
<div class="line">    P4EST_GLOBAL_STATISTICSF (<span class="stringliteral">&quot;Global integral over density %g\n&quot;</span>,</div>
<div class="line">                              g-&gt;global_density);</div>
<div class="line"> </div>
<div class="line"><span class="comment">    /*** get global maximum of particle count and level ***/</span></div>
<div class="line">    loclp[0] = refine_maxd;</div>
<div class="line">    loclp[1] = refine_maxl + g-&gt;bricklev;</div>
<div class="line">    mpiret = sc_MPI_Allreduce (loclp, glolp, 2, sc_MPI_DOUBLE,</div>
<div class="line">                               sc_MPI_MAX, g-&gt;mpicomm);</div>
<div class="line">    SC_CHECK_MPI (mpiret);</div>
<div class="line">    ilem_particles = (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) round</div>
<div class="line">      (glolp[0] * g-&gt;num_particles / g-&gt;global_density);</div>
<div class="line">    P4EST_GLOBAL_PRODUCTIONF</div>
<div class="line">      (<span class="stringliteral">&quot;Maximum particle number per quadrant %ld maxlevel %g\n&quot;</span>,</div>
<div class="line">       (<span class="keywordtype">long</span>) ilem_particles, glolp[1]);</div>
<div class="line"> </div>
<div class="line"><span class="comment">    /*** we have computed the density, this may be enough ***/</span></div>
<div class="line">    <span class="keywordflow">if</span> (cycle &gt;= max_cycles || (<span class="keywordtype">double</span>) ilem_particles &lt;= g-&gt;elem_particles) {</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="comment">    /*** refine and balance ***/</span></div>
<div class="line">    old_gnum = g-&gt;p4est-&gt;global_num_quadrants;</div>
<div class="line">    <a name="a17"></a><a class="code" href="p4est__extended_8h.html#aad32df9df3630b6bac05e7366a5f1e46">p4est_refine_ext</a> (g-&gt;p4est, 0, g-&gt;maxlevel - g-&gt;bricklev,</div>
<div class="line">                      initrp_refine, NULL, NULL);</div>
<div class="line">    new_gnum = g-&gt;p4est-&gt;global_num_quadrants;</div>
<div class="line">    <span class="keywordflow">if</span> (old_gnum == new_gnum) {</div>
<div class="line">      <span class="comment">/* done with refinement if no quadrants were added globally */</span></div>
<div class="line">      <span class="comment">/* cannot happen due to particle count above */</span></div>
<div class="line">      SC_ABORT_NOT_REACHED ();</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#if 0                           </span><span class="comment">/* we do not need balance for this application */</span><span class="preprocessor"></span></div>
<div class="line">    <span class="keywordflow">if</span> (cycle &gt; 0) {</div>
<div class="line">      <a name="a18"></a><a class="code" href="p4est_8h.html#a6b603736cf5007b14755197a9c179a85">p4est_balance</a> (g-&gt;p4est, <a name="a19"></a><a class="code" href="p4est__connectivity_8h.html#adc5f6166fc408c325589ce3e620552caa5bf35c11d90c02cb481e9edadb51bda7">P4EST_CONNECT_FULL</a>, NULL);</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">    /*** unweighted partition ***/</span></div>
<div class="line">    <a name="a20"></a><a class="code" href="p4est_8h.html#a54c1f4e6bc35c181952371a8046523aa">p4est_partition</a> (g-&gt;p4est, 0, NULL);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  P4EST_GLOBAL_ESSENTIALF (<span class="stringliteral">&quot;Created %lld quadrants at maxlevel %g\n&quot;</span>,</div>
<div class="line">                           (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) g-&gt;p4est-&gt;global_num_quadrants,</div>
<div class="line">                           glolp[1]);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">srandquad (part_global_t * g, <span class="keyword">const</span> <span class="keywordtype">double</span> l[3])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">unsigned</span>            u;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (0 &lt;= l[0] &amp;&amp; l[0] &lt; 1.);</div>
<div class="line">  P4EST_ASSERT (0 &lt;= l[1] &amp;&amp; l[1] &lt; 1.);</div>
<div class="line">  P4EST_ASSERT (0 &lt;= l[2] &amp;&amp; l[2] &lt; 1.);</div>
<div class="line"> </div>
<div class="line">  u = ((<span class="keywordtype">unsigned</span> int) (l[2] * (1 &lt;&lt; 10)) &lt;&lt; 20) +</div>
<div class="line">    ((<span class="keywordtype">unsigned</span> int) (l[1] * (1 &lt;&lt; 10)) &lt;&lt; 10) +</div>
<div class="line">    (<span class="keywordtype">unsigned</span> int) (l[0] * (1 &lt;&lt; 10));</div>
<div class="line">  srand (u);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">create (part_global_t * g)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 mpiret;</div>
<div class="line">  <span class="keywordtype">int</span>                 j;</div>
<div class="line">  <span class="keywordtype">double</span>              lxyz[3], hxyz[3], dxyz[3];</div>
<div class="line">  <span class="keywordtype">double</span>              r;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a>      tt;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      lpnum, lq;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      li, ilem_particles;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>      gpnum, gpoffset;</div>
<div class="line">  <a class="code" href="structp4est__tree.html">p4est_tree_t</a>       *tree;</div>
<div class="line">  <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a>   *quad;</div>
<div class="line">  qu_data_t          *qud;</div>
<div class="line">  pa_data_t          *pad;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g-&gt;padata != NULL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** iterate through local cells and populate with particles ***/</span></div>
<div class="line">  lpnum = 0;</div>
<div class="line">  <span class="keywordflow">for</span> (tt = g-&gt;p4est-&gt;first_local_tree; tt &lt;= g-&gt;<a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#abd072c07f3197827fe22c16379de6ab8">last_local_tree</a>; ++tt) {</div>
<div class="line">    tree = p4est_tree_array_index (g-&gt;p4est-&gt;trees, tt);</div>
<div class="line">    <span class="keywordflow">for</span> (lq = 0; lq &lt; (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>.elem_count; ++lq) {</div>
<div class="line">      quad = p4est_quadrant_array_index (&amp;tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>, lq);</div>
<div class="line">      qud = (qu_data_t *) quad-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* calculate required number of particles */</span></div>
<div class="line">      ilem_particles = (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) round</div>
<div class="line">        (qud-&gt;u.d / g-&gt;global_density * g-&gt;num_particles);</div>
<div class="line">      pad = (pa_data_t *) sc_array_push_count (g-&gt;padata, ilem_particles);</div>
<div class="line"> </div>
<div class="line"><span class="comment">      /*** generate required number of particles ***/</span></div>
<div class="line">      loopquad (g, tt, quad, lxyz, hxyz, dxyz);</div>
<div class="line">      srandquad (g, lxyz);</div>
<div class="line">      <span class="keywordflow">for</span> (li = 0; li &lt; ilem_particles; ++li) {</div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="p4est__connectivity_8h.html#a2c4786e65053166a16b7afb2711d35cb">P4EST_DIM</a>; ++j) {</div>
<div class="line">          r = rand () / (double) RAND_MAX;</div>
<div class="line">          pad-&gt;xv[j] = lxyz[j] + r * dxyz[j];</div>
<div class="line"> </div>
<div class="line">          <span class="comment">/* begin with some velocity choice */</span></div>
<div class="line">          pad-&gt;xv[3 + j] = 0.;</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">#ifndef P4_TO_P8</span></div>
<div class="line">        pad-&gt;xv[2] = pad-&gt;xv[5] = 0.;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">        memset (pad-&gt;wo, 0, 6 * sizeof (<span class="keywordtype">double</span>));</div>
<div class="line">        memset (pad-&gt;up, 0, 6 * sizeof (<span class="keywordtype">double</span>));</div>
<div class="line">        pad-&gt;rm[0] = pad-&gt;rm[1] = pad-&gt;rm[2] = -1.;</div>
<div class="line">        ++pad;</div>
<div class="line">      }</div>
<div class="line">      lpnum += ilem_particles;</div>
<div class="line">      qud-&gt;u.lpend = lpnum;</div>
<div class="line">      qud-&gt;premain = qud-&gt;preceive = 0;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  g-&gt;gplost = 0;</div>
<div class="line">  gpnum = (<a name="a21"></a><a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>) lpnum;</div>
<div class="line">  mpiret = sc_MPI_Allreduce (&amp;gpnum, &amp;g-&gt;gpnum, 1, P4EST_MPI_GLOIDX,</div>
<div class="line">                             sc_MPI_SUM, g-&gt;mpicomm);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line">  P4EST_GLOBAL_ESSENTIALF (<span class="stringliteral">&quot;Created %lld particles for %g\n&quot;</span>,</div>
<div class="line">                           (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) g-&gt;gpnum, g-&gt;num_particles);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* create globally unique particle numbers */</span></div>
<div class="line">  mpiret = sc_MPI_Exscan (&amp;gpnum, &amp;gpoffset, 1, P4EST_MPI_GLOIDX,</div>
<div class="line">                          sc_MPI_SUM, g-&gt;mpicomm);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line">  <span class="keywordflow">if</span> (g-&gt;mpirank == 0) {</div>
<div class="line">    gpoffset = 0;</div>
<div class="line">  }</div>
<div class="line">  pad = (pa_data_t *) sc_array_index_begin (g-&gt;padata);</div>
<div class="line">  <span class="keywordflow">for</span> (li = 0; li &lt; lpnum; ++li) {</div>
<div class="line">    (pad++)-&gt;<span class="keywordtype">id</span> = gpoffset + li;</div>
<div class="line">  }</div>
<div class="line">  P4EST_ASSERT (pad == (pa_data_t *) sc_array_index_end (g-&gt;padata));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">rkrhs (part_global_t * g, <span class="keyword">const</span> <span class="keywordtype">double</span> xv[6], <span class="keywordtype">double</span> rk[6])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 i;</div>
<div class="line">  <span class="keywordtype">int</span>                 j;</div>
<div class="line">  <span class="keywordtype">double</span>              d;</div>
<div class="line">  <span class="keywordtype">double</span>              diff[3];</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="p4est__connectivity_8h.html#a2c4786e65053166a16b7afb2711d35cb">P4EST_DIM</a>; ++i) {</div>
<div class="line">    rk[i] = xv[3 + i];</div>
<div class="line">    rk[3 + i] = 0.;</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#ifndef P4_TO_P8</span></div>
<div class="line">  rk[2] = rk[5] = 0.;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* we use as many planets as we have dimensions */</span></div>
<div class="line">  <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="p4est__connectivity_8h.html#a2c4786e65053166a16b7afb2711d35cb">P4EST_DIM</a>; ++j) {</div>
<div class="line">    d = 0.;</div>
<div class="line">    <span class="comment">/* distance is always computed in 3D space */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; 3; ++i) {</div>
<div class="line">      diff[i] = planet_xyz[j][i] - xv[i];</div>
<div class="line">      d += SC_SQR (diff[i]);</div>
<div class="line">    }</div>
<div class="line">    d = planet_mass[j] * pow (d, -1.5);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="p4est__connectivity_8h.html#a2c4786e65053166a16b7afb2711d35cb">P4EST_DIM</a>; ++i) {</div>
<div class="line">      rk[3 + i] += d * diff[i];</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">rkstage (part_global_t * g, pa_data_t * pad, <span class="keywordtype">double</span> h)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">int</span>           stage = g-&gt;stage;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">int</span>           order = g-&gt;order;</div>
<div class="line">  <span class="keywordtype">int</span>                 i;</div>
<div class="line">  <span class="keywordtype">double</span>              d;</div>
<div class="line">  <span class="keywordtype">double</span>              rk[6];</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* evaluate right hand side */</span></div>
<div class="line">  rkrhs (g, stage == 0 ? pad-&gt;xv : pad-&gt;wo, rk);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* compute new evaluation point if necessary */</span></div>
<div class="line">  <span class="keywordflow">if</span> (stage + 1 &lt; order) {</div>
<div class="line">    <span class="comment">/* stage is not the last */</span></div>
<div class="line">    d = h * prk[order - 1][0][stage];</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; 6; ++i) {</div>
<div class="line">      pad-&gt;wo[i] = pad-&gt;xv[i] + d * rk[i];</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* compute an update to the state */</span></div>
<div class="line">  d = prk[order - 1][1][stage];</div>
<div class="line">  <span class="keywordflow">if</span> (stage == 0) {</div>
<div class="line">    <span class="comment">/* first stage */</span></div>
<div class="line">    <span class="keywordflow">if</span> (order &gt; 1) {</div>
<div class="line">      <span class="comment">/* first stage is not the last */</span></div>
<div class="line">      P4EST_ASSERT (stage + 1 &lt; order);</div>
<div class="line">      <span class="keywordflow">for</span> (i = 0; i &lt; 6; ++i) {</div>
<div class="line">        pad-&gt;up[i] = d * rk[i];</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">      <span class="comment">/* first stage is also the last */</span></div>
<div class="line">      P4EST_ASSERT (stage + 1 == order);</div>
<div class="line">      <span class="keywordflow">for</span> (i = 0; i &lt; 6; ++i) {</div>
<div class="line">        pad-&gt;xv[i] += h * d * rk[i];</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">/* stage is not the first */</span></div>
<div class="line">    <span class="keywordflow">if</span> (stage + 1 &lt; order) {</div>
<div class="line">      <span class="comment">/* stage is neither first nor last */</span></div>
<div class="line">      P4EST_ASSERT (0 &lt; stage);</div>
<div class="line">      <span class="keywordflow">for</span> (i = 0; i &lt; 6; ++i) {</div>
<div class="line">        pad-&gt;up[i] += d * rk[i];</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">      <span class="comment">/* stage is last of several */</span></div>
<div class="line">      P4EST_ASSERT (stage + 1 == order);</div>
<div class="line">      <span class="keywordflow">for</span> (i = 0; i &lt; 6; ++i) {</div>
<div class="line">        pad-&gt;xv[i] += h * (pad-&gt;up[i] + d * rk[i]);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">psearch_quad (<a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>, <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree,</div>
<div class="line">              <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quadrant, <span class="keywordtype">int</span> pfirst, <span class="keywordtype">int</span> plast,</div>
<div class="line">              <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> local_num, <span class="keywordtype">void</span> *point)</div>
<div class="line">{</div>
<div class="line">  part_global_t      *g = (part_global_t *) <a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">user_pointer</a>;</div>
<div class="line">#ifdef P4EST_ENABLE_DEBUG</div>
<div class="line">  qu_data_t          *qud;</div>
<div class="line"> </div>
<div class="line">  if (local_num &gt;= 0) {</div>
<div class="line">    <span class="comment">/* quadrant is a local leaf */</span></div>
<div class="line">    qud = (qu_data_t *) quadrant-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">    P4EST_ASSERT (qud-&gt;premain == 0);</div>
<div class="line">    P4EST_ASSERT (qud-&gt;preceive == 0);</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* compute coordinate range of this quadrant */</span></div>
<div class="line">  loopquad (g, which_tree, quadrant, g-&gt;lxyz, g-&gt;hxyz, g-&gt;dxyz);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* always return 1 to search particles individually */</span></div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">double</span>      *</div>
<div class="line">particle_lookfor (part_global_t * g, pa_data_t * pad)</div>
<div class="line">{</div>
<div class="line">  P4EST_ASSERT (0 &lt;= g-&gt;stage &amp;&amp; g-&gt;stage &lt; g-&gt;order);</div>
<div class="line">  P4EST_ASSERT (pad != NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> g-&gt;stage + 1 &lt; g-&gt;order ? pad-&gt;wo : pad-&gt;xv;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">psearch_point (<a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>, <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree,</div>
<div class="line">               <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quadrant, <span class="keywordtype">int</span> pfirst, <span class="keywordtype">int</span> plast,</div>
<div class="line">               <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> local_num, <span class="keywordtype">void</span> *point)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 i;</div>
<div class="line">  <span class="keywordtype">int</span>                *pfn;</div>
<div class="line">  <span class="keywordtype">size_t</span>              zp;</div>
<div class="line">  <span class="keywordtype">double</span>             *x;</div>
<div class="line">  part_global_t      *g = (part_global_t *) <a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">user_pointer</a>;</div>
<div class="line">  qu_data_t          *qud;</div>
<div class="line">  pa_data_t          *pad = (pa_data_t *) point;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* access location of particle to be searched */</span></div>
<div class="line">  x = particle_lookfor (g, pad);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* due to roundoff we call this even for a local leaf */</span></div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="p4est__connectivity_8h.html#a2c4786e65053166a16b7afb2711d35cb">P4EST_DIM</a>; ++i) {</div>
<div class="line">    <span class="keywordflow">if</span> (!(g-&gt;lxyz[i] &lt;= x[i] &amp;&amp; x[i] &lt;= g-&gt;hxyz[i])) {</div>
<div class="line">      <span class="comment">/* the point is outside the search quadrant */</span></div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* convention for entries of pfound:</span></div>
<div class="line"><span class="comment">     -1              particle has not yet been found</span></div>
<div class="line"><span class="comment">     [0 .. mpisize)  particle found on that rank, me or other</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* find process/quadrant for this particle */</span></div>
<div class="line">  <span class="keywordflow">if</span> (local_num &gt;= 0) {</div>
<div class="line">    <span class="comment">/* quadrant is a local leaf */</span></div>
<div class="line">    P4EST_ASSERT (pfirst == g-&gt;mpirank &amp;&amp; plast == g-&gt;mpirank);</div>
<div class="line">    zp = sc_array_position (g-&gt;padata, point);</div>
<div class="line">    pfn = (<span class="keywordtype">int</span> *) sc_array_index (g-&gt;pfound, zp);</div>
<div class="line">    <span class="comment">/* first local match counts (due to roundoff there may be multiple) */</span></div>
<div class="line">    <span class="keywordflow">if</span> (*pfn != g-&gt;mpirank) {</div>
<div class="line">      <span class="comment">/* particle was either yet unfound, or found on another process */</span></div>
<div class="line">      <span class="comment">/* bump counter of particles in this local quadrant */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line">      <span class="comment">/* HACK */</span></div>
<div class="line">      <span class="keywordflow">if</span> (g-&gt;printn &gt; 0 &amp;&amp; !(pad-&gt;id % g-&gt;printn)) {</div>
<div class="line">        pad = (pa_data_t *) point;</div>
<div class="line">        P4EST_VERBOSEF (<span class="stringliteral">&quot;Locremain particle %lld %d\n&quot;</span>,</div>
<div class="line">                        (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) pad-&gt;id, (<span class="keywordtype">int</span>) zp);</div>
<div class="line">      }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">      *pfn = g-&gt;mpirank;</div>
<div class="line">      *(<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> *) sc_array_push (g-&gt;iremain) = (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) zp;</div>
<div class="line">      qud = (qu_data_t *) quadrant-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">      ++qud-&gt;premain;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* return value will have no effect, but we must return */</span></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (pfirst == plast) {</div>
<div class="line">    <span class="keywordflow">if</span> (pfirst == g-&gt;mpirank) {</div>
<div class="line">      <span class="comment">/* continue recursion for local branch quadrant */</span></div>
<div class="line">      P4EST_ASSERT (plast == g-&gt;mpirank);</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* found particle on a remote process */</span></div>
<div class="line">    P4EST_ASSERT (plast != g-&gt;mpirank);</div>
<div class="line">    zp = sc_array_position (g-&gt;padata, point);</div>
<div class="line">    pfn = (<span class="keywordtype">int</span> *) sc_array_index (g-&gt;pfound, zp);</div>
<div class="line">    <span class="comment">/* only count match if it has not been found locally or on lower rank */</span></div>
<div class="line">    <span class="keywordflow">if</span> (*pfn &lt; 0 || (*pfn != g-&gt;mpirank &amp;&amp; pfirst &lt; *pfn)) {</div>
<div class="line">      *pfn = pfirst;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* return value will have no effect, but we must return */</span></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* the process for this particle has not yet been found */</span></div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">presearch (part_global_t * g)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">double</span>              t0_searchp, t1;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g-&gt;padata != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;pfound == NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;iremain == NULL);</div>
<div class="line"> </div>
<div class="line">  g-&gt;pfound = sc_array_new_count (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>), g-&gt;padata-&gt;elem_count);</div>
<div class="line">  sc_array_memset (g-&gt;pfound, -1);</div>
<div class="line"> </div>
<div class="line">  g-&gt;iremain = sc_array_new (<span class="keyword">sizeof</span> (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t0_searchp = sc_MPI_Wtime ();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* search through partition for parallel branch boundaries */</span></div>
<div class="line">  <a name="a22"></a><a class="code" href="p4est__search_8h.html#a877607ea5e4b91e4272bce17cadca43e">p4est_search_all</a> (g-&gt;p4est, 0, psearch_quad, psearch_point, g-&gt;padata);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t1 = sc_MPI_Wtime ();</div>
<div class="line">  <span class="keywordflow">if</span> (!g-&gt;scaling || g-&gt;verylast) {</div>
<div class="line">    sc_stats_accumulate (g-&gt;si + PART_STATS_SEARCHP, t1 - t0_searchp);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span></div>
<div class="line">psend_hash (<span class="keyword">const</span> <span class="keywordtype">void</span> *v, <span class="keyword">const</span> <span class="keywordtype">void</span> *u)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> comm_psend_t *ps = (<span class="keyword">const</span> comm_psend_t *) v;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (u == NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> ps-&gt;rank;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">psend_equal (<span class="keyword">const</span> <span class="keywordtype">void</span> *v1, <span class="keyword">const</span> <span class="keywordtype">void</span> *v2, <span class="keyword">const</span> <span class="keywordtype">void</span> *u)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> comm_psend_t *ps1 = (<span class="keyword">const</span> comm_psend_t *) v1;</div>
<div class="line">  <span class="keyword">const</span> comm_psend_t *ps2 = (<span class="keyword">const</span> comm_psend_t *) v2;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (u == NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> ps1-&gt;rank == ps2-&gt;rank;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">pack (part_global_t * g)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 mpiret;</div>
<div class="line">  <span class="keywordtype">int</span>                 retval;</div>
<div class="line">  <span class="keywordtype">int</span>                *pfn;</div>
<div class="line">  <span class="keywordtype">size_t</span>              zz, numz;</div>
<div class="line">  <span class="keywordtype">void</span>              **hfound;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      lremain, lsend, llost;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>      loclrs[4], glolrs[4];</div>
<div class="line">  comm_psend_t       *cps, *there;</div>
<div class="line">  comm_prank_t       *trank;</div>
<div class="line"><span class="preprocessor">#ifdef PART_SENDFULL</span></div>
<div class="line">  pa_data_t          *pad;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  <span class="keywordtype">double</span>             *msg;</div>
<div class="line">  <span class="keywordtype">double</span>             *x;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g-&gt;psmem == NULL);</div>
<div class="line">  g-&gt;psmem = sc_mempool_new (<span class="keyword">sizeof</span> (comm_psend_t));</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g-&gt;pfound != NULL);</div>
<div class="line">  numz = g-&gt;pfound-&gt;elem_count;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g-&gt;padata != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;padata-&gt;elem_count == numz);</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g-&gt;psend == NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;recevs == NULL);</div>
<div class="line"> </div>
<div class="line">  g-&gt;psend = sc_hash_new (psend_hash, psend_equal, NULL, NULL);</div>
<div class="line">  g-&gt;recevs = sc_array_new (<span class="keyword">sizeof</span> (comm_prank_t));</div>
<div class="line"> </div>
<div class="line">  lremain = lsend = llost = 0;</div>
<div class="line">  cps = (comm_psend_t *) sc_mempool_alloc (g-&gt;psmem);</div>
<div class="line">  cps-&gt;rank = -1;</div>
<div class="line">  <span class="keywordflow">for</span> (zz = 0; zz &lt; numz; ++zz) {</div>
<div class="line">    pfn = (<span class="keywordtype">int</span> *) sc_array_index (g-&gt;pfound, zz);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* ignore those that leave the domain or stay local */</span></div>
<div class="line">    <span class="keywordflow">if</span> (*pfn &lt; 0) {</div>
<div class="line">      P4EST_ASSERT (*pfn == -1);</div>
<div class="line">      ++llost;</div>
<div class="line">      <span class="keywordflow">continue</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (*pfn == g-&gt;mpirank) {</div>
<div class="line">      ++lremain;</div>
<div class="line">      <span class="keywordflow">continue</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* access message structure */</span></div>
<div class="line">    P4EST_ASSERT (0 &lt;= *pfn &amp;&amp; *pfn &lt; g-&gt;mpisize);</div>
<div class="line">    cps-&gt;rank = *pfn;</div>
<div class="line">    P4EST_ASSERT (cps-&gt;rank != g-&gt;mpirank);</div>
<div class="line">    retval = sc_hash_insert_unique (g-&gt;psend, cps, &amp;hfound);</div>
<div class="line">    P4EST_ASSERT (hfound != NULL);</div>
<div class="line">    there = *((comm_psend_t **) hfound);</div>
<div class="line">    <span class="keywordflow">if</span> (!retval) {</div>
<div class="line">      <span class="comment">/* message for this rank exists already */</span></div>
<div class="line">      P4EST_ASSERT (there-&gt;message.elem_size == PART_MSGSIZE);</div>
<div class="line">      P4EST_ASSERT (there-&gt;message.elem_count &gt; 0);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">      <span class="comment">/* message is added for this rank */</span></div>
<div class="line">      P4EST_ASSERT (there == cps);</div>
<div class="line">      trank = (comm_prank_t *) sc_array_push (g-&gt;recevs);</div>
<div class="line">      trank-&gt;rank = there-&gt;rank;</div>
<div class="line">      trank-&gt;psend = there;</div>
<div class="line">      sc_array_init (&amp;there-&gt;message, PART_MSGSIZE);</div>
<div class="line">      cps = (comm_psend_t *) sc_mempool_alloc (g-&gt;psmem);</div>
<div class="line">      cps-&gt;rank = -1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* add to message buffer */</span></div>
<div class="line"><span class="preprocessor">#ifdef PART_SENDFULL</span></div>
<div class="line">    pad = (pa_data_t *) sc_array_push (&amp;there-&gt;message);</div>
<div class="line">    memcpy (pad, sc_array_index (g-&gt;padata, zz), sizeof (pa_data_t));</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    msg = (<span class="keywordtype">double</span> *) sc_array_push (&amp;there-&gt;message);</div>
<div class="line">    x = particle_lookfor (g, (pa_data_t *) sc_array_index (g-&gt;padata, zz));</div>
<div class="line">    memcpy (msg, x, 3 * <span class="keyword">sizeof</span> (<span class="keywordtype">double</span>));</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* this particle is to be sent to another process */</span></div>
<div class="line">    ++lsend;</div>
<div class="line">  }</div>
<div class="line">  sc_mempool_free (g-&gt;psmem, cps);</div>
<div class="line">  sc_array_sort (g-&gt;recevs, comm_prank_compare);</div>
<div class="line">  <span class="comment">/* TODO: hash table still needed?  Yes, unless we rearrange data sent */</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* keep track of some global numbers */</span></div>
<div class="line">  loclrs[0] = (<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>) lremain;</div>
<div class="line">  loclrs[1] = (<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>) lsend;</div>
<div class="line">  loclrs[2] = (<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>) llost;</div>
<div class="line">  loclrs[3] = (<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>) g-&gt;recevs-&gt;elem_count;</div>
<div class="line">  mpiret = sc_MPI_Allreduce (loclrs, glolrs, 4, P4EST_MPI_GLOIDX,</div>
<div class="line">                             sc_MPI_SUM, g-&gt;mpicomm);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line">  P4EST_GLOBAL_STATISTICSF</div>
<div class="line">    (<span class="stringliteral">&quot;Stage %d from %lld remain %lld sent %lld lost %lld avg peers %.3g\n&quot;</span>,</div>
<div class="line">     g-&gt;stage, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) g-&gt;gpnum, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) glolrs[0],</div>
<div class="line">     (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) glolrs[1], (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) glolrs[2],</div>
<div class="line">     glolrs[3] / (<span class="keywordtype">double</span>) g-&gt;mpisize);</div>
<div class="line">  P4EST_ASSERT (glolrs[0] + glolrs[1] + glolrs[2] == g-&gt;gpnum);</div>
<div class="line">  g-&gt;gplost += glolrs[2];</div>
<div class="line">  g-&gt;gpnum -= glolrs[2];</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* count number of peers as statistics */</span></div>
<div class="line">  <span class="keywordflow">if</span> (!g-&gt;scaling || g-&gt;verylast) {</div>
<div class="line">    sc_stats_accumulate (g-&gt;si + PART_STATS_PEERS, (<span class="keywordtype">double</span>) loclrs[3]);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* another array that is no longer needed */</span></div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;pfound);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">comm (part_global_t * g)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 mpiret;</div>
<div class="line">  <span class="keywordtype">int</span>                 i;</div>
<div class="line">  <span class="keywordtype">int</span>                 num_receivers;</div>
<div class="line">  <span class="keywordtype">int</span>                 num_senders;</div>
<div class="line">  <span class="keywordtype">int</span>                 count, cucount;</div>
<div class="line">  <span class="keywordtype">int</span>                 msglen;</div>
<div class="line">  <span class="keywordtype">double</span>              t0_notify, t0_wait1, t0_comm, t1;</div>
<div class="line">  sc_MPI_Request     *reqs;</div>
<div class="line">  sc_array_t         *notif, *payl;</div>
<div class="line">  sc_array_t         *arr;</div>
<div class="line">  comm_psend_t       *cps;</div>
<div class="line">  comm_prank_t       *trank;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g-&gt;psmem != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;recevs != NULL);</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g-&gt;prebuf == NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;recv_req == NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;send_req == NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t0_comm = sc_MPI_Wtime ();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* pass receiver ranks and message size to notify */</span></div>
<div class="line">  num_receivers = (int) g-&gt;recevs-&gt;elem_count;</div>
<div class="line">  P4EST_ASSERT (0 &lt;= num_receivers &amp;&amp; num_receivers &lt; g-&gt;mpisize);</div>
<div class="line">  notif = sc_array_new_count (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>), num_receivers);</div>
<div class="line">  payl = sc_array_new_count (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>), num_receivers);</div>
<div class="line">  <span class="keywordflow">if</span> (g-&gt;olap_notify) {</div>
<div class="line">    P4EST_ASSERT (g-&gt;send_req == NULL);</div>
<div class="line">    g-&gt;send_req = sc_array_new_count (<span class="keyword">sizeof</span> (sc_MPI_Request), num_receivers);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; num_receivers; ++i) {</div>
<div class="line">    trank = (comm_prank_t *) sc_array_index_int (g-&gt;recevs, i);</div>
<div class="line">    *(<span class="keywordtype">int</span> *) sc_array_index_int (notif, i) = trank-&gt;rank;</div>
<div class="line">    cps = trank-&gt;psend;</div>
<div class="line">    P4EST_ASSERT (trank-&gt;rank == cps-&gt;rank);</div>
<div class="line">    arr = &amp;cps-&gt;message;</div>
<div class="line">    P4EST_ASSERT (arr-&gt;elem_size == PART_MSGSIZE);</div>
<div class="line">    P4EST_ASSERT (arr-&gt;elem_count &gt; 0);</div>
<div class="line">    *(<span class="keywordtype">int</span> *) sc_array_index_int (payl, i) = (int) arr-&gt;elem_count;</div>
<div class="line">    if (g-&gt;olap_notify) {</div>
<div class="line">      msglen = (int) (arr-&gt;elem_count * arr-&gt;elem_size);</div>
<div class="line">      mpiret = sc_MPI_Isend</div>
<div class="line">        (arr-&gt;array, msglen, sc_MPI_BYTE, cps-&gt;rank, COMM_TAG_PART,</div>
<div class="line">         g-&gt;mpicomm, (sc_MPI_Request *) sc_array_index_int (g-&gt;send_req, i));</div>
<div class="line">      SC_CHECK_MPI (mpiret);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t0_notify = sc_MPI_Wtime ();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* reverse communication pattern */</span></div>
<div class="line">  sc_notify_ext (notif, NULL, payl, NULL, g-&gt;mpicomm);</div>
<div class="line">  P4EST_ASSERT (payl-&gt;elem_count == notif-&gt;elem_count);</div>
<div class="line">  num_senders = (int) notif-&gt;elem_count;</div>
<div class="line">  P4EST_ASSERT (0 &lt;= num_senders &amp;&amp; num_senders &lt; g-&gt;mpisize);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t1 = sc_MPI_Wtime ();</div>
<div class="line">  <span class="keywordflow">if</span> (!g-&gt;scaling || g-&gt;verylast) {</div>
<div class="line">    sc_stats_accumulate (g-&gt;si + PART_STATS_NOTIFY, t1 - t0_notify);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* receive particles into a flat array over all processes */</span></div>
<div class="line">  cucount = 0;</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; num_senders; ++i) {</div>
<div class="line">    cucount += *(<span class="keywordtype">int</span> *) sc_array_index_int (payl, i);</div>
<div class="line">  }</div>
<div class="line">  g-&gt;prebuf = sc_array_new_count (PART_MSGSIZE, cucount);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* post non-blocking receive */</span></div>
<div class="line">  g-&gt;recv_req = sc_array_new_count (<span class="keyword">sizeof</span> (sc_MPI_Request), num_senders);</div>
<div class="line">  cucount = 0;</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; num_senders; ++i) {</div>
<div class="line">    count = *(<span class="keywordtype">int</span> *) sc_array_index_int (payl, i);</div>
<div class="line">    msglen = count * (int) PART_MSGSIZE;</div>
<div class="line">    mpiret = sc_MPI_Irecv</div>
<div class="line">      (sc_array_index (g-&gt;prebuf, cucount), msglen, sc_MPI_BYTE,</div>
<div class="line">       *(<span class="keywordtype">int</span> *) sc_array_index_int (notif, i), COMM_TAG_PART, g-&gt;mpicomm,</div>
<div class="line">       (sc_MPI_Request *) sc_array_index_int (g-&gt;recv_req, i));</div>
<div class="line">    SC_CHECK_MPI (mpiret);</div>
<div class="line">    cucount += count;</div>
<div class="line">  }</div>
<div class="line">  P4EST_ASSERT (cucount == (<span class="keywordtype">int</span>) g-&gt;prebuf-&gt;elem_count);</div>
<div class="line">  sc_array_destroy_null (&amp;notif);</div>
<div class="line">  sc_array_destroy_null (&amp;payl);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* post non-blocking send if not done earlier */</span></div>
<div class="line">  <span class="keywordflow">if</span> (!g-&gt;olap_notify) {</div>
<div class="line">    P4EST_ASSERT (g-&gt;send_req == NULL);</div>
<div class="line">    g-&gt;send_req = sc_array_new_count (<span class="keyword">sizeof</span> (sc_MPI_Request), num_receivers);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; num_receivers; ++i) {</div>
<div class="line">      trank = (comm_prank_t *) sc_array_index_int (g-&gt;recevs, i);</div>
<div class="line">      cps = trank-&gt;psend;</div>
<div class="line">      P4EST_ASSERT (trank-&gt;rank == cps-&gt;rank);</div>
<div class="line">      arr = &amp;cps-&gt;message;</div>
<div class="line">      P4EST_ASSERT (arr-&gt;elem_size == PART_MSGSIZE);</div>
<div class="line">      P4EST_ASSERT (arr-&gt;elem_count &gt; 0);</div>
<div class="line">      msglen = (int) (arr-&gt;elem_count * arr-&gt;elem_size);</div>
<div class="line">      mpiret = sc_MPI_Isend</div>
<div class="line">        (arr-&gt;array, msglen, sc_MPI_BYTE, cps-&gt;rank, COMM_TAG_PART,</div>
<div class="line">         g-&gt;mpicomm, (sc_MPI_Request *) sc_array_index_int (g-&gt;send_req, i));</div>
<div class="line">      SC_CHECK_MPI (mpiret);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t0_wait1 = sc_MPI_Wtime ();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* wait for all incoming messages to complete */</span></div>
<div class="line">  reqs = (sc_MPI_Request *) sc_array_index_begin (g-&gt;recv_req);</div>
<div class="line">  mpiret = sc_MPI_Waitall (num_senders, reqs, sc_MPI_STATUSES_IGNORE);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;recv_req);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t1 = sc_MPI_Wtime ();</div>
<div class="line">  <span class="keywordflow">if</span> (!g-&gt;scaling || g-&gt;verylast) {</div>
<div class="line">    sc_stats_accumulate (g-&gt;si + PART_STATS_WAIT1, t1 - t0_wait1);</div>
<div class="line">    sc_stats_accumulate (g-&gt;si + PART_STATS_COMM, t1 - t0_comm);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">slocal_quad (<a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>, <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree,</div>
<div class="line">             <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quadrant, <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> local_num,</div>
<div class="line">             <span class="keywordtype">void</span> *point)</div>
<div class="line">{</div>
<div class="line">  part_global_t      *g = (part_global_t *) <a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">user_pointer</a>;</div>
<div class="line">#ifdef P4EST_ENABLE_DEBUG</div>
<div class="line">  qu_data_t          *qud;</div>
<div class="line"> </div>
<div class="line">  if (local_num &gt;= 0) {</div>
<div class="line">    qud = (qu_data_t *) quadrant-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">    P4EST_ASSERT (qud-&gt;preceive == 0);</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* compute coordinate range of this quadrant */</span></div>
<div class="line">  loopquad (g, which_tree, quadrant, g-&gt;lxyz, g-&gt;hxyz, g-&gt;dxyz);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* always return 1 to search particles individually */</span></div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">slocal_point (<a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>, <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree,</div>
<div class="line">              <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quadrant, <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> local_num,</div>
<div class="line">              <span class="keywordtype">void</span> *point)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 i;</div>
<div class="line">  <span class="keywordtype">char</span>               *cf;</div>
<div class="line">  <span class="keywordtype">size_t</span>              zp;</div>
<div class="line">  part_global_t      *g = (part_global_t *) <a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">user_pointer</a>;</div>
<div class="line">  qu_data_t          *qud;</div>
<div class="line">#ifdef PART_SENDFULL</div>
<div class="line">  <span class="keywordtype">double</span>             *x;</div>
<div class="line">  pa_data_t          *pad = (pa_data_t *) point;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* access location of particle to be searched */</span></div>
<div class="line">  x = particle_lookfor (g, pad);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  <span class="keywordtype">double</span>             *x = (<span class="keywordtype">double</span> *) point;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* due to roundoff we call this even for a local leaf */</span></div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="p4est__connectivity_8h.html#a2c4786e65053166a16b7afb2711d35cb">P4EST_DIM</a>; ++i) {</div>
<div class="line">    <span class="keywordflow">if</span> (!(g-&gt;lxyz[i] &lt;= x[i] &amp;&amp; x[i] &lt;= g-&gt;hxyz[i])) {</div>
<div class="line">      <span class="comment">/* the point is outside the search quadrant */</span></div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (local_num &gt;= 0) {</div>
<div class="line">    <span class="comment">/* quadrant is a local leaf */</span></div>
<div class="line">    <span class="comment">/* first local match counts (due to roundoff there may be multiple) */</span></div>
<div class="line">    zp = sc_array_position (g-&gt;prebuf, point);</div>
<div class="line">    cf = (<span class="keywordtype">char</span> *) sc_array_index (g-&gt;cfound, zp);</div>
<div class="line">    <span class="keywordflow">if</span> (!*cf) {</div>
<div class="line">      <span class="comment">/* make sure this particle is not found twice */</span></div>
<div class="line">      *cf = 1;</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* count this particle in its target quadrant */</span></div>
<div class="line">      *(<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> *) sc_array_push (g-&gt;ireceive) = (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) zp;</div>
<div class="line">      qud = (qu_data_t *) quadrant-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">      ++qud-&gt;preceive;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* return value will have no effect */</span></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* the leaf for this particle has not yet been found */</span></div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">postsearch (part_global_t * g)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">double</span>              t0_searchl, t1;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g-&gt;ireceive == NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;cfound == NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;prebuf != NULL);</div>
<div class="line"> </div>
<div class="line">  g-&gt;ireceive = sc_array_new (<span class="keyword">sizeof</span> (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>));</div>
<div class="line">  g-&gt;cfound = sc_array_new_count (<span class="keyword">sizeof</span> (<span class="keywordtype">char</span>), g-&gt;prebuf-&gt;elem_count);</div>
<div class="line">  sc_array_memset (g-&gt;cfound, 0);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t0_searchl = sc_MPI_Wtime ();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* run local search to find particles sent to us */</span></div>
<div class="line">  <a name="a23"></a><a class="code" href="p4est__search_8h.html#a08966f233b715e731217a2c2d288bbeb">p4est_search_local</a> (g-&gt;p4est, 0, slocal_quad, slocal_point, g-&gt;prebuf);</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;cfound);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t1 = sc_MPI_Wtime ();</div>
<div class="line">  <span class="keywordflow">if</span> (!g-&gt;scaling || g-&gt;verylast) {</div>
<div class="line">    sc_stats_accumulate (g-&gt;si + PART_STATS_SEARCHL, t1 - t0_searchl);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">adapt_coarsen (<a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>, <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree,</div>
<div class="line">               <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quadrants[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 i;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      remain, receive;</div>
<div class="line">  qu_data_t          *qud;</div>
<div class="line">  part_global_t      *g = (part_global_t *) <a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">user_pointer</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* TODO: coarsen/refine on sum of still-there and to-be-there particles? */</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* maybe this quadrant is just called for counting, or too big already */</span></div>
<div class="line">  if (quadrants[1] == NULL ||</div>
<div class="line">      quadrants[0]-&gt;level == g-&gt;minlevel - g-&gt;bricklev) {</div>
<div class="line">    qud = (qu_data_t *) quadrants[0]-&gt;p.user_data;</div>
<div class="line">#ifdef P4EST_ENABLE_DEBUG</div>
<div class="line">    qud-&gt;u.lpend = -1;</div>
<div class="line">#endif</div>
<div class="line">    g-&gt;ireindex += qud-&gt;premain;</div>
<div class="line">    g-&gt;irvindex += qud-&gt;preceive;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* sum expected particle count over siblings */</span></div>
<div class="line">  remain = receive = 0;</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; <a name="a24"></a><a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a>; ++i) {</div>
<div class="line">    qud = (qu_data_t *) quadrants[i]-&gt;p.user_data;</div>
<div class="line">#ifdef P4EST_ENABLE_DEBUG</div>
<div class="line">    qud-&gt;u.lpend = -1;</div>
<div class="line">#endif</div>
<div class="line">    remain += qud-&gt;premain;</div>
<div class="line">    receive += qud-&gt;preceive;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> ((<span class="keywordtype">double</span>) (remain + receive) &lt; .5 * g-&gt;elem_particles) {</div>
<div class="line">    <span class="comment">/* we will coarsen and adjust ireindex, irvindex in adapt_replace */</span></div>
<div class="line">    g-&gt;qremain = remain;</div>
<div class="line">    g-&gt;qreceive = receive;</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">/* we will not coarsen and proceed with next quadrant */</span></div>
<div class="line">    qud = (qu_data_t *) quadrants[0]-&gt;p.user_data;</div>
<div class="line">    g-&gt;ireindex += qud-&gt;premain;</div>
<div class="line">    g-&gt;irvindex += qud-&gt;preceive;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">adapt_refine (<a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>, <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree,</div>
<div class="line">              <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quadrant)</div>
<div class="line">{</div>
<div class="line">  qu_data_t          *qud = (qu_data_t *) quadrant-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">  part_global_t      *g = (part_global_t *) <a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">user_pointer</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* we have set this to -1 in adapt_coarsen */</span></div>
<div class="line">  P4EST_ASSERT (qud-&gt;u.lpend == -1);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> ((<span class="keywordtype">double</span>) (qud-&gt;premain + qud-&gt;preceive) &gt; g-&gt;elem_particles) {</div>
<div class="line">    <span class="comment">/* we are trying to refine, we will possibly go into the replace function */</span></div>
<div class="line">    g-&gt;ire2 = g-&gt;ireindex;</div>
<div class="line">    g-&gt;ireindex += qud-&gt;premain;</div>
<div class="line">    g-&gt;irv2 = g-&gt;irvindex;</div>
<div class="line">    g-&gt;irvindex += qud-&gt;preceive;</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">/* maintain cumulative particle count for next quadrant */</span></div>
<div class="line">    g-&gt;ireindex += qud-&gt;premain;</div>
<div class="line">    g-&gt;irvindex += qud-&gt;preceive;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> pa_mode</div>
<div class="line">{</div>
<div class="line">  PA_MODE_REMAIN,</div>
<div class="line">  PA_MODE_RECEIVE,</div>
<div class="line">  PA_MODE_LOCATE</div>
<div class="line">}</div>
<div class="line">pa_mode_t;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">split_by_coord (part_global_t * g, sc_array_t * in,</div>
<div class="line">                sc_array_t * out[2], pa_mode_t mode, <span class="keywordtype">int</span> component,</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> lxyz[3], <span class="keyword">const</span> <span class="keywordtype">double</span> dxyz[3])</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      ppos;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>       *x;</div>
<div class="line">  <span class="keywordtype">size_t</span>              zz, znum;</div>
<div class="line">  pa_data_t          *pad;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (in != NULL);</div>
<div class="line">  P4EST_ASSERT (in-&gt;elem_size == sizeof (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>));</div>
<div class="line">  P4EST_ASSERT (out != NULL);</div>
<div class="line">  P4EST_ASSERT (out[0] != NULL);</div>
<div class="line">  P4EST_ASSERT (out[0]-&gt;elem_size == <span class="keyword">sizeof</span> (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>));</div>
<div class="line">  sc_array_truncate (out[0]);</div>
<div class="line">  P4EST_ASSERT (out[1] != NULL);</div>
<div class="line">  P4EST_ASSERT (out[1]-&gt;elem_size == <span class="keyword">sizeof</span> (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>));</div>
<div class="line">  sc_array_truncate (out[1]);</div>
<div class="line"> </div>
<div class="line">  znum = in-&gt;elem_count;</div>
<div class="line">  <span class="keywordflow">for</span> (zz = 0; zz &lt; znum; ++zz) {</div>
<div class="line">    ppos = *(<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> *) sc_array_index (in, zz);</div>
<div class="line">    <span class="keywordflow">if</span> (mode == PA_MODE_REMAIN) {</div>
<div class="line">      pad = (pa_data_t *) sc_array_index (g-&gt;padata, ppos);</div>
<div class="line">      x = particle_lookfor (g, pad);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == PA_MODE_RECEIVE) {</div>
<div class="line"><span class="preprocessor">#ifdef PART_SENDFULL</span></div>
<div class="line">      pad = (pa_data_t *) sc_array_index (g-&gt;prebuf, ppos);</div>
<div class="line">      x = particle_lookfor (g, pad);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">      x = (<span class="keyword">const</span> <span class="keywordtype">double</span> *) sc_array_index (g-&gt;prebuf, ppos);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">      P4EST_ASSERT (mode == PA_MODE_LOCATE);</div>
<div class="line">      pad = (pa_data_t *) sc_array_index (g-&gt;padata, ppos);</div>
<div class="line">      x = pad-&gt;xv;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (x[component] &lt;= lxyz[component] + .5 * dxyz[component]) {</div>
<div class="line">      *(<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> *) sc_array_push (out[0]) = ppos;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">      *(<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> *) sc_array_push (out[1]) = ppos;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">adapt_replace (<a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>, <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree,</div>
<div class="line">               <span class="keywordtype">int</span> num_outgoing, <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * outgoing[],</div>
<div class="line">               <span class="keywordtype">int</span> num_incoming, <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * incoming[])</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#ifdef P4EST_ENABLE_DEBUG</span></div>
<div class="line">  <span class="keywordtype">int</span>                 i;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      remain, receive;</div>
<div class="line">  qu_data_t          *qod;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  <span class="keywordtype">int</span>                 wx, wy, wz;</div>
<div class="line">  <span class="keywordtype">double</span>              lxyz[3], hxyz[3], dxyz[3];</div>
<div class="line">  sc_array_t          iview, *arr;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      irem, ibeg;</div>
<div class="line">  <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a>  **pchild;</div>
<div class="line">  qu_data_t          *qud;</div>
<div class="line">  part_global_t      *g = (part_global_t *) <a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">user_pointer</a>;</div>
<div class="line"> </div>
<div class="line">  if (num_outgoing == <a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a>) {</div>
<div class="line">    P4EST_ASSERT (num_incoming == 1);</div>
<div class="line">    <span class="comment">/* we are coarsening */</span></div>
<div class="line">    qud = (qu_data_t *) incoming[0]-&gt;p.user_data;</div>
<div class="line">#ifdef P4EST_ENABLE_DEBUG</div>
<div class="line">    qud-&gt;u.lpend = -1;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* sum counts over siblings */</span></div>
<div class="line">    remain = receive = 0;</div>
<div class="line">    for (i = 0; i &lt; <a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a>; ++i) {</div>
<div class="line">      qod = (qu_data_t *) outgoing[i]-&gt;p.user_data;</div>
<div class="line">      P4EST_ASSERT (qod-&gt;u.lpend == -1);</div>
<div class="line">      remain += qod-&gt;premain;</div>
<div class="line">      receive += qod-&gt;preceive;</div>
<div class="line">    }</div>
<div class="line">    P4EST_ASSERT (remain == g-&gt;qremain);</div>
<div class="line">    P4EST_ASSERT (receive == g-&gt;qreceive);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    g-&gt;ireindex += (qud-&gt;premain = g-&gt;qremain);</div>
<div class="line">    g-&gt;irvindex += (qud-&gt;preceive = g-&gt;qreceive);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> {</div>
<div class="line">    P4EST_ASSERT (num_outgoing == 1);</div>
<div class="line">    P4EST_ASSERT (num_incoming == <a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a>);</div>
<div class="line">    <span class="comment">/* we are refining */</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* access parent quadrant */</span></div>
<div class="line">    loopquad (g, which_tree, outgoing[0], lxyz, hxyz, dxyz);</div>
<div class="line"><span class="preprocessor">#ifdef P4EST_ENABLE_DEBUG</span></div>
<div class="line">    qod = (qu_data_t *) outgoing[0]-&gt;p.user_data;</div>
<div class="line">    P4EST_ASSERT (qod-&gt;u.lpend == -1);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* recover window onto remaining particles for the new family */</span></div>
<div class="line">    ibeg = g-&gt;ire2;</div>
<div class="line">    irem = g-&gt;ireindex - ibeg;</div>
<div class="line">    P4EST_ASSERT (irem &gt;= 0);</div>
<div class="line">    sc_array_init_view (&amp;iview, g-&gt;iremain, ibeg, irem);</div>
<div class="line">    P4EST_ASSERT (qod-&gt;premain == irem);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* sort remaining particles into the children */</span></div>
<div class="line">    pchild = incoming;</div>
<div class="line"><span class="preprocessor">#ifdef P4_TO_P8</span></div>
<div class="line">    split_by_coord (g, &amp;iview, g-&gt;klh, PA_MODE_REMAIN, 2, lxyz, dxyz);</div>
<div class="line">    <span class="keywordflow">for</span> (wz = 0; wz &lt; 2; ++wz) {</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    P4EST_ASSERT (g-&gt;klh[0] == NULL);</div>
<div class="line">    P4EST_ASSERT (g-&gt;klh[1] == NULL);</div>
<div class="line">    g-&gt;klh[0] = &amp;iview;</div>
<div class="line">    wz = 0;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    split_by_coord (g, g-&gt;klh[wz], g-&gt;jlh, PA_MODE_REMAIN, 1, lxyz, dxyz);</div>
<div class="line">    <span class="keywordflow">for</span> (wy = 0; wy &lt; 2; ++wy) {</div>
<div class="line">      split_by_coord (g, g-&gt;jlh[wy], g-&gt;ilh, PA_MODE_REMAIN, 0, lxyz, dxyz);</div>
<div class="line">      <span class="keywordflow">for</span> (wx = 0; wx &lt; 2; ++wx) {</div>
<div class="line">        <span class="comment">/* we have a set of particles for child 4 * wz + 2 * wy + wx */</span></div>
<div class="line">        arr = g-&gt;ilh[wx];</div>
<div class="line">        sc_array_init_view (&amp;iview, g-&gt;iremain, ibeg, arr-&gt;elem_count);</div>
<div class="line">        sc_array_paste (&amp;iview, arr);</div>
<div class="line">        qud = (qu_data_t *) (*pchild++)-&gt;p.user_data;</div>
<div class="line"><span class="preprocessor">#ifdef P4EST_ENABLE_DEBUG</span></div>
<div class="line">        qud-&gt;u.lpend = -1;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">        ibeg += (qud-&gt;premain = (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) arr-&gt;elem_count);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#ifdef P4_TO_P8</span></div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line">    {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    P4EST_ASSERT (ibeg == g-&gt;ireindex);</div>
<div class="line">    P4EST_ASSERT (pchild == incoming + <a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* recover window onto received particles for the new family */</span></div>
<div class="line">    ibeg = g-&gt;irv2;</div>
<div class="line">    irem = g-&gt;irvindex - ibeg;</div>
<div class="line">    P4EST_ASSERT (irem &gt;= 0);</div>
<div class="line">    sc_array_init_view (&amp;iview, g-&gt;ireceive, ibeg, irem);</div>
<div class="line">    P4EST_ASSERT (qod-&gt;preceive == irem);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* sort received particles into the children */</span></div>
<div class="line">    pchild = incoming;</div>
<div class="line"><span class="preprocessor">#ifdef P4_TO_P8</span></div>
<div class="line">    split_by_coord (g, &amp;iview, g-&gt;klh, PA_MODE_RECEIVE, 2, lxyz, dxyz);</div>
<div class="line">    <span class="keywordflow">for</span> (wz = 0; wz &lt; 2; ++wz) {</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    P4EST_ASSERT (g-&gt;klh[0] == &amp;iview);</div>
<div class="line">    P4EST_ASSERT (g-&gt;klh[1] == NULL);</div>
<div class="line">    wz = 0;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    split_by_coord (g, g-&gt;klh[wz], g-&gt;jlh, PA_MODE_RECEIVE, 1, lxyz, dxyz);</div>
<div class="line">    <span class="keywordflow">for</span> (wy = 0; wy &lt; 2; ++wy) {</div>
<div class="line">      split_by_coord (g, g-&gt;jlh[wy], g-&gt;ilh, PA_MODE_RECEIVE, 0, lxyz, dxyz);</div>
<div class="line">      <span class="keywordflow">for</span> (wx = 0; wx &lt; 2; ++wx) {</div>
<div class="line">        <span class="comment">/* we have a set of particles for child 4 * wz + 2 * wy + wx */</span></div>
<div class="line">        arr = g-&gt;ilh[wx];</div>
<div class="line">        sc_array_init_view (&amp;iview, g-&gt;ireceive, ibeg, arr-&gt;elem_count);</div>
<div class="line">        sc_array_paste (&amp;iview, arr);</div>
<div class="line">        qud = (qu_data_t *) (*pchild++)-&gt;p.user_data;</div>
<div class="line">        P4EST_ASSERT (qud-&gt;u.lpend == -1);</div>
<div class="line">        ibeg += (qud-&gt;preceive = (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) arr-&gt;elem_count);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#ifdef P4_TO_P8</span></div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line">    {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    P4EST_ASSERT (ibeg == g-&gt;irvindex);</div>
<div class="line">    P4EST_ASSERT (pchild == incoming + <a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a>);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef P4_TO_P8</span></div>
<div class="line">    g-&gt;klh[0] = NULL;</div>
<div class="line">    P4EST_ASSERT (g-&gt;klh[1] == NULL);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">adapt (part_global_t * g)</div>
<div class="line">{</div>
<div class="line">  P4EST_ASSERT (g-&gt;padata != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;prebuf != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;iremain != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;ireceive != NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* coarsen the forest according to expected number of particles */</span></div>
<div class="line">  g-&gt;ireindex = g-&gt;irvindex = 0;</div>
<div class="line">  <a name="a25"></a><a class="code" href="p4est__extended_8h.html#a06630b99f70cb85c73452640e8b4d54e">p4est_coarsen_ext</a> (g-&gt;p4est, 0, 1, adapt_coarsen, NULL, adapt_replace);</div>
<div class="line">  P4EST_ASSERT ((<span class="keywordtype">size_t</span>) g-&gt;ireindex == g-&gt;iremain-&gt;elem_count);</div>
<div class="line">  P4EST_ASSERT ((<span class="keywordtype">size_t</span>) g-&gt;irvindex == g-&gt;ireceive-&gt;elem_count);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* refine the forest according to expected number of particles */</span></div>
<div class="line">  g-&gt;ireindex = g-&gt;ire2 = 0;</div>
<div class="line">  g-&gt;irvindex = g-&gt;irv2 = 0;</div>
<div class="line">  <a class="code" href="p4est__extended_8h.html#aad32df9df3630b6bac05e7366a5f1e46">p4est_refine_ext</a> (g-&gt;p4est, 0, g-&gt;maxlevel - g-&gt;bricklev,</div>
<div class="line">                    adapt_refine, NULL, adapt_replace);</div>
<div class="line">  P4EST_ASSERT ((<span class="keywordtype">size_t</span>) g-&gt;ireindex == g-&gt;iremain-&gt;elem_count);</div>
<div class="line">  P4EST_ASSERT ((<span class="keywordtype">size_t</span>) g-&gt;irvindex == g-&gt;ireceive-&gt;elem_count);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* TODO: coarsen and refine repeatedly if necessary */</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">regroup (part_global_t * g)</div>
<div class="line">{</div>
<div class="line">  sc_array_t         *newpa;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a>      tt;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      newnum;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      ppos;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      lq, prev;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      qboth, li;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>     *premain, *preceive;</div>
<div class="line">  <a class="code" href="structp4est__tree.html">p4est_tree_t</a>       *tree;</div>
<div class="line">  <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a>   *quad;</div>
<div class="line">  qu_data_t          *qud;</div>
<div class="line">  pa_data_t          *pad;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g-&gt;padata != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;prebuf != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;iremain != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;ireceive != NULL);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef PART_SENDFULL</span></div>
<div class="line"><span class="preprocessor">#error &quot;The following code is no longer compatible with SENDFULL&quot;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  newnum =</div>
<div class="line">    (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) (g-&gt;iremain-&gt;elem_count + g-&gt;ireceive-&gt;elem_count);</div>
<div class="line">  P4EST_VERBOSEF (<span class="stringliteral">&quot;New local particle number %lld\n&quot;</span>, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) newnum);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* regroup remaining and received particles after adaptation */</span></div>
<div class="line">  premain = (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> *) sc_array_index_begin (g-&gt;iremain);</div>
<div class="line">  preceive = (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> *) sc_array_index_begin (g-&gt;ireceive);</div>
<div class="line">  newpa = sc_array_new_count (<span class="keyword">sizeof</span> (pa_data_t), newnum);</div>
<div class="line">  pad = (pa_data_t *) sc_array_index_begin (newpa);</div>
<div class="line">  prev = 0;</div>
<div class="line">  <span class="keywordflow">for</span> (tt = g-&gt;p4est-&gt;first_local_tree; tt &lt;= g-&gt;<a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#abd072c07f3197827fe22c16379de6ab8">last_local_tree</a>; ++tt) {</div>
<div class="line">    tree = p4est_tree_array_index (g-&gt;p4est-&gt;trees, tt);</div>
<div class="line">    <span class="keywordflow">for</span> (lq = 0; lq &lt; (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>.elem_count; ++lq) {</div>
<div class="line">      quad = p4est_quadrant_array_index (&amp;tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>, lq);</div>
<div class="line">      qud = (qu_data_t *) quad-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">      qboth = qud-&gt;premain + qud-&gt;preceive;</div>
<div class="line">      if (qboth == 0) {</div>
<div class="line">        qud-&gt;u.lpend = prev;</div>
<div class="line">        qud-&gt;premain = qud-&gt;preceive = 0;</div>
<div class="line">        <span class="keywordflow">continue</span>;</div>
<div class="line">      }</div>
<div class="line">      prev += qboth;</div>
<div class="line">      P4EST_ASSERT (prev &lt;= newnum);</div>
<div class="line">      <span class="keywordflow">for</span> (li = 0; li &lt; qud-&gt;premain; ++li) {</div>
<div class="line">        P4EST_ASSERT (premain != NULL);</div>
<div class="line">        P4EST_ASSERT</div>
<div class="line">          (premain &lt; (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> *) sc_array_index_end (g-&gt;iremain));</div>
<div class="line">        ppos = *premain++;</div>
<div class="line">        memcpy (pad++, sc_array_index (g-&gt;padata, ppos), sizeof (pa_data_t));</div>
<div class="line"><span class="preprocessor">#ifdef P4EST_ENABLE_DEBUG</span></div>
<div class="line">        --qboth;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">for</span> (li = 0; li &lt; qud-&gt;preceive; ++li) {</div>
<div class="line">        P4EST_ASSERT (preceive != NULL);</div>
<div class="line">        P4EST_ASSERT</div>
<div class="line">          (preceive &lt; (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> *) sc_array_index_end (g-&gt;ireceive));</div>
<div class="line">        ppos = *preceive++;</div>
<div class="line">        memcpy (pad++, sc_array_index (g-&gt;prebuf, ppos), sizeof (pa_data_t));</div>
<div class="line"><span class="preprocessor">#ifdef P4EST_ENABLE_DEBUG</span></div>
<div class="line">        --qboth;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">      }</div>
<div class="line">      P4EST_ASSERT (qboth == 0);</div>
<div class="line">      qud-&gt;u.lpend = prev;</div>
<div class="line">      qud-&gt;premain = qud-&gt;preceive = 0;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  P4EST_ASSERT (prev == newnum);</div>
<div class="line">  P4EST_ASSERT (pad == (pa_data_t *) sc_array_index_end (newpa));</div>
<div class="line">  P4EST_ASSERT</div>
<div class="line">    (premain == (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> *) sc_array_index_end (g-&gt;iremain));</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;iremain);</div>
<div class="line">  P4EST_ASSERT</div>
<div class="line">    (preceive == (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> *) sc_array_index_end (g-&gt;ireceive));</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;ireceive);</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;prebuf);</div>
<div class="line">  sc_array_destroy (g-&gt;padata);</div>
<div class="line">  g-&gt;padata = newpa;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">pprint (part_global_t * g, <span class="keywordtype">double</span> t)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 k;</div>
<div class="line">  <span class="keywordtype">double</span>              d, ds;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      li, lpnum;</div>
<div class="line">  pa_data_t          *pad;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g-&gt;padata != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;stage == 0);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* only output when specified */</span></div>
<div class="line">  <span class="keywordflow">if</span> (g-&gt;printn &lt;= 0) {</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  lpnum = (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) g-&gt;padata-&gt;elem_count;</div>
<div class="line">  pad = (pa_data_t *) sc_array_index_begin (g-&gt;padata);</div>
<div class="line">  <span class="keywordflow">for</span> (li = 0; li &lt; lpnum; ++li) {</div>
<div class="line">    <span class="keywordflow">if</span> (!(pad-&gt;id % g-&gt;printn)) {</div>
<div class="line">      <span class="comment">/* has the particle advanced far enough? */</span></div>
<div class="line">      ds = 0.;</div>
<div class="line">      <span class="keywordflow">for</span> (k = 0; k &lt; <a class="code" href="p4est__connectivity_8h.html#a2c4786e65053166a16b7afb2711d35cb">P4EST_DIM</a>; ++k) {</div>
<div class="line">        d = pad-&gt;xv[k] - pad-&gt;rm[k];</div>
<div class="line">        ds += d * d;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">if</span> (ds &gt;= SC_SQR (.005)) {</div>
<div class="line">        memcpy (pad-&gt;rm, pad-&gt;xv, <a class="code" href="p4est__connectivity_8h.html#a2c4786e65053166a16b7afb2711d35cb">P4EST_DIM</a> * sizeof (<span class="keywordtype">double</span>));</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* print current particle location */</span></div>
<div class="line">        P4EST_ESSENTIALF (<span class="stringliteral">&quot;T %g I %lld X %g %g %g V %g %g %g\n&quot;</span>,</div>
<div class="line">                          t, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) pad-&gt;id,</div>
<div class="line">                          pad-&gt;xv[0], pad-&gt;xv[1], pad-&gt;xv[2],</div>
<div class="line">                          pad-&gt;xv[3], pad-&gt;xv[4], pad-&gt;xv[5]);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    ++pad;</div>
<div class="line">  }</div>
<div class="line">  P4EST_ASSERT (pad == (pa_data_t *) sc_array_index_end (g-&gt;padata));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">waitmpi (part_global_t * g)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 mpiret;</div>
<div class="line">  <span class="keywordtype">int</span>                 i;</div>
<div class="line">  <span class="keywordtype">int</span>                 num_receivers;</div>
<div class="line">  <span class="keywordtype">double</span>              t0_wait2, t1;</div>
<div class="line">  sc_MPI_Request     *reqs;</div>
<div class="line">  comm_psend_t       *cps;</div>
<div class="line">  comm_prank_t       *trank;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g-&gt;recv_req == NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;send_req != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;recevs != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;psend != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;psmem != NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t0_wait2 = sc_MPI_Wtime ();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* wait for sent messages to complete */</span></div>
<div class="line">  num_receivers = (int) g-&gt;recevs-&gt;elem_count;</div>
<div class="line">  reqs = (sc_MPI_Request *) sc_array_index_begin (g-&gt;send_req),</div>
<div class="line">    mpiret = sc_MPI_Waitall (num_receivers, reqs, sc_MPI_STATUSES_IGNORE);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;send_req);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t1 = sc_MPI_Wtime ();</div>
<div class="line">  <span class="keywordflow">if</span> (!g-&gt;scaling || g-&gt;verylast) {</div>
<div class="line">    sc_stats_accumulate (g-&gt;si + PART_STATS_WAIT2, t1 - t0_wait2);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* free send buffer */</span></div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; num_receivers; ++i) {</div>
<div class="line">    trank = (comm_prank_t *) sc_array_index_int (g-&gt;recevs, i);</div>
<div class="line">    cps = trank-&gt;psend;</div>
<div class="line">    P4EST_ASSERT (cps-&gt;rank == trank-&gt;rank);</div>
<div class="line">    P4EST_ASSERT (cps-&gt;message.elem_size == PART_MSGSIZE);</div>
<div class="line">    P4EST_ASSERT (cps-&gt;message.elem_count &gt; 0);</div>
<div class="line">    sc_array_reset (&amp;cps-&gt;message);</div>
<div class="line">  }</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;recevs);</div>
<div class="line">  sc_hash_destroy (g-&gt;psend);</div>
<div class="line">  g-&gt;psend = NULL;</div>
<div class="line">  sc_mempool_destroy (g-&gt;psmem);</div>
<div class="line">  g-&gt;psmem = NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">part_weight (<a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>,</div>
<div class="line">             <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree, <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quadrant)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      ilem_particles;</div>
<div class="line">  part_global_t      *g = (part_global_t *) <a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">user_pointer</a>;</div>
<div class="line">  qu_data_t          *qud = (qu_data_t *) quadrant-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line"> </div>
<div class="line">  ilem_particles = qud-&gt;u.lpend - g-&gt;prevlp;</div>
<div class="line">  g-&gt;prevlp = qud-&gt;u.lpend;</div>
<div class="line"> </div>
<div class="line">  *(<span class="keywordtype">int</span> *) sc_array_index (g-&gt;src_fixed, g-&gt;qcount++) =</div>
<div class="line">    (int) (ilem_particles * <span class="keyword">sizeof</span> (pa_data_t));</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 1 + ilem_particles;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">part (part_global_t * g)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">double</span>              t0_trans1, t1_trans1;</div>
<div class="line">  <span class="keywordtype">double</span>              t0_trans2, t1_trans2;</div>
<div class="line">  sc_array_t         *dest_data;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a>      tt;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      ldatasiz, lcount;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      dest_quads, src_quads;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      dest_parts;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      lquad, lq;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      lpnum;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>      gshipped;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>     *src_gfq;</div>
<div class="line">  <a class="code" href="structp4est__tree.html">p4est_tree_t</a>       *tree;</div>
<div class="line">  <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a>   *quad;</div>
<div class="line">  qu_data_t          *qud;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g-&gt;src_fixed == NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;dest_fixed == NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (g-&gt;mpisize == 1) {</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* remember current forest and its particle counts per quadrant */</span></div>
<div class="line">  src_gfq = <a name="a26"></a><a class="code" href="p4est__base_8h.html#a1fef909873d570158d6ac7b43c7d94f1">P4EST_ALLOC</a> (<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>, g-&gt;mpisize + 1);</div>
<div class="line">  memcpy (src_gfq, g-&gt;p4est-&gt;global_first_quadrant,</div>
<div class="line">          (g-&gt;mpisize + 1) * sizeof (<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>));</div>
<div class="line">  src_quads = g-&gt;p4est-&gt;local_num_quadrants;</div>
<div class="line">  P4EST_ASSERT ((<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>) src_quads ==</div>
<div class="line">                src_gfq[g-&gt;mpirank + 1] - src_gfq[g-&gt;mpirank]);</div>
<div class="line">  g-&gt;src_fixed = sc_array_new_count (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>), src_quads);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* count particles per quadrant in callback */</span></div>
<div class="line">  g-&gt;qcount = 0;</div>
<div class="line">  g-&gt;prevlp = 0;</div>
<div class="line">  gshipped = <a name="a27"></a><a class="code" href="p4est__extended_8h.html#a124f2669c375fa66dc746be591ca2404">p4est_partition_ext</a> (g-&gt;p4est, 1, part_weight);</div>
<div class="line">  P4EST_ASSERT (g-&gt;qcount == src_quads);</div>
<div class="line">  dest_quads = g-&gt;p4est-&gt;local_num_quadrants;</div>
<div class="line">  P4EST_ASSERT (g-&gt;prevlp == (<span class="keywordtype">int</span>) g-&gt;padata-&gt;elem_count);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* if nothing happens, we&#39;re done */</span></div>
<div class="line">  <span class="keywordflow">if</span> (gshipped == 0) {</div>
<div class="line">    sc_array_destroy_null (&amp;g-&gt;src_fixed);</div>
<div class="line">    <a class="code" href="p4est__base_8h.html#a0b2d45f13b66edfed0ccfde75808c745">P4EST_FREE</a> (src_gfq);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t0_trans1 = sc_MPI_Wtime ();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* transfer particle counts per quadrant to new partition */</span></div>
<div class="line">  g-&gt;dest_fixed = sc_array_new_count (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>), dest_quads);</div>
<div class="line">  <a name="a28"></a><a class="code" href="p4est__communication_8h.html#a9a9ef6c16f81067f0c917a838a8fdfac">p4est_transfer_fixed</a> (g-&gt;p4est-&gt;global_first_quadrant, src_gfq,</div>
<div class="line">                        g-&gt;mpicomm, COMM_TAG_FIXED,</div>
<div class="line">                        (<span class="keywordtype">int</span> *) g-&gt;dest_fixed-&gt;array,</div>
<div class="line">                        (<span class="keyword">const</span> <span class="keywordtype">int</span> *) g-&gt;src_fixed-&gt;array, sizeof (<span class="keywordtype">int</span>));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* transfer particle data to new partition */</span></div>
<div class="line">  ldatasiz = (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) <span class="keyword">sizeof</span> (pa_data_t);</div>
<div class="line">  dest_parts = 0;</div>
<div class="line">  <span class="keywordflow">for</span> (lq = 0; lq &lt; dest_quads; ++lq) {</div>
<div class="line">    dest_parts += *(<span class="keywordtype">int</span> *) sc_array_index (g-&gt;dest_fixed, lq);</div>
<div class="line">  }</div>
<div class="line">  P4EST_ASSERT (dest_parts % ldatasiz == 0);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t1_trans1 = t0_trans2 = sc_MPI_Wtime ();</div>
<div class="line"> </div>
<div class="line">  dest_parts /= ldatasiz;</div>
<div class="line">  dest_data = sc_array_new_count (<span class="keyword">sizeof</span> (pa_data_t), dest_parts);</div>
<div class="line">  <a name="a29"></a><a class="code" href="p4est__communication_8h.html#ace044f4c221f25afbb9a198ff24b676a">p4est_transfer_custom</a> (g-&gt;p4est-&gt;global_first_quadrant, src_gfq,</div>
<div class="line">                         g-&gt;mpicomm, COMM_TAG_CUSTOM,</div>
<div class="line">                         (pa_data_t *) dest_data-&gt;array,</div>
<div class="line">                         (<span class="keyword">const</span> <span class="keywordtype">int</span> *) g-&gt;dest_fixed-&gt;array,</div>
<div class="line">                         (<span class="keyword">const</span> pa_data_t *) g-&gt;padata-&gt;array,</div>
<div class="line">                         (<span class="keyword">const</span> <span class="keywordtype">int</span> *) g-&gt;src_fixed-&gt;array);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* clean up and keep new particle data */</span></div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;src_fixed);</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a0b2d45f13b66edfed0ccfde75808c745">P4EST_FREE</a> (src_gfq);</div>
<div class="line">  sc_array_destroy (g-&gt;padata);</div>
<div class="line">  g-&gt;padata = dest_data;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t1_trans2 = sc_MPI_Wtime ();</div>
<div class="line">  <span class="keywordflow">if</span> (!g-&gt;scaling || g-&gt;verylast) {</div>
<div class="line">    sc_stats_accumulate (g-&gt;si + PART_STATS_TRANSF, t1_trans1 - t0_trans1);</div>
<div class="line">    sc_stats_accumulate (g-&gt;si + PART_STATS_TRANSC, t1_trans2 - t0_trans2);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* reassign cumulative particle counts */</span></div>
<div class="line">  lpnum = 0;</div>
<div class="line">  lquad = 0;</div>
<div class="line">  <span class="keywordflow">for</span> (tt = g-&gt;p4est-&gt;first_local_tree; tt &lt;= g-&gt;<a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#abd072c07f3197827fe22c16379de6ab8">last_local_tree</a>; ++tt) {</div>
<div class="line">    tree = p4est_tree_array_index (g-&gt;p4est-&gt;trees, tt);</div>
<div class="line">    <span class="keywordflow">for</span> (lq = 0; lq &lt; (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>.elem_count; ++lq) {</div>
<div class="line">      <span class="comment">/* access quadrant */</span></div>
<div class="line">      quad = p4est_quadrant_array_index (&amp;tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>, lq);</div>
<div class="line">      qud = (qu_data_t *) quad-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">      P4EST_ASSERT (qud-&gt;premain == 0);</div>
<div class="line">      P4EST_ASSERT (qud-&gt;preceive == 0);</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* back out particle count in quadrant from data size */</span></div>
<div class="line">      lcount = *(<span class="keywordtype">int</span> *) sc_array_index (g-&gt;dest_fixed, lquad);</div>
<div class="line">      P4EST_ASSERT (lcount % ldatasiz == 0);</div>
<div class="line">      lcount /= ldatasiz;</div>
<div class="line">      lpnum += lcount;</div>
<div class="line">      qud-&gt;u.lpend = lpnum;</div>
<div class="line">      ++lquad;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  P4EST_ASSERT (lquad == dest_quads);</div>
<div class="line">  P4EST_ASSERT (lpnum == dest_parts);</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;dest_fixed);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">outp (part_global_t * g, <span class="keywordtype">int</span> k)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">char</span>                filename[BUFSIZ];</div>
<div class="line">  sc_array_t         *pdata;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a>      tt;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      lpnum, lq;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      lall, ilem_particles;</div>
<div class="line">  <a class="code" href="structp4est__tree.html">p4est_tree_t</a>       *tree;</div>
<div class="line">  <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a>   *quad;</div>
<div class="line">  qu_data_t          *qud;</div>
<div class="line">  <a class="code" href="p4est__vtk_8h.html#aec7e360e192839f06f58cbfc7afb6d6c">p4est_vtk_context_t</a> *cont;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* only output when specified */</span></div>
<div class="line">  <span class="keywordflow">if</span> (g-&gt;vtk &lt;= 0 || k % g-&gt;vtk) {</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* run-once loop for clean return */</span></div>
<div class="line">  cont = NULL;</div>
<div class="line">  pdata = NULL;</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    <span class="comment">/* open files for output */</span></div>
<div class="line">    snprintf (filename, BUFSIZ, <span class="stringliteral">&quot;%s_%06d&quot;</span>, g-&gt;prefix, k);</div>
<div class="line">    <span class="keywordflow">if</span> (!g-&gt;scaling) {</div>
<div class="line">      cont = <a name="a30"></a><a class="code" href="p4est__vtk_8h.html#a34dbafa8dbc61172ead1a4da4c7103ca">p4est_vtk_context_new</a> (g-&gt;p4est, filename);</div>
<div class="line">      <span class="keywordflow">if</span> (NULL == <a name="a31"></a><a class="code" href="p4est__vtk_8h.html#a17ce523f11f580944630c6c604a070da">p4est_vtk_write_header</a> (cont)) {</div>
<div class="line">        P4EST_LERRORF (<span class="stringliteral">&quot;Failed to write header for %s\n&quot;</span>, filename);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* prepare cell data for output */</span></div>
<div class="line">    pdata = sc_array_new_count</div>
<div class="line">      (<span class="keyword">sizeof</span> (<span class="keywordtype">double</span>), g-&gt;p4est-&gt;local_num_quadrants);</div>
<div class="line">    <span class="keywordflow">for</span> (lpnum = 0, lall = 0, tt = g-&gt;p4est-&gt;first_local_tree;</div>
<div class="line">         tt &lt;= g-&gt;<a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#abd072c07f3197827fe22c16379de6ab8">last_local_tree</a>; ++tt) {</div>
<div class="line">      tree = p4est_tree_array_index (g-&gt;p4est-&gt;trees, tt);</div>
<div class="line">      <span class="keywordflow">for</span> (lq = 0; lq &lt; (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>.elem_count; ++lq) {</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* fetch number of particles in quadrant */</span></div>
<div class="line">        quad = p4est_quadrant_array_index (&amp;tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>, lq);</div>
<div class="line">        qud = (qu_data_t *) quad-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">        ilem_particles = qud-&gt;u.lpend - lpnum;</div>
<div class="line">        *(<span class="keywordtype">double</span> *) sc_array_index (pdata, lall++) = (double) ilem_particles;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* move to next quadrant */</span></div>
<div class="line">        lpnum = qud-&gt;u.lpend;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* write cell data to file */</span></div>
<div class="line">    <span class="keywordflow">if</span> (!g-&gt;scaling) {</div>
<div class="line">      <span class="keywordflow">if</span> (NULL == <a name="a32"></a><a class="code" href="p4est__vtk_8h.html#a7120e8be889eed8a43a781db9f12f00a">p4est_vtk_write_cell_dataf</a></div>
<div class="line">          (cont, 1, 1, 1, g-&gt;mpiwrap, 1, 0, <span class="stringliteral">&quot;particles&quot;</span>, pdata, cont)) {</div>
<div class="line">        P4EST_LERRORF (<span class="stringliteral">&quot;Failed to write cell data for %s\n&quot;</span>, filename);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    sc_array_destroy_null (&amp;pdata);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* finish meta information and close files */</span></div>
<div class="line">    <span class="keywordflow">if</span> (!g-&gt;scaling) {</div>
<div class="line">      <span class="keywordflow">if</span> (<a name="a33"></a><a class="code" href="p4est__vtk_8h.html#a23950ebd8b9b99877fa152752b5150d4">p4est_vtk_write_footer</a> (cont)) {</div>
<div class="line">        P4EST_LERRORF (<span class="stringliteral">&quot;Failed to write footer for %s\n&quot;</span>, filename);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">while</span> (0);</div>
<div class="line">  <span class="keywordflow">if</span> (pdata != NULL) {</div>
<div class="line">    sc_array_destroy_null (&amp;pdata);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>bu_data</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      count;</div>
<div class="line">}</div>
<div class="line">bu_data_t;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">buildp_init_default (<a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>,</div>
<div class="line">                     <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree, <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quadrant)</div>
<div class="line">{</div>
<div class="line">  bu_data_t          *bud = (bu_data_t *) quadrant-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">  bud-&gt;count = 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">buildp_init_add (<a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>,</div>
<div class="line">                 <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree, <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quadrant)</div>
<div class="line">{</div>
<div class="line">  part_global_t      *g = (part_global_t *) <a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">user_pointer</a>;</div>
<div class="line">  bu_data_t          *bud = (bu_data_t *) quadrant-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* tell new quadrant how many particles are in it */</span></div>
<div class="line">  bud-&gt;count = g-&gt;add_count;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>pa_bitem</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a>    quad;</div>
<div class="line">  sc_array_t          parr;</div>
<div class="line">}</div>
<div class="line">pa_bitem_t;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">buildp_add (part_global_t * g, <a class="code" href="p4est__build_8h.html#a29162254418af3724dc93e6f739cc403">p4est_build_t</a> * bcon,</div>
<div class="line">            <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree, pa_bitem_t * bit)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 i;</div>
<div class="line">  <span class="keywordtype">int</span>                 cid, nhits;</div>
<div class="line">  <span class="keywordtype">int</span>                 wx, wy, wz;</div>
<div class="line">  sc_array_t         *arr;</div>
<div class="line">  pa_bitem_t          abita[<a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a>], *bita;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (bcon != NULL);</div>
<div class="line">  P4EST_ASSERT (bit != NULL);</div>
<div class="line">  P4EST_ASSERT (<a name="a34"></a><a class="code" href="p4est__bits_8h.html#a93fdfa19f38d4fca9e42896eda01a558">p4est_quadrant_is_valid</a> (&amp;bit-&gt;quad));</div>
<div class="line">  P4EST_ASSERT (bit-&gt;parr.elem_size == sizeof (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>));</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (bit-&gt;quad.level == g-&gt;maxlevel) {</div>
<div class="line"> </div>
<div class="line"><span class="comment">    /*** we are at maximum level, all particles go into quadrant ***/</span></div>
<div class="line"> </div>
<div class="line">    g-&gt;add_count = (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) bit-&gt;parr.elem_count;</div>
<div class="line">    <a name="a35"></a><a class="code" href="p4est__build_8h.html#ab4211ea70163b7bd5329129ca340a555">p4est_build_add</a> (bcon, which_tree, &amp;bit-&gt;quad);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> {</div>
<div class="line"> </div>
<div class="line"><span class="comment">    /*** search in children and call buildp_add recursively ***/</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* access parent quadrant */</span></div>
<div class="line">    loopquad (g, which_tree, &amp;bit-&gt;quad, g-&gt;lxyz, g-&gt;hxyz, g-&gt;dxyz);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* number of child quadrant */</span></div>
<div class="line">    cid = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* number of child quadrants containing particles */</span></div>
<div class="line">    nhits = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* sort remaining particles into the children */</span></div>
<div class="line"><span class="preprocessor">#ifdef P4_TO_P8</span></div>
<div class="line">    split_by_coord</div>
<div class="line">      (g, &amp;bit-&gt;parr, g-&gt;klh, PA_MODE_LOCATE, 2, g-&gt;lxyz, g-&gt;dxyz);</div>
<div class="line">    <span class="keywordflow">for</span> (wz = 0; wz &lt; 2; ++wz) {</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    P4EST_ASSERT (g-&gt;klh[0] == NULL);</div>
<div class="line">    P4EST_ASSERT (g-&gt;klh[1] == NULL);</div>
<div class="line">    g-&gt;klh[0] = &amp;bit-&gt;parr;</div>
<div class="line">    wz = 0;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    split_by_coord</div>
<div class="line">      (g, g-&gt;klh[wz], g-&gt;jlh, PA_MODE_LOCATE, 1, g-&gt;lxyz, g-&gt;dxyz);</div>
<div class="line">    <span class="keywordflow">for</span> (wy = 0; wy &lt; 2; ++wy) {</div>
<div class="line">      split_by_coord</div>
<div class="line">        (g, g-&gt;jlh[wy], g-&gt;ilh, PA_MODE_LOCATE, 0, g-&gt;lxyz, g-&gt;dxyz);</div>
<div class="line">      <span class="keywordflow">for</span> (wx = 0; wx &lt; 2; ++wx) {</div>
<div class="line">        <span class="comment">/* we have a set of particles for child 4 * wz + 2 * wy + wx */</span></div>
<div class="line">        P4EST_ASSERT (cid == 4 * wz + 2 * wy + wx);</div>
<div class="line">        <span class="keywordflow">if</span> ((arr = g-&gt;ilh[wx])-&gt;elem_count &gt; 0) {</div>
<div class="line"> </div>
<div class="line">          <span class="comment">/* grab next available slot in array */</span></div>
<div class="line">          bita = &amp;abita[nhits++];</div>
<div class="line">          <a name="a36"></a><a class="code" href="p4est__bits_8h.html#ac715371e458c411ee35b69629ceb733f">p4est_quadrant_child</a> (&amp;bit-&gt;quad, &amp;bita-&gt;quad, cid);</div>
<div class="line">          sc_array_init_count (&amp;bita-&gt;parr, sizeof (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>),</div>
<div class="line">                               arr-&gt;elem_count);</div>
<div class="line">          sc_array_paste (&amp;bita-&gt;parr, arr);</div>
<div class="line">        }</div>
<div class="line">        cid++;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#ifdef P4_TO_P8</span></div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line">    {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    P4EST_ASSERT (cid == <a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a>);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef P4_TO_P8</span></div>
<div class="line">    g-&gt;klh[0] = NULL;</div>
<div class="line">    P4EST_ASSERT (g-&gt;klh[1] == NULL);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* go into recursion for non-empty children */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; nhits; ++i) {</div>
<div class="line">      buildp_add (g, bcon, which_tree, &amp;abita[i]);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* this call is expected to clean up the array */</span></div>
<div class="line">  sc_array_reset (&amp;bit-&gt;parr);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">buildp (part_global_t * g, <span class="keywordtype">int</span> k)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">double</span>              t0_build, t0_pertreeF, t0_pertreeB, t1;</div>
<div class="line">  <span class="keywordtype">char</span>                filename[BUFSIZ];</div>
<div class="line">  sc_array_t          inq;</div>
<div class="line">  sc_array_t         *pdata;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a>      tt;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      lpnum, lq;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      lall, ilem_particles, li;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>     *pertree;</div>
<div class="line">  <a class="code" href="structp4est__tree.html">p4est_tree_t</a>       *tree;</div>
<div class="line">  <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a>   *quad;</div>
<div class="line">  <a class="code" href="p4est__build_8h.html#a29162254418af3724dc93e6f739cc403">p4est_build_t</a>      *bcon;</div>
<div class="line">  <a class="code" href="p4est__vtk_8h.html#aec7e360e192839f06f58cbfc7afb6d6c">p4est_vtk_context_t</a> *cont;</div>
<div class="line">  <a class="code" href="structp4est.html">p4est_t</a>            *build;</div>
<div class="line">  qu_data_t          *qud;</div>
<div class="line">  bu_data_t          *bud;</div>
<div class="line">  pa_data_t          *pad;</div>
<div class="line">  pa_bitem_t          abit, *bit = &amp;abit;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g-&gt;padata != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;add_count == 0);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* only output when specified */</span></div>
<div class="line">  <span class="keywordflow">if</span> (g-&gt;scaling &amp;&amp; g-&gt;verylast) {</div>
<div class="line">    <span class="comment">/* output on the last time step */</span></div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;build_part &lt;= 0) {</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">/* so this is the usual way of things: every so many steps */</span></div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;build_part &lt;= 0 || g-&gt;build_step &lt;= 0 || k % g-&gt;build_step) {</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t0_build = sc_MPI_Wtime ();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* iterate through particles to choose the relevant ones for new forest */</span></div>
<div class="line">  bcon = <a name="a37"></a><a class="code" href="p4est__build_8h.html#ade085b723cb557f255ee96efa9bbf68f">p4est_build_new</a> (g-&gt;p4est, sizeof (bu_data_t),</div>
<div class="line">                          buildp_init_default, g);</div>
<div class="line">  <a name="a38"></a><a class="code" href="p4est__build_8h.html#ace074702ba4d8198e470a69af93ce155">p4est_build_init_add</a> (bcon, buildp_init_add);</div>
<div class="line">  sc_array_init (&amp;inq, <span class="keyword">sizeof</span> (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>));</div>
<div class="line">  pad = (pa_data_t *) sc_array_index_begin (g-&gt;padata);</div>
<div class="line">  <span class="keywordflow">for</span> (lpnum = 0, lall = 0, tt = g-&gt;p4est-&gt;first_local_tree;</div>
<div class="line">       tt &lt;= g-&gt;<a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#abd072c07f3197827fe22c16379de6ab8">last_local_tree</a>; ++tt) {</div>
<div class="line">    tree = p4est_tree_array_index (g-&gt;p4est-&gt;trees, tt);</div>
<div class="line">    <span class="keywordflow">for</span> (lq = 0; lq &lt; (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>.elem_count; ++lq) {</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* fetch number of particles in quadrant */</span></div>
<div class="line">      quad = p4est_quadrant_array_index (&amp;tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>, lq);</div>
<div class="line">      qud = (qu_data_t *) quad-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">      if ((ilem_particles = qud-&gt;u.lpend - lpnum) == 0) {</div>
<div class="line">        <span class="comment">/* no particles in this quadrant at all */</span></div>
<div class="line">        <span class="keywordflow">continue</span>;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* how many particles will we consider? */</span></div>
<div class="line">      P4EST_ASSERT (inq.elem_count == 0);</div>
<div class="line">      <span class="keywordflow">for</span> (li = 0; li &lt; ilem_particles; ++li, ++lall, ++pad) {</div>
<div class="line">        <span class="keywordflow">if</span> (!(pad-&gt;id % g-&gt;build_part)) {</div>
<div class="line">          *(<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> *) sc_array_push (&amp;inq) = lall;</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">if</span> (inq.elem_count &gt; 0) {</div>
<div class="line">        bit-&gt;quad = *quad;</div>
<div class="line">        sc_array_swap_init (&amp;bit-&gt;parr, &amp;inq, sizeof (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>));</div>
<div class="line">        buildp_add (g, bcon, tt, bit);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* move to next quadrant */</span></div>
<div class="line">      lpnum = qud-&gt;u.lpend;</div>
<div class="line">      P4EST_ASSERT (lpnum == lall);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  P4EST_ASSERT (lall == (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) g-&gt;padata-&gt;elem_count);</div>
<div class="line">  P4EST_ASSERT (pad == (pa_data_t *) sc_array_index_end (g-&gt;padata));</div>
<div class="line">  P4EST_ASSERT (inq.elem_count == 0 &amp;&amp; inq.array == NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* create a temporary sparse forest */</span></div>
<div class="line">  cont = NULL;</div>
<div class="line">  pdata = NULL;</div>
<div class="line">  build = <a name="a39"></a><a class="code" href="p4est__build_8h.html#a2e404ba490b1fab9d6af82567231bf76">p4est_build_complete</a> (bcon);</div>
<div class="line">  <span class="keywordflow">if</span> (!g-&gt;scaling || g-&gt;verylast) {</div>
<div class="line">    P4EST_GLOBAL_ESSENTIALF (<span class="stringliteral">&quot;Built forest with %lld quadrants from %lld\n&quot;</span>,</div>
<div class="line">                             (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) build-&gt;<a name="a40"></a><a class="code" href="structp4est.html#a92c7d2fddd5c84a5245f4873d4f2026a">global_num_quadrants</a>,</div>
<div class="line">                             (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) g-&gt;p4est-&gt;global_num_quadrants);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t1 = sc_MPI_Wtime ();</div>
<div class="line">  <span class="keywordflow">if</span> (!g-&gt;scaling || g-&gt;verylast) {</div>
<div class="line">    sc_stats_accumulate (g-&gt;si + PART_STATS_BUILD, t1 - t0_build);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* count per-tree quadrants */</span></div>
<div class="line">  pertree = <a class="code" href="p4est__base_8h.html#a1fef909873d570158d6ac7b43c7d94f1">P4EST_ALLOC</a> (<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>, g-&gt;conn-&gt;num_trees + 1);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t0_pertreeF = sc_MPI_Wtime ();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* per-tree counts of full forest */</span></div>
<div class="line">  <a name="a41"></a><a class="code" href="p4est__communication_8h.html#af29e500817471c16943a8f6517e41e6f">p4est_comm_count_pertree</a> (g-&gt;p4est, pertree);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t1 = sc_MPI_Wtime ();</div>
<div class="line">  <span class="keywordflow">if</span> (!g-&gt;scaling || g-&gt;verylast) {</div>
<div class="line">    sc_stats_accumulate (g-&gt;si + PART_STATS_PERTREEF, t1 - t0_pertreeF);</div>
<div class="line">  }</div>
<div class="line">  t0_pertreeB = sc_MPI_Wtime ();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* per-tree counts of full forest */</span></div>
<div class="line">  <a class="code" href="p4est__communication_8h.html#af29e500817471c16943a8f6517e41e6f">p4est_comm_count_pertree</a> (build, pertree);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t1 = sc_MPI_Wtime ();</div>
<div class="line">  <span class="keywordflow">if</span> (!g-&gt;scaling || g-&gt;verylast) {</div>
<div class="line">    sc_stats_accumulate (g-&gt;si + PART_STATS_PERTREEB, t1 - t0_pertreeB);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* clean up per-tree counts */</span></div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a0b2d45f13b66edfed0ccfde75808c745">P4EST_FREE</a> (pertree);</div>
<div class="line">  pertree = NULL;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* write temporary sparse forest to disk */</span></div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    <span class="comment">/* open files for output */</span></div>
<div class="line">    snprintf (filename, BUFSIZ, <span class="stringliteral">&quot;%s_W_%06d&quot;</span>, g-&gt;prefix, k);</div>
<div class="line">    <span class="keywordflow">if</span> (!g-&gt;scaling) {</div>
<div class="line">      cont = <a class="code" href="p4est__vtk_8h.html#a34dbafa8dbc61172ead1a4da4c7103ca">p4est_vtk_context_new</a> (build, filename);</div>
<div class="line">      <span class="keywordflow">if</span> (NULL == <a class="code" href="p4est__vtk_8h.html#a17ce523f11f580944630c6c604a070da">p4est_vtk_write_header</a> (cont)) {</div>
<div class="line">        P4EST_LERRORF (<span class="stringliteral">&quot;Failed to write header for %s\n&quot;</span>, filename);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* prepare cell data for output */</span></div>
<div class="line">    pdata = sc_array_new_count (<span class="keyword">sizeof</span> (<span class="keywordtype">double</span>), build-&gt;<a name="a42"></a><a class="code" href="structp4est.html#a40324cbcc175d48f887735afd5c4239f">local_num_quadrants</a>);</div>
<div class="line">    <span class="keywordflow">for</span> (lpnum = 0, lall = 0, tt = build-&gt;<a name="a43"></a><a class="code" href="structp4est.html#a124d4dc0b8cd3b07351de80f19351beb">first_local_tree</a>;</div>
<div class="line">         tt &lt;= build-&gt;last_local_tree; ++tt) {</div>
<div class="line">      tree = p4est_tree_array_index (build-&gt;<a name="a44"></a><a class="code" href="structp4est.html#a6158d35a403f1dbec23833746c5b4a8b">trees</a>, tt);</div>
<div class="line">      <span class="keywordflow">for</span> (lq = 0; lq &lt; (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>.elem_count; ++lq) {</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* fetch number of particles in quadrant */</span></div>
<div class="line">        quad = p4est_quadrant_array_index (&amp;tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>, lq);</div>
<div class="line">        bud = (bu_data_t *) quad-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">        *(<span class="keywordtype">double</span> *) sc_array_index (pdata, lall++) = (double) bud-&gt;count;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* move to next quadrant */</span></div>
<div class="line">        lpnum = qud-&gt;u.lpend;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* write cell data to file */</span></div>
<div class="line">    <span class="keywordflow">if</span> (!g-&gt;scaling) {</div>
<div class="line">      <span class="keywordflow">if</span> (NULL == <a class="code" href="p4est__vtk_8h.html#a7120e8be889eed8a43a781db9f12f00a">p4est_vtk_write_cell_dataf</a></div>
<div class="line">          (cont, 1, 1, 1, g-&gt;build_wrap, 1, 0, <span class="stringliteral">&quot;particles&quot;</span>, pdata, cont)) {</div>
<div class="line">        P4EST_LERRORF (<span class="stringliteral">&quot;Failed to write cell data for %s\n&quot;</span>, filename);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    sc_array_destroy_null (&amp;pdata);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* finish meta information and close files */</span></div>
<div class="line">    <span class="keywordflow">if</span> (!g-&gt;scaling) {</div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="p4est__vtk_8h.html#a23950ebd8b9b99877fa152752b5150d4">p4est_vtk_write_footer</a> (cont)) {</div>
<div class="line">        P4EST_LERRORF (<span class="stringliteral">&quot;Failed to write footer for %s\n&quot;</span>, filename);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">while</span> (0);</div>
<div class="line">  <span class="keywordflow">if</span> (pdata != NULL) {</div>
<div class="line">    sc_array_destroy_null (&amp;pdata);</div>
<div class="line">  }</div>
<div class="line">  <a name="a45"></a><a class="code" href="p4est_8h.html#a1e78f347378fe8b097ef019214f2338e">p4est_destroy</a> (build);</div>
<div class="line">  g-&gt;add_count = 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">sim (part_global_t * g)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 k;</div>
<div class="line">  <span class="keywordtype">double</span>              t, h, f;</div>
<div class="line">  <span class="keywordtype">double</span>              t0_rk, t1;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a>      tt;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      lpnum, lq;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      li, ilem_particles;</div>
<div class="line">  <a class="code" href="structp4est__tree.html">p4est_tree_t</a>       *tree;</div>
<div class="line">  <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a>   *quad;</div>
<div class="line">  qu_data_t          *qud;</div>
<div class="line">  pa_data_t          *pad;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g-&gt;padata != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;stage == 0);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* output initial condition */</span></div>
<div class="line">  t = 0.;</div>
<div class="line">  k = 0;</div>
<div class="line">  pprint (g, t);</div>
<div class="line">  outp (g, k);</div>
<div class="line">  buildp (g, k);</div>
<div class="line">  g-&gt;verylast = 0;</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** loop over simulation time ***/</span></div>
<div class="line">  <span class="keywordflow">while</span> (t &lt; g-&gt;finaltime) {</div>
<div class="line">    h = g-&gt;deltat;</div>
<div class="line">    f = t + h;</div>
<div class="line">    <span class="keywordflow">if</span> (f &gt; g-&gt;finaltime - 1e-3 * g-&gt;deltat) {</div>
<div class="line">      f = g-&gt;finaltime;</div>
<div class="line">      h = f - t;</div>
<div class="line">      P4EST_ASSERT (!g-&gt;verylast);</div>
<div class="line">      g-&gt;verylast = 1;</div>
<div class="line">      P4EST_GLOBAL_ESSENTIALF</div>
<div class="line">        (<span class="stringliteral">&quot;Last time step %d with %lld particles and %lld quadrants\n&quot;</span>, k,</div>
<div class="line">         (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) g-&gt;gpnum, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) g-&gt;p4est-&gt;global_num_quadrants);</div>
<div class="line">    }</div>
<div class="line">    P4EST_GLOBAL_STATISTICSF (<span class="stringliteral">&quot;Time %g into step %d with %g\n&quot;</span>, t, k, h);</div>
<div class="line"> </div>
<div class="line"><span class="comment">    /*** loop over Runge Kutta stages ***/</span></div>
<div class="line">    <span class="keywordflow">for</span> (g-&gt;stage = 0; g-&gt;stage &lt; g-&gt;order; ++g-&gt;stage) {</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* if a stage is not the last compute new evaluation location */</span></div>
<div class="line">      <span class="comment">/* for the last stage compute the new location of the particle */</span></div>
<div class="line">      <span class="comment">/* do parallel transfer at end of each stage */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">      /*** time step for local particles ***/</span></div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* STATS */</span></div>
<div class="line">      t0_rk = sc_MPI_Wtime ();</div>
<div class="line"> </div>
<div class="line">      pad = (pa_data_t *) sc_array_index_begin (g-&gt;padata);</div>
<div class="line">      <span class="keywordflow">if</span> (pad != NULL) {</div>
<div class="line">        lpnum = 0;</div>
<div class="line">        <span class="keywordflow">for</span> (tt = g-&gt;p4est-&gt;first_local_tree; tt &lt;= g-&gt;<a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#abd072c07f3197827fe22c16379de6ab8">last_local_tree</a>;</div>
<div class="line">             ++tt) {</div>
<div class="line">          tree = p4est_tree_array_index (g-&gt;p4est-&gt;trees, tt);</div>
<div class="line">          <span class="keywordflow">for</span> (lq = 0; lq &lt; (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>.elem_count; ++lq) {</div>
<div class="line">            quad = p4est_quadrant_array_index (&amp;tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>, lq);</div>
<div class="line">            qud = (qu_data_t *) quad-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">            ilem_particles = qud-&gt;u.lpend - lpnum;</div>
<div class="line"> </div>
<div class="line"><span class="comment">            /*** loop through particles in this quadrant */</span></div>
<div class="line">            for (li = 0; li &lt; ilem_particles; ++li) {</div>
<div class="line">              <span class="comment">/* one Runge Kutta stage for this particle */</span></div>
<div class="line">              rkstage (g, pad++, h);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* move to next quadrant */</span></div>
<div class="line">            lpnum = qud-&gt;u.lpend;</div>
<div class="line">          }</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* STATS */</span></div>
<div class="line">      t1 = sc_MPI_Wtime ();</div>
<div class="line">      <span class="keywordflow">if</span> (!g-&gt;scaling || g-&gt;verylast) {</div>
<div class="line">        sc_stats_accumulate (g-&gt;si + PART_STATS_RK, t1 - t0_rk);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* begin loop -- currently there is no loop */</span></div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* find new local quadrant or process for each particle */</span></div>
<div class="line">      presearch (g);</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* send leaving particles to receiver processes */</span></div>
<div class="line">      pack (g);</div>
<div class="line">      comm (g);</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* process remaining local and newly received particles */</span></div>
<div class="line">      postsearch (g);</div>
<div class="line">      adapt (g);</div>
<div class="line">      regroup (g);</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* wait for sent messages to complete */</span></div>
<div class="line">      waitmpi (g);</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* if no refinement occurred, store received particles and break loop */</span></div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* partition weighted by current + received count (?) */</span></div>
<div class="line">      <span class="comment">/* partition the forest and send particles along with the partition */</span></div>
<div class="line">      <span class="comment">/* transfer particles accordingly */</span></div>
<div class="line">      <span class="comment">/* think about partitioning and sending particles to future owner? */</span></div>
<div class="line">      part (g);</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* end loop -- currently there is no loop */</span></div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (g-&gt;gpnum == 0) {</div>
<div class="line">        <span class="comment">/* we have run out of particles */</span></div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="comment">    /*** finish up time step ***/</span></div>
<div class="line">    ++k;</div>
<div class="line">    t = f;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* maybe we have run out of particles and stop */</span></div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;gpnum == 0) {</div>
<div class="line">      P4EST_GLOBAL_PRODUCTIONF</div>
<div class="line">        (<span class="stringliteral">&quot;We have lost all %lld particles\n&quot;</span>, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) g-&gt;gplost);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    P4EST_ASSERT (g-&gt;stage == g-&gt;order);</div>
<div class="line">    g-&gt;stage = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* write output files */</span></div>
<div class="line">    pprint (g, t);</div>
<div class="line">    outp (g, k);</div>
<div class="line">    buildp (g, k);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  P4EST_GLOBAL_ESSENTIALF</div>
<div class="line">    (<span class="stringliteral">&quot;Time %g is final after %d steps lost %lld remain %lld\n&quot;</span>, t, k,</div>
<div class="line">     (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) g-&gt;gplost, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) g-&gt;gpnum);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">notif (part_global_t * g)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 mpiret;</div>
<div class="line">  <span class="keywordtype">int</span>                 i, j;</div>
<div class="line">  <span class="keywordtype">int</span>                 q, r;</div>
<div class="line">  <span class="keywordtype">double</span>              t0_binary, t0_nary, t1;</div>
<div class="line">  sc_array_t         *recv1, *send1, *payl1;</div>
<div class="line">  sc_array_t         *recv2, *send2, *payl2;</div>
<div class="line">  sc_notify_t        *notifyc;</div>
<div class="line"> </div>
<div class="line">  recv1 = sc_array_new (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>));</div>
<div class="line">  send1 = sc_array_new (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>));</div>
<div class="line">  payl1 = sc_array_new (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>));</div>
<div class="line"> </div>
<div class="line">  recv2 = sc_array_new (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>));</div>
<div class="line">  send2 = sc_array_new (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>));</div>
<div class="line">  payl2 = sc_array_new (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* send to 7 ranks to the left, 11 apart */</span></div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; 7; ++i) {</div>
<div class="line">    q = g-&gt;mpirank - (7 - i) * 11;</div>
<div class="line">    <span class="keywordflow">if</span> (q &gt;= 0) {</div>
<div class="line">      *(<span class="keywordtype">int</span> *) sc_array_push (recv1) = q;</div>
<div class="line">      *(<span class="keywordtype">int</span> *) sc_array_push (payl1) = g-&gt;mpirank % 19;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="comment">/* send to 5 ranks to the right, 13 apart */</span></div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; 5; ++i) {</div>
<div class="line">    q = g-&gt;mpirank + (i + 1) * 13;</div>
<div class="line">    <span class="keywordflow">if</span> (q &lt; g-&gt;mpisize) {</div>
<div class="line">      *(<span class="keywordtype">int</span> *) sc_array_push (recv1) = q;</div>
<div class="line">      *(<span class="keywordtype">int</span> *) sc_array_push (payl1) = g-&gt;mpirank % 19;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  sc_array_copy (recv2, recv1);</div>
<div class="line">  sc_array_copy (payl2, payl1);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* allocate notify controller */</span></div>
<div class="line">  notifyc = sc_notify_new (g-&gt;mpicomm);</div>
<div class="line">  sc_notify_set_type (notifyc, SC_NOTIFY_NARY);</div>
<div class="line"> </div>
<div class="line">  mpiret = sc_MPI_Barrier (g-&gt;mpicomm);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t0_binary = sc_MPI_Wtime ();</div>
<div class="line"> </div>
<div class="line">  sc_notify_nary_set_widths (notifyc, 2, 2, 2);</div>
<div class="line">  sc_notify_payload (recv1, send1, payl1, NULL, 1, notifyc);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t1 = sc_MPI_Wtime ();</div>
<div class="line">  sc_stats_accumulate (g-&gt;si + PART_STATS_BINARY, t1 - t0_binary);</div>
<div class="line"> </div>
<div class="line">  mpiret = sc_MPI_Barrier (g-&gt;mpicomm);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t0_nary = sc_MPI_Wtime ();</div>
<div class="line"> </div>
<div class="line">  sc_notify_nary_set_widths (notifyc, g-&gt;ntop, g-&gt;nint, g-&gt;nbot);</div>
<div class="line">  sc_notify_payload (recv2, send2, payl2, NULL, 1, notifyc);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* STATS */</span></div>
<div class="line">  t1 = sc_MPI_Wtime ();</div>
<div class="line">  sc_stats_accumulate (g-&gt;si + PART_STATS_NARY, t1 - t0_nary);</div>
<div class="line"> </div>
<div class="line">  SC_CHECK_ABORT (send1-&gt;elem_count == payl1-&gt;elem_count, <span class="stringliteral">&quot;Send Payl 1&quot;</span>);</div>
<div class="line">  SC_CHECK_ABORT (send2-&gt;elem_count == payl2-&gt;elem_count, <span class="stringliteral">&quot;Send Payl 2&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  SC_CHECK_ABORT (sc_array_is_equal (send1, send2), <span class="stringliteral">&quot;Send 1 2&quot;</span>);</div>
<div class="line">  SC_CHECK_ABORT (sc_array_is_equal (payl1, payl2), <span class="stringliteral">&quot;Payl 1 2&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  j = 0;</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; 5; ++i) {</div>
<div class="line">    q = g-&gt;mpirank - (5 - i) * 13;</div>
<div class="line">    <span class="keywordflow">if</span> (q &gt;= 0) {</div>
<div class="line">      SC_CHECK_ABORT (q == *(<span class="keywordtype">int</span> *) sc_array_index_int (send1, j), <span class="stringliteral">&quot;Left q&quot;</span>);</div>
<div class="line">      r = *(<span class="keywordtype">int</span> *) sc_array_index_int (payl1, j);</div>
<div class="line">      SC_CHECK_ABORT (q % 19 == r, <span class="stringliteral">&quot;Left r&quot;</span>);</div>
<div class="line">      ++j;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; 7; ++i) {</div>
<div class="line">    q = g-&gt;mpirank + (i + 1) * 11;</div>
<div class="line">    <span class="keywordflow">if</span> (q &lt; g-&gt;mpisize) {</div>
<div class="line">      SC_CHECK_ABORT (q == *(<span class="keywordtype">int</span> *) sc_array_index_int (send1, j), <span class="stringliteral">&quot;Right q&quot;</span>);</div>
<div class="line">      r = *(<span class="keywordtype">int</span> *) sc_array_index_int (payl1, j);</div>
<div class="line">      SC_CHECK_ABORT (q % 19 == r, <span class="stringliteral">&quot;Right r&quot;</span>);</div>
<div class="line">      ++j;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  SC_CHECK_ABORT (j == (<span class="keywordtype">int</span>) send1-&gt;elem_count, <span class="stringliteral">&quot;Count j&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  sc_notify_destroy (notifyc);</div>
<div class="line">  sc_array_destroy (recv1);</div>
<div class="line">  sc_array_destroy (send1);</div>
<div class="line">  sc_array_destroy (payl1);</div>
<div class="line">  sc_array_destroy (recv2);</div>
<div class="line">  sc_array_destroy (send2);</div>
<div class="line">  sc_array_destroy (payl2);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">run (part_global_t * g)</div>
<div class="line">{</div>
<div class="line">  pi_data_t           spiddata, *piddata = &amp;spiddata;</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** initialize variables ***/</span></div>
<div class="line">  run_pre (g, piddata);</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** initial mesh for domain ***/</span></div>
<div class="line">  <span class="keywordflow">if</span> (g-&gt;bricklev &gt; 0) {</div>
<div class="line">    g-&gt;conn = <a name="a46"></a><a class="code" href="p4est__connectivity_8h.html#a524e3271ec0560d269403e5ec1c993dc">p4est_connectivity_new_brick</a> (g-&gt;bricklength, g-&gt;bricklength</div>
<div class="line">#ifdef P4_TO_P8</div>
<div class="line">                                            , g-&gt;bricklength</div>
<div class="line">#endif</div>
<div class="line">                                            , 1, 1</div>
<div class="line">#ifdef P4_TO_P8</div>
<div class="line">                                            , 1</div>
<div class="line">#endif</div>
<div class="line">      );</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> {</div>
<div class="line"><span class="preprocessor">#ifndef P4_TO_P8</span></div>
<div class="line">    g-&gt;conn = <a name="a47"></a><a class="code" href="p4est__connectivity_8h.html#aab03936b137ccdc4fa7520e7e017fcf0">p4est_connectivity_new_unitsquare</a> ();</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    g-&gt;conn = <a name="a48"></a><a class="code" href="p8est__connectivity_8h.html#a53bdb596e76c52c1e23aaecd0aacc763">p8est_connectivity_new_unitcube</a> ();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  }</div>
<div class="line">  g-&gt;p4est = <a name="a49"></a><a class="code" href="p4est__extended_8h.html#ac11cf572e8ac72c4beb78465f98b63f3">p4est_new_ext</a> (g-&gt;mpicomm, g-&gt;conn, 0,</div>
<div class="line">                            g-&gt;minlevel - g-&gt;bricklev, 1,</div>
<div class="line">                            sizeof (qu_data_t), NULL, g);</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** initial refinement and partition ***/</span></div>
<div class="line">  initrp (g);</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** create particles ***/</span></div>
<div class="line">  g-&gt;padata = sc_array_new (<span class="keyword">sizeof</span> (pa_data_t));</div>
<div class="line">  create (g);</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** run simulation ***/</span></div>
<div class="line">  sim (g);</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;padata);</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** destroy mesh ***/</span></div>
<div class="line">  <a class="code" href="p4est_8h.html#a1e78f347378fe8b097ef019214f2338e">p4est_destroy</a> (g-&gt;p4est);</div>
<div class="line">  g-&gt;p4est = NULL;</div>
<div class="line">  <a name="a50"></a><a class="code" href="p4est__connectivity_8h.html#a208e613cae5e1bd3baffb587387b672c">p4est_connectivity_destroy</a> (g-&gt;conn);</div>
<div class="line">  g-&gt;conn = NULL;</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** extra timings for notify ***/</span></div>
<div class="line">  notif (g);</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** clean up variables ***/</span></div>
<div class="line">  run_post (g);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">usagerr (sc_options_t * opt, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg)</div>
<div class="line">{</div>
<div class="line">  SC_GLOBAL_LERRORF (<span class="stringliteral">&quot;Usage required: %s\n&quot;</span>, msg);</div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 mpiret;</div>
<div class="line">  <span class="keywordtype">int</span>                 first_argc;</div>
<div class="line">  <span class="keywordtype">int</span>                 ue;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span>         *opt_notify, *opt_vtk, *opt_build;</div>
<div class="line">  sc_options_t       *opt;</div>
<div class="line">  part_global_t global, *g = &amp;global;</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** setup mpi environment ***/</span></div>
<div class="line"> </div>
<div class="line">  mpiret = sc_MPI_Init (&amp;argc, &amp;argv);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line"> </div>
<div class="line">  memset (g, 0, <span class="keyword">sizeof</span> (*g));</div>
<div class="line">  g-&gt;mpicomm = sc_MPI_COMM_WORLD;</div>
<div class="line">  mpiret = sc_MPI_Comm_size (g-&gt;mpicomm, &amp;g-&gt;mpisize);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line">  mpiret = sc_MPI_Comm_rank (g-&gt;mpicomm, &amp;g-&gt;mpirank);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line">  sc_init (g-&gt;mpicomm, 1, 1, NULL, SC_LP_DEFAULT);</div>
<div class="line">  <a name="a51"></a><a class="code" href="p4est__base_8h.html#aab4b16aa58790d309e0cf46ed665c6b9">p4est_init</a> (NULL, SC_LP_DEFAULT);</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** read command line parameters ***/</span></div>
<div class="line"> </div>
<div class="line">  opt = sc_options_new (argv[0]);</div>
<div class="line">  sc_options_add_int (opt, <span class="charliteral">&#39;l&#39;</span>, <span class="stringliteral">&quot;minlevel&quot;</span>, &amp;g-&gt;minlevel, 0, <span class="stringliteral">&quot;Lowest level&quot;</span>);</div>
<div class="line">  sc_options_add_int (opt, <span class="charliteral">&#39;L&#39;</span>, <span class="stringliteral">&quot;maxlevel&quot;</span>, &amp;g-&gt;maxlevel,</div>
<div class="line">                      <a name="a52"></a><a class="code" href="p4est_8h.html#a398bac71234696389c90d0f986bb31aa">P4EST_QMAXLEVEL</a>, <span class="stringliteral">&quot;Highest level&quot;</span>);</div>
<div class="line">  sc_options_add_int (opt, <span class="charliteral">&#39;b&#39;</span>, <span class="stringliteral">&quot;bricklev&quot;</span>, &amp;g-&gt;bricklev,</div>
<div class="line">                      0, <span class="stringliteral">&quot;Brick refinement level&quot;</span>);</div>
<div class="line">  sc_options_add_int (opt, <span class="charliteral">&#39;r&#39;</span>, <span class="stringliteral">&quot;rkorder&quot;</span>, &amp;g-&gt;order,</div>
<div class="line">                      1, <span class="stringliteral">&quot;Order of Runge Kutta method&quot;</span>);</div>
<div class="line">  sc_options_add_bool (opt, <span class="charliteral">&#39;p&#39;</span>, <span class="stringliteral">&quot;olap-notify&quot;</span>, &amp;g-&gt;olap_notify, 0,</div>
<div class="line">                       <span class="stringliteral">&quot;Overlap sending with notify&quot;</span>);</div>
<div class="line">  sc_options_add_string (opt, <span class="charliteral">&#39;Y&#39;</span>, <span class="stringliteral">&quot;notify&quot;</span>, &amp;opt_notify, NULL,</div>
<div class="line">                         <span class="stringliteral">&quot;Notify ntop:nint:nbot&quot;</span>);</div>
<div class="line">  sc_options_add_double (opt, <span class="charliteral">&#39;n&#39;</span>, <span class="stringliteral">&quot;particles&quot;</span>, &amp;g-&gt;num_particles,</div>
<div class="line">                         1e3, <span class="stringliteral">&quot;Global number of particles&quot;</span>);</div>
<div class="line">  sc_options_add_double (opt, <span class="charliteral">&#39;e&#39;</span>, <span class="stringliteral">&quot;pperelem&quot;</span>, &amp;g-&gt;elem_particles,</div>
<div class="line">                         <a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a>, <span class="stringliteral">&quot;Number of particles per quadrant&quot;</span>);</div>
<div class="line">  sc_options_add_double (opt, <span class="charliteral">&#39;h&#39;</span>, <span class="stringliteral">&quot;deltat&quot;</span>, &amp;g-&gt;deltat,</div>
<div class="line">                         1e-1, <span class="stringliteral">&quot;Time step size&quot;</span>);</div>
<div class="line">  sc_options_add_double (opt, <span class="charliteral">&#39;T&#39;</span>, <span class="stringliteral">&quot;finaltime&quot;</span>, &amp;g-&gt;finaltime,</div>
<div class="line">                         1., <span class="stringliteral">&quot;Final time of simulation&quot;</span>);</div>
<div class="line">  sc_options_add_int (opt, <span class="charliteral">&#39;R&#39;</span>, <span class="stringliteral">&quot;printn&quot;</span>, &amp;g-&gt;printn, 0,</div>
<div class="line">                      <span class="stringliteral">&quot;Print every nth particle&quot;</span>);</div>
<div class="line">  sc_options_add_string (opt, <span class="charliteral">&#39;V&#39;</span>, <span class="stringliteral">&quot;vtk&quot;</span>, &amp;opt_vtk, NULL,</div>
<div class="line">                         <span class="stringliteral">&quot;VTK output everystep:wraprank&quot;</span>);</div>
<div class="line">  sc_options_add_string (opt, <span class="charliteral">&#39;W&#39;</span>, <span class="stringliteral">&quot;build&quot;</span>, &amp;opt_build, NULL,</div>
<div class="line">                         <span class="stringliteral">&quot;Build output everystep:particle:wrap&quot;</span>);</div>
<div class="line">  sc_options_add_bool (opt, <span class="charliteral">&#39;S&#39;</span>, <span class="stringliteral">&quot;scaling&quot;</span>, &amp;g-&gt;scaling, 0,</div>
<div class="line">                       <span class="stringliteral">&quot;Configure for scaling test&quot;</span>);</div>
<div class="line">  sc_options_add_bool (opt, <span class="charliteral">&#39;C&#39;</span>, <span class="stringliteral">&quot;collapse&quot;</span>, &amp;g-&gt;collapse, 0,</div>
<div class="line">                       <span class="stringliteral">&quot;Collapse statistics over time&quot;</span>);</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line">  sc_options_add_int (opt, <span class="charliteral">&#39;C&#39;</span>, <span class="stringliteral">&quot;checkp&quot;</span>, &amp;g-&gt;checkp, 0,</div>
<div class="line">                      <span class="stringliteral">&quot;write checkpoint output&quot;</span>);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  sc_options_add_string (opt, <span class="charliteral">&#39;P&#39;</span>, <span class="stringliteral">&quot;prefix&quot;</span>, &amp;g-&gt;prefix,</div>
<div class="line">                         <span class="stringliteral">&quot;p&quot;</span> PARTICLES_48 ()<span class="stringliteral">&quot;rticles&quot;</span>,</div>
<div class="line">                         <span class="stringliteral">&quot;prefix for file output&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* proceed in run-once loop for clean abort */</span></div>
<div class="line">  ue = 0;</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    <span class="comment">/* read command line and assign variables */</span></div>
<div class="line">    first_argc = sc_options_parse (<a class="code" href="p4est__base_8h.html#a43e4ed63c500a6dd8731d796703c39d1">p4est_package_id</a>, SC_LP_DEFAULT,</div>
<div class="line">                                   opt, argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (first_argc &lt; 0 || first_argc != argc) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;Invalid option format or non-option arguments&quot;</span>);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    g-&gt;ntop = g-&gt;nint = g-&gt;nbot = 2;</div>
<div class="line">    part_string_to_int (opt_notify, 3, &amp;g-&gt;ntop, &amp;g-&gt;nint, &amp;g-&gt;nbot);</div>
<div class="line">    part_string_to_int (opt_vtk, 2, &amp;g-&gt;vtk, &amp;g-&gt;mpiwrap);</div>
<div class="line">    part_string_to_int (opt_build,</div>
<div class="line">                        3, &amp;g-&gt;build_step, &amp;g-&gt;build_part, &amp;g-&gt;build_wrap);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* report option and parameter values */</span></div>
<div class="line">    P4EST_GLOBAL_ESSENTIALF (<span class="stringliteral">&quot;Dimension is %d\n&quot;</span>, <a class="code" href="p4est__connectivity_8h.html#a2c4786e65053166a16b7afb2711d35cb">P4EST_DIM</a>);</div>
<div class="line">    sc_options_print_summary (<a class="code" href="p4est__base_8h.html#a43e4ed63c500a6dd8731d796703c39d1">p4est_package_id</a>, SC_LP_ESSENTIAL, opt);</div>
<div class="line">    P4EST_GLOBAL_ESSENTIALF (<span class="stringliteral">&quot;Notify parameters: %d %d %d\n&quot;</span>,</div>
<div class="line">                             g-&gt;ntop, g-&gt;nint, g-&gt;nbot);</div>
<div class="line">    P4EST_GLOBAL_ESSENTIALF (<span class="stringliteral">&quot;VTK parameters: %d %d\n&quot;</span>, g-&gt;vtk, g-&gt;mpiwrap);</div>
<div class="line">    P4EST_GLOBAL_ESSENTIALF (<span class="stringliteral">&quot;Build parameters: %d %d %d\n&quot;</span>,</div>
<div class="line">                             g-&gt;build_step, g-&gt;build_part, g-&gt;build_wrap);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* check options for consistency */</span></div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;minlevel &lt; 0 || g-&gt;minlevel &gt; <a class="code" href="p4est_8h.html#a398bac71234696389c90d0f986bb31aa">P4EST_QMAXLEVEL</a>) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;Minlevel between 0 and P4EST_QMAXLEVEL&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;maxlevel &lt; g-&gt;minlevel || g-&gt;maxlevel &gt; <a class="code" href="p4est_8h.html#a398bac71234696389c90d0f986bb31aa">P4EST_QMAXLEVEL</a>) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;Maxlevel between minlevel and P4EST_QMAXLEVEL&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;bricklev &lt; 0 || g-&gt;bricklev &gt; g-&gt;minlevel) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;Brick level between 0 and minlevel&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;order &lt; 1 || g-&gt;order &gt; 4) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;Runge Kutta order between 1 and 4&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;ntop &lt; 2 || g-&gt;nint &lt; 2 || g-&gt;nbot &lt; 2) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;Notify parameters greater equal 2&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;num_particles &lt;= 0.) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;Global number of particles positive&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;elem_particles &lt;= 0.) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;Number of particles per quadrant positive&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;printn &lt; 0) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;Particle print interval non-negative&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;vtk &lt; 0 || g-&gt;mpiwrap &lt; 0) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;VTK output interval and wrap non-negative&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;build_step &lt; 0 || g-&gt;build_part &lt; 0 || g-&gt;build_wrap &lt; 0) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;Build intervals and wrap non-negative&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (ue) {</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="comment">    /*** run program ***/</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;scaling) {</div>
<div class="line">      sc_package_set_verbosity (sc_package_id, SC_LP_PRODUCTION);</div>
<div class="line">      sc_package_set_verbosity (<a class="code" href="p4est__base_8h.html#a43e4ed63c500a6dd8731d796703c39d1">p4est_package_id</a>, SC_LP_PRODUCTION);</div>
<div class="line">    }</div>
<div class="line">    run (g);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">while</span> (0);</div>
<div class="line">  <span class="keywordflow">if</span> (ue) {</div>
<div class="line">    sc_options_print_usage (<a class="code" href="p4est__base_8h.html#a43e4ed63c500a6dd8731d796703c39d1">p4est_package_id</a>, SC_LP_ERROR, opt, NULL);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** clean up and exit ***/</span></div>
<div class="line"> </div>
<div class="line">  sc_options_destroy (opt);</div>
<div class="line">  sc_finalize ();</div>
<div class="line"> </div>
<div class="line">  mpiret = sc_MPI_Finalize ();</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> ue ? EXIT_FAILURE : EXIT_SUCCESS;</div>
<div class="line">}</div>
<div class="ttc" id="ap4est_8h_html_a1e78f347378fe8b097ef019214f2338e"><div class="ttname"><a href="p4est_8h.html#a1e78f347378fe8b097ef019214f2338e">p4est_destroy</a></div><div class="ttdeci">void p4est_destroy(p4est_t *p4est)</div><div class="ttdoc">Destroy a p4est.</div></div>
<div class="ttc" id="ap4est_8h_html_a398bac71234696389c90d0f986bb31aa"><div class="ttname"><a href="p4est_8h.html#a398bac71234696389c90d0f986bb31aa">P4EST_QMAXLEVEL</a></div><div class="ttdeci">#define P4EST_QMAXLEVEL</div><div class="ttdoc">The finest level of the quadtree for representing quadrant corners.</div><div class="ttdef"><b>Definition:</b> p4est.h:59</div></div>
<div class="ttc" id="ap4est_8h_html_a54c1f4e6bc35c181952371a8046523aa"><div class="ttname"><a href="p4est_8h.html#a54c1f4e6bc35c181952371a8046523aa">p4est_partition</a></div><div class="ttdeci">void p4est_partition(p4est_t *p4est, int allow_for_coarsening, p4est_weight_t weight_fn)</div><div class="ttdoc">Equally partition the forest.</div></div>
<div class="ttc" id="ap4est_8h_html_a6b603736cf5007b14755197a9c179a85"><div class="ttname"><a href="p4est_8h.html#a6b603736cf5007b14755197a9c179a85">p4est_balance</a></div><div class="ttdeci">void p4est_balance(p4est_t *p4est, p4est_connect_type_t btype, p4est_init_t init_fn)</div><div class="ttdoc">2:1 balance the size differences of neighboring elements in a forest.</div></div>
<div class="ttc" id="ap4est_8h_html_a90acb1ef22be84e31afdec64aab60567"><div class="ttname"><a href="p4est_8h.html#a90acb1ef22be84e31afdec64aab60567">p4est_qcoord_to_vertex</a></div><div class="ttdeci">void p4est_qcoord_to_vertex(p4est_connectivity_t *connectivity, p4est_topidx_t treeid, p4est_qcoord_t x, p4est_qcoord_t y, double vxyz[3])</div><div class="ttdoc">Transform a quadrant coordinate into the space spanned by tree vertices.</div></div>
<div class="ttc" id="ap4est_8h_html_a95dd59166894e55562dd7bb741bb78c5"><div class="ttname"><a href="p4est_8h.html#a95dd59166894e55562dd7bb741bb78c5">P4EST_QUADRANT_LEN</a></div><div class="ttdeci">#define P4EST_QUADRANT_LEN(l)</div><div class="ttdoc">The length of a quadrant of level l.</div><div class="ttdef"><b>Definition:</b> p4est.h:65</div></div>
<div class="ttc" id="ap4est__base_8h_html_a05ea8ceb664ae2403fbcf7b1dcc70ea0"><div class="ttname"><a href="p4est__base_8h.html#a05ea8ceb664ae2403fbcf7b1dcc70ea0">p4est_qcoord_t</a></div><div class="ttdeci">int32_t p4est_qcoord_t</div><div class="ttdoc">Typedef for quadrant coordinates.</div><div class="ttdef"><b>Definition:</b> p4est_base.h:81</div></div>
<div class="ttc" id="ap4est__base_8h_html_a0b2d45f13b66edfed0ccfde75808c745"><div class="ttname"><a href="p4est__base_8h.html#a0b2d45f13b66edfed0ccfde75808c745">P4EST_FREE</a></div><div class="ttdeci">#define P4EST_FREE(p)</div><div class="ttdoc">free an allocated array</div><div class="ttdef"><b>Definition:</b> p4est_base.h:210</div></div>
<div class="ttc" id="ap4est__base_8h_html_a1fef909873d570158d6ac7b43c7d94f1"><div class="ttname"><a href="p4est__base_8h.html#a1fef909873d570158d6ac7b43c7d94f1">P4EST_ALLOC</a></div><div class="ttdeci">#define P4EST_ALLOC(t, n)</div><div class="ttdoc">allocate a t-array with n elements</div><div class="ttdef"><b>Definition:</b> p4est_base.h:199</div></div>
<div class="ttc" id="ap4est__base_8h_html_a43e4ed63c500a6dd8731d796703c39d1"><div class="ttname"><a href="p4est__base_8h.html#a43e4ed63c500a6dd8731d796703c39d1">p4est_package_id</a></div><div class="ttdeci">SC_DLL_PUBLIC int p4est_package_id</div><div class="ttdoc">The package id for p4est within libsc.</div></div>
<div class="ttc" id="ap4est__base_8h_html_a8e849f705b0d4d1702b8f5102823f48c"><div class="ttname"><a href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a></div><div class="ttdeci">int32_t p4est_topidx_t</div><div class="ttdoc">Typedef for counting topological entities (trees, tree vertices).</div><div class="ttdef"><b>Definition:</b> p4est_base.h:93</div></div>
<div class="ttc" id="ap4est__base_8h_html_a9f350ee78755ec6e7d25fb1dca474573"><div class="ttname"><a href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a></div><div class="ttdeci">int32_t p4est_locidx_t</div><div class="ttdoc">Typedef for processor-local indexing of quadrants and nodes.</div><div class="ttdef"><b>Definition:</b> p4est_base.h:106</div></div>
<div class="ttc" id="ap4est__base_8h_html_aab4b16aa58790d309e0cf46ed665c6b9"><div class="ttname"><a href="p4est__base_8h.html#aab4b16aa58790d309e0cf46ed665c6b9">p4est_init</a></div><div class="ttdeci">void p4est_init(sc_log_handler_t log_handler, int log_threshold)</div><div class="ttdoc">Registers p4est with the SC Library and sets the logging behavior.</div></div>
<div class="ttc" id="ap4est__base_8h_html_af4d787f9b2520af0cfe9a10b89235749"><div class="ttname"><a href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a></div><div class="ttdeci">int64_t p4est_gloidx_t</div><div class="ttdoc">Typedef for globally unique indexing of quadrants.</div><div class="ttdef"><b>Definition:</b> p4est_base.h:118</div></div>
<div class="ttc" id="ap4est__bits_8h_html"><div class="ttname"><a href="p4est__bits_8h.html">p4est_bits.h</a></div><div class="ttdoc">Routines for manipulating quadrants (neighbors, parents, children, etc.)</div></div>
<div class="ttc" id="ap4est__bits_8h_html_a93fdfa19f38d4fca9e42896eda01a558"><div class="ttname"><a href="p4est__bits_8h.html#a93fdfa19f38d4fca9e42896eda01a558">p4est_quadrant_is_valid</a></div><div class="ttdeci">int p4est_quadrant_is_valid(const p4est_quadrant_t *q)</div><div class="ttdoc">Test if a quadrant has valid Morton indices and is inside the unit tree.</div></div>
<div class="ttc" id="ap4est__bits_8h_html_ac715371e458c411ee35b69629ceb733f"><div class="ttname"><a href="p4est__bits_8h.html#ac715371e458c411ee35b69629ceb733f">p4est_quadrant_child</a></div><div class="ttdeci">void p4est_quadrant_child(const p4est_quadrant_t *q, p4est_quadrant_t *r, int child_id)</div><div class="ttdoc">Compute a specific child of a quadrant.</div></div>
<div class="ttc" id="ap4est__build_8h_html"><div class="ttname"><a href="p4est__build_8h.html">p4est_build.h</a></div><div class="ttdoc">Create a new p4est object by adding individual quadrants in order.</div></div>
<div class="ttc" id="ap4est__build_8h_html_a29162254418af3724dc93e6f739cc403"><div class="ttname"><a href="p4est__build_8h.html#a29162254418af3724dc93e6f739cc403">p4est_build_t</a></div><div class="ttdeci">struct p4est_build p4est_build_t</div><div class="ttdoc">Context object for building a new p4est from individual quadrants.</div><div class="ttdef"><b>Definition:</b> p4est_build.h:43</div></div>
<div class="ttc" id="ap4est__build_8h_html_a2e404ba490b1fab9d6af82567231bf76"><div class="ttname"><a href="p4est__build_8h.html#a2e404ba490b1fab9d6af82567231bf76">p4est_build_complete</a></div><div class="ttdeci">p4est_t * p4est_build_complete(p4est_build_t *build)</div><div class="ttdoc">Finalize the construction of the new forest after adding quadrants.</div></div>
<div class="ttc" id="ap4est__build_8h_html_ab4211ea70163b7bd5329129ca340a555"><div class="ttname"><a href="p4est__build_8h.html#ab4211ea70163b7bd5329129ca340a555">p4est_build_add</a></div><div class="ttdeci">int p4est_build_add(p4est_build_t *build, p4est_topidx_t which_tree, p4est_quadrant_t *quadrant)</div><div class="ttdoc">This function is usable from a p4est_search_local_t callback.</div></div>
<div class="ttc" id="ap4est__build_8h_html_ace074702ba4d8198e470a69af93ce155"><div class="ttname"><a href="p4est__build_8h.html#ace074702ba4d8198e470a69af93ce155">p4est_build_init_add</a></div><div class="ttdeci">void p4est_build_init_add(p4est_build_t *build, p4est_init_t add_init_fn)</div><div class="ttdoc">Set a dedicated initialization callback for manually added quadrants.</div></div>
<div class="ttc" id="ap4est__build_8h_html_ade085b723cb557f255ee96efa9bbf68f"><div class="ttname"><a href="p4est__build_8h.html#ade085b723cb557f255ee96efa9bbf68f">p4est_build_new</a></div><div class="ttdeci">p4est_build_t * p4est_build_new(p4est_t *from, size_t data_size, p4est_init_t init_fn, void *user_pointer)</div><div class="ttdoc">Allocate a context for building a new forest.</div></div>
<div class="ttc" id="ap4est__communication_8h_html"><div class="ttname"><a href="p4est__communication_8h.html">p4est_communication.h</a></div><div class="ttdoc">Parallel messaging and support code.</div></div>
<div class="ttc" id="ap4est__communication_8h_html_a9a9ef6c16f81067f0c917a838a8fdfac"><div class="ttname"><a href="p4est__communication_8h.html#a9a9ef6c16f81067f0c917a838a8fdfac">p4est_transfer_fixed</a></div><div class="ttdeci">void p4est_transfer_fixed(const p4est_gloidx_t *dest_gfq, const p4est_gloidx_t *src_gfq, sc_MPI_Comm mpicomm, int tag, void *dest_data, const void *src_data, size_t data_size)</div><div class="ttdoc">Transfer data associated with one forest partition to another.</div></div>
<div class="ttc" id="ap4est__communication_8h_html_ace044f4c221f25afbb9a198ff24b676a"><div class="ttname"><a href="p4est__communication_8h.html#ace044f4c221f25afbb9a198ff24b676a">p4est_transfer_custom</a></div><div class="ttdeci">void p4est_transfer_custom(const p4est_gloidx_t *dest_gfq, const p4est_gloidx_t *src_gfq, sc_MPI_Comm mpicomm, int tag, void *dest_data, const int *dest_sizes, const void *src_data, const int *src_sizes)</div><div class="ttdoc">Transfer variable-size quadrant data between partitions.</div></div>
<div class="ttc" id="ap4est__communication_8h_html_af29e500817471c16943a8f6517e41e6f"><div class="ttname"><a href="p4est__communication_8h.html#af29e500817471c16943a8f6517e41e6f">p4est_comm_count_pertree</a></div><div class="ttdeci">void p4est_comm_count_pertree(p4est_t *p4est, p4est_gloidx_t *pertree)</div><div class="ttdoc">Compute and distribute the cumulative number of quadrants per tree.</div></div>
<div class="ttc" id="ap4est__connectivity_8h_html_a208e613cae5e1bd3baffb587387b672c"><div class="ttname"><a href="p4est__connectivity_8h.html#a208e613cae5e1bd3baffb587387b672c">p4est_connectivity_destroy</a></div><div class="ttdeci">void p4est_connectivity_destroy(p4est_connectivity_t *connectivity)</div><div class="ttdoc">Destroy a connectivity structure.</div></div>
<div class="ttc" id="ap4est__connectivity_8h_html_a2c4786e65053166a16b7afb2711d35cb"><div class="ttname"><a href="p4est__connectivity_8h.html#a2c4786e65053166a16b7afb2711d35cb">P4EST_DIM</a></div><div class="ttdeci">#define P4EST_DIM</div><div class="ttdoc">The spatial dimension.</div><div class="ttdef"><b>Definition:</b> p4est_connectivity.h:71</div></div>
<div class="ttc" id="ap4est__connectivity_8h_html_a524e3271ec0560d269403e5ec1c993dc"><div class="ttname"><a href="p4est__connectivity_8h.html#a524e3271ec0560d269403e5ec1c993dc">p4est_connectivity_new_brick</a></div><div class="ttdeci">p4est_connectivity_t * p4est_connectivity_new_brick(int mi, int ni, int periodic_a, int periodic_b)</div><div class="ttdoc">A rectangular m by n array of trees with configurable periodicity.</div></div>
<div class="ttc" id="ap4est__connectivity_8h_html_aab03936b137ccdc4fa7520e7e017fcf0"><div class="ttname"><a href="p4est__connectivity_8h.html#aab03936b137ccdc4fa7520e7e017fcf0">p4est_connectivity_new_unitsquare</a></div><div class="ttdeci">p4est_connectivity_t * p4est_connectivity_new_unitsquare(void)</div><div class="ttdoc">Create a connectivity structure for the unit square.</div></div>
<div class="ttc" id="ap4est__connectivity_8h_html_acb49ce9f7b688a2c6b6d62bda9ff5555"><div class="ttname"><a href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a></div><div class="ttdeci">#define P4EST_CHILDREN</div><div class="ttdoc">The number of children of a quadrant, also the number of corners.</div><div class="ttdef"><b>Definition:</b> p4est_connectivity.h:75</div></div>
<div class="ttc" id="ap4est__connectivity_8h_html_adc5f6166fc408c325589ce3e620552caa5bf35c11d90c02cb481e9edadb51bda7"><div class="ttname"><a href="p4est__connectivity_8h.html#adc5f6166fc408c325589ce3e620552caa5bf35c11d90c02cb481e9edadb51bda7">P4EST_CONNECT_FULL</a></div><div class="ttdeci">@ P4EST_CONNECT_FULL</div><div class="ttdoc">= CORNER.</div><div class="ttdef"><b>Definition:</b> p4est_connectivity.h:119</div></div>
<div class="ttc" id="ap4est__extended_8h_html"><div class="ttname"><a href="p4est__extended_8h.html">p4est_extended.h</a></div><div class="ttdoc">Interface routines with extended capabilities.</div></div>
<div class="ttc" id="ap4est__extended_8h_html_a06630b99f70cb85c73452640e8b4d54e"><div class="ttname"><a href="p4est__extended_8h.html#a06630b99f70cb85c73452640e8b4d54e">p4est_coarsen_ext</a></div><div class="ttdeci">void p4est_coarsen_ext(p4est_t *p4est, int coarsen_recursive, int callback_orphans, p4est_coarsen_t coarsen_fn, p4est_init_t init_fn, p4est_replace_t replace_fn)</div><div class="ttdoc">Coarsen a forest.</div></div>
<div class="ttc" id="ap4est__extended_8h_html_a124f2669c375fa66dc746be591ca2404"><div class="ttname"><a href="p4est__extended_8h.html#a124f2669c375fa66dc746be591ca2404">p4est_partition_ext</a></div><div class="ttdeci">p4est_gloidx_t p4est_partition_ext(p4est_t *p4est, int partition_for_coarsening, p4est_weight_t weight_fn)</div><div class="ttdoc">Repartition the forest.</div></div>
<div class="ttc" id="ap4est__extended_8h_html_aad32df9df3630b6bac05e7366a5f1e46"><div class="ttname"><a href="p4est__extended_8h.html#aad32df9df3630b6bac05e7366a5f1e46">p4est_refine_ext</a></div><div class="ttdeci">void p4est_refine_ext(p4est_t *p4est, int refine_recursive, int maxlevel, p4est_refine_t refine_fn, p4est_init_t init_fn, p4est_replace_t replace_fn)</div><div class="ttdoc">Refine a forest with a bounded refinement level and a replace option.</div></div>
<div class="ttc" id="ap4est__extended_8h_html_ac11cf572e8ac72c4beb78465f98b63f3"><div class="ttname"><a href="p4est__extended_8h.html#ac11cf572e8ac72c4beb78465f98b63f3">p4est_new_ext</a></div><div class="ttdeci">p4est_t * p4est_new_ext(sc_MPI_Comm mpicomm, p4est_connectivity_t *connectivity, p4est_locidx_t min_quadrants, int min_level, int fill_uniform, size_t data_size, p4est_init_t init_fn, void *user_pointer)</div><div class="ttdoc">Create a new forest.</div></div>
<div class="ttc" id="ap4est__search_8h_html"><div class="ttname"><a href="p4est__search_8h.html">p4est_search.h</a></div><div class="ttdoc">Search through quadrants, the local part of a forest, or the partition.</div></div>
<div class="ttc" id="ap4est__search_8h_html_a08966f233b715e731217a2c2d288bbeb"><div class="ttname"><a href="p4est__search_8h.html#a08966f233b715e731217a2c2d288bbeb">p4est_search_local</a></div><div class="ttdeci">void p4est_search_local(p4est_t *p4est, int call_post, p4est_search_local_t quadrant_fn, p4est_search_local_t point_fn, sc_array_t *points)</div><div class="ttdoc">Search through the local part of a forest.</div></div>
<div class="ttc" id="ap4est__search_8h_html_a877607ea5e4b91e4272bce17cadca43e"><div class="ttname"><a href="p4est__search_8h.html#a877607ea5e4b91e4272bce17cadca43e">p4est_search_all</a></div><div class="ttdeci">void p4est_search_all(p4est_t *p4est, int call_post, p4est_search_all_t quadrant_fn, p4est_search_all_t point_fn, sc_array_t *points)</div><div class="ttdoc">Perform a top-down search on the whole forest.</div></div>
<div class="ttc" id="ap4est__vtk_8h_html"><div class="ttname"><a href="p4est__vtk_8h.html">p4est_vtk.h</a></div><div class="ttdoc">Routines for printing a forest and associated fields to VTK format.</div></div>
<div class="ttc" id="ap4est__vtk_8h_html_a17ce523f11f580944630c6c604a070da"><div class="ttname"><a href="p4est__vtk_8h.html#a17ce523f11f580944630c6c604a070da">p4est_vtk_write_header</a></div><div class="ttdeci">p4est_vtk_context_t * p4est_vtk_write_header(p4est_vtk_context_t *cont)</div><div class="ttdoc">Write the VTK header.</div></div>
<div class="ttc" id="ap4est__vtk_8h_html_a23950ebd8b9b99877fa152752b5150d4"><div class="ttname"><a href="p4est__vtk_8h.html#a23950ebd8b9b99877fa152752b5150d4">p4est_vtk_write_footer</a></div><div class="ttdeci">int p4est_vtk_write_footer(p4est_vtk_context_t *cont)</div><div class="ttdoc">Write the VTU footer and clean up.</div></div>
<div class="ttc" id="ap4est__vtk_8h_html_a34dbafa8dbc61172ead1a4da4c7103ca"><div class="ttname"><a href="p4est__vtk_8h.html#a34dbafa8dbc61172ead1a4da4c7103ca">p4est_vtk_context_new</a></div><div class="ttdeci">p4est_vtk_context_t * p4est_vtk_context_new(p4est_t *p4est, const char *filename)</div><div class="ttdoc">The first call to write a VTK file using individual functions.</div></div>
<div class="ttc" id="ap4est__vtk_8h_html_a7120e8be889eed8a43a781db9f12f00a"><div class="ttname"><a href="p4est__vtk_8h.html#a7120e8be889eed8a43a781db9f12f00a">p4est_vtk_write_cell_dataf</a></div><div class="ttdeci">p4est_vtk_context_t * p4est_vtk_write_cell_dataf(p4est_vtk_context_t *cont, int write_tree, int write_level, int write_rank, int wrap_rank, int num_cell_scalars, int num_cell_vectors,...)</div><div class="ttdoc">Write VTK cell data.</div></div>
<div class="ttc" id="ap4est__vtk_8h_html_aec7e360e192839f06f58cbfc7afb6d6c"><div class="ttname"><a href="p4est__vtk_8h.html#aec7e360e192839f06f58cbfc7afb6d6c">p4est_vtk_context_t</a></div><div class="ttdeci">struct p4est_vtk_context p4est_vtk_context_t</div><div class="ttdoc">Opaque context type for writing VTK output with multiple function calls.</div><div class="ttdef"><b>Definition:</b> p4est_vtk.h:42</div></div>
<div class="ttc" id="ap8est__bits_8h_html"><div class="ttname"><a href="p8est__bits_8h.html">p8est_bits.h</a></div><div class="ttdoc">Routines for manipulating quadrants (neighbors, parents, children, etc.)</div></div>
<div class="ttc" id="ap8est__build_8h_html"><div class="ttname"><a href="p8est__build_8h.html">p8est_build.h</a></div><div class="ttdoc">Create a new p8est object by adding individual quadrants in order.</div></div>
<div class="ttc" id="ap8est__communication_8h_html"><div class="ttname"><a href="p8est__communication_8h.html">p8est_communication.h</a></div><div class="ttdoc">Parallel messaging and support code.</div></div>
<div class="ttc" id="ap8est__connectivity_8h_html_a53bdb596e76c52c1e23aaecd0aacc763"><div class="ttname"><a href="p8est__connectivity_8h.html#a53bdb596e76c52c1e23aaecd0aacc763">p8est_connectivity_new_unitcube</a></div><div class="ttdeci">p8est_connectivity_t * p8est_connectivity_new_unitcube(void)</div><div class="ttdoc">Create a connectivity structure for the unit cube.</div></div>
<div class="ttc" id="ap8est__extended_8h_html"><div class="ttname"><a href="p8est__extended_8h.html">p8est_extended.h</a></div><div class="ttdoc">Interface routines with extended capabilities.</div></div>
<div class="ttc" id="ap8est__search_8h_html"><div class="ttname"><a href="p8est__search_8h.html">p8est_search.h</a></div><div class="ttdoc">Search through quadrants, the local part of a forest, or the partition.</div></div>
<div class="ttc" id="ap8est__vtk_8h_html"><div class="ttname"><a href="p8est__vtk_8h.html">p8est_vtk.h</a></div><div class="ttdoc">Routines for printing a forest and associated fields to VTK format.</div></div>
<div class="ttc" id="astructp4est__quadrant_html"><div class="ttname"><a href="structp4est__quadrant.html">p4est_quadrant</a></div><div class="ttdoc">The 2D quadrant datatype.</div><div class="ttdef"><b>Definition:</b> p4est.h:76</div></div>
<div class="ttc" id="astructp4est__quadrant_html_a0f92ad9bd71d9e3f82246d2768ff23ad"><div class="ttname"><a href="structp4est__quadrant.html#a0f92ad9bd71d9e3f82246d2768ff23ad">p4est_quadrant::level</a></div><div class="ttdeci">int8_t level</div><div class="ttdoc">level of refinement</div><div class="ttdef"><b>Definition:</b> p4est.h:80</div></div>
<div class="ttc" id="astructp4est__quadrant_html_a84896efd4c9ace3225253e379fb48a6e"><div class="ttname"><a href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p4est_quadrant::p</a></div><div class="ttdeci">union p4est_quadrant::p4est_quadrant_data p</div><div class="ttdoc">a union of additional data attached to a quadrant</div></div>
<div class="ttc" id="astructp4est__quadrant_html_ad226034132b973fe7955ef797938dea0"><div class="ttname"><a href="structp4est__quadrant.html#ad226034132b973fe7955ef797938dea0">p4est_quadrant::y</a></div><div class="ttdeci">p4est_qcoord_t y</div><div class="ttdoc">coordinates</div><div class="ttdef"><b>Definition:</b> p4est.h:78</div></div>
<div class="ttc" id="astructp4est__tree_html"><div class="ttname"><a href="structp4est__tree.html">p4est_tree</a></div><div class="ttdoc">The p4est tree datatype.</div><div class="ttdef"><b>Definition:</b> p4est.h:129</div></div>
<div class="ttc" id="astructp4est__tree_html_aa17e5be92cc11b1f53f31a8174c19345"><div class="ttname"><a href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">p4est_tree::quadrants</a></div><div class="ttdeci">sc_array_t quadrants</div><div class="ttdoc">locally stored quadrants</div><div class="ttdef"><b>Definition:</b> p4est.h:130</div></div>
<div class="ttc" id="astructp4est_html"><div class="ttname"><a href="structp4est.html">p4est</a></div><div class="ttdoc">The p4est forest datatype.</div><div class="ttdef"><b>Definition:</b> p4est.h:150</div></div>
<div class="ttc" id="astructp4est_html_a124d4dc0b8cd3b07351de80f19351beb"><div class="ttname"><a href="structp4est.html#a124d4dc0b8cd3b07351de80f19351beb">p4est::first_local_tree</a></div><div class="ttdeci">p4est_topidx_t first_local_tree</div><div class="ttdoc">0-based index of first local tree, must be -1 for an empty processor</div><div class="ttdef"><b>Definition:</b> p4est.h:161</div></div>
<div class="ttc" id="astructp4est_html_a40324cbcc175d48f887735afd5c4239f"><div class="ttname"><a href="structp4est.html#a40324cbcc175d48f887735afd5c4239f">p4est::local_num_quadrants</a></div><div class="ttdeci">p4est_locidx_t local_num_quadrants</div><div class="ttdoc">number of quadrants on all trees on this processor</div><div class="ttdef"><b>Definition:</b> p4est.h:167</div></div>
<div class="ttc" id="astructp4est_html_a486eacc9c8e6ce28ff34429d297e703f"><div class="ttname"><a href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">p4est::user_pointer</a></div><div class="ttdeci">void * user_pointer</div><div class="ttdoc">convenience pointer for users, never touched by p4est</div><div class="ttdef"><b>Definition:</b> p4est.h:157</div></div>
<div class="ttc" id="astructp4est_html_a6158d35a403f1dbec23833746c5b4a8b"><div class="ttname"><a href="structp4est.html#a6158d35a403f1dbec23833746c5b4a8b">p4est::trees</a></div><div class="ttdeci">sc_array_t * trees</div><div class="ttdoc">array of all trees</div><div class="ttdef"><b>Definition:</b> p4est.h:178</div></div>
<div class="ttc" id="astructp4est_html_a92c7d2fddd5c84a5245f4873d4f2026a"><div class="ttname"><a href="structp4est.html#a92c7d2fddd5c84a5245f4873d4f2026a">p4est::global_num_quadrants</a></div><div class="ttdeci">p4est_gloidx_t global_num_quadrants</div><div class="ttdoc">number of quadrants on all trees on all processors</div><div class="ttdef"><b>Definition:</b> p4est.h:169</div></div>
<div class="ttc" id="astructp4est_html_abd072c07f3197827fe22c16379de6ab8"><div class="ttname"><a href="structp4est.html#abd072c07f3197827fe22c16379de6ab8">p4est::last_local_tree</a></div><div class="ttdeci">p4est_topidx_t last_local_tree</div><div class="ttdoc">0-based index of last local tree, must be -2 for an empty processor</div><div class="ttdef"><b>Definition:</b> p4est.h:164</div></div>
<div class="ttc" id="aunionp4est__quadrant_1_1p4est__quadrant__data_html_aff6684573d249ebf6af9f035aff5e1a0"><div class="ttname"><a href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">p4est_quadrant::p4est_quadrant_data::user_data</a></div><div class="ttdeci">void * user_data</div><div class="ttdoc">never changed by p4est</div><div class="ttdef"><b>Definition:</b> p4est.h:94</div></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/>
</body>
</html>
