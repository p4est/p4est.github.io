<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>p4est: A demonstration of how to manage application data</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">p4est
   &#160;<span id="projectnumber">2.8.7</span>
   </div>
   <div id="projectbrief">p4est is a software library for parallel adaptive mesh refinement.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">A demonstration of how to manage application data </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is an example of a typical application workflow with associated data.</p>
<p>By design <a class="el" href="group__p4est.html">p4est</a> is agnostic of any application data. It supports two major ways of the application developer managing their simulation data: Stashing it into <a class="el" href="group__p4est.html">p4est</a>'s quadrant data storage or leaving it external to <a class="el" href="group__p4est.html">p4est</a>, allocated and maintained by the application developer. Both approaches may be combined, for example to store refinement flags in the quadrant data and numerical fields outside of <a class="el" href="structp4est.html" title="The p4est forest datatype.">p4est</a>.</p>
<p>We review both ways below and close with general recommendations. For simplicity, we reference 2D function calls in this document, all of which have analogous versions in 3D.</p>
<h2><a class="anchor" id="autotoc_md18"></a>
p4est-internal element data</h2>
<p>In <a class="el" href="group__p4est.html">p4est</a>, an element is the leaf node of a quadtree (2D) or octree (3D). In the code, we call all nodes of a tree a quadrant, including leaves. The library maintains internal data for each element, to which a fixed amount of user data may be added. If <a class="el" href="p4est__extended_8h.html#ac11cf572e8ac72c4beb78465f98b63f3">p4est_new_ext</a> or <a class="el" href="p4est_8h.html#af67f1f302a644e8b15cb0e56ed7f4acb">p4est_reset_data</a> is called with a nonzero data size, <a class="el" href="group__p4est.html">p4est</a> allocates and maintains this amount of storage in each quadrant. It is accessible to the application developer by the <code>p.user_data</code> pointer in each <a class="el" href="structp4est__quadrant.html">p4est_quadrant</a>.</p>
<p>The user data may be initialized by the <a class="el" href="p4est_8h.html#a33d436b39a1f58fa87c265a60d2d2be3">p4est_init_t</a> callback to the forest <b>new</b>, <b>refine</b>, <b>coarsen</b>, and <b>balance</b> functions, for example <a class="el" href="p4est__extended_8h.html#aad32df9df3630b6bac05e7366a5f1e46">p4est_refine_ext</a> (see <a class="el" href="p4est_8h.html">p4est.h</a> and <a class="el" href="p4est__extended_8h.html">p4est_extended.h</a>).</p>
<p>The data may be updated by any other callback to these functions, for example <a class="el" href="p4est_8h.html#ad6f6d433abde78f20ea267e6aebea26a">p4est_refine_t</a> or <a class="el" href="p4est__extended_8h.html#a3183ffccd96efb695bc0b58ce6010ebd">p4est_replace_t</a>. Likewise, the data is accessible from the <a class="el" href="p4est__iterate_8h.html#adb709fe6510c4f0b3a918d2f976dbfbc">p4est_iter_volume_t</a> callback as the <code>quad</code> member of the <a class="el" href="structp4est__iter__volume__info.html">p4est_iter_volume_info</a> argument. The volume iterator may be called on a valid forest any time, even without a <a class="el" href="structp4est__ghost.html">p4est_ghost</a> layer being present.</p>
<p>And finally, the user is very welcome to loop manually over all local trees and their quadrants to access their data.</p>
<p>On <b>repartitioning</b> the mesh for load balancing, the quadrant user data is transferred transparently inside <a class="el" href="p4est_8h.html#a54c1f4e6bc35c181952371a8046523aa">p4est_partition</a>.</p>
<p>We also provide the <a class="el" href="p4est__ghost_8h.html#a58908a7bf0810077c99a6ddccc642fcd">p4est_ghost_exchange_data</a> function to gather the user data of all remote quadrants neighboring to a process.</p>
<p>This approach is well suited for typical amounts of refinement metadata (such as indicators and flags) and lightweight numerical data. It is fixed-size: each quadrant has the exact same amount of user data.</p>
<h2><a class="anchor" id="autotoc_md19"></a>
User-allocated element data</h2>
<p>The second part of the example keeps the simulation data in a flat array of values outside of <a class="el" href="structp4est.html" title="The p4est forest datatype.">p4est</a>. We still use internal quadrant data but only for refinement and coarsening flags, which are computed by iterating simultaneously over the quadrants and the array of application data using <a class="el" href="p4est__iterate_8h.html#aca75de06c7e9f039fa3be925a6ae87b4">p4est_iterate</a>.</p>
<p>Here, we make a new copy of the current mesh and then modify it as in the previous example, but without touching the data while it is in progress. Then we invoke a piece of custom code to traverse both the current and new mesh and their data arrays to transfer the values to the new resolution. Afterwards, we delete the current mesh and data array and make the new ones current. This idea can be copied as needed by anyone to interpolate their own data. It is a powerful approach.</p>
<p>To load-balance after adaptation (or for any other reason), we again make a copy of the current mesh and partition that. This transfers internal quadrant data but not yet the simulation data. To effect this, we call <a class="el" href="p4est__communication_8h.html#a9a9ef6c16f81067f0c917a838a8fdfac">p4est_transfer_fixed</a> on the old data array and a newly allocated one for the results. Afterwards, we delete the current mesh and data and make the new ones current.</p>
<p>This approach can be extended to data that is of variable size between the mesh elements. On the application developer side, this requires just some more bookkeeping of memory offsets. In this case, the transfer on repartition can be accomplished using <a class="el" href="p4est__communication_8h.html#ace044f4c221f25afbb9a198ff24b676a">p4est_transfer_custom</a>. We currently do not have a variable-size variant of <a class="el" href="structp4est__ghost__exchange.html">p4est_ghost_exchange</a>, but the interested user is welcome to write it and propose a pull request.</p>
<p>All transfer functions have a version that is split between begin and end to overlap communication with computation.</p>
<h2><a class="anchor" id="autotoc_md20"></a>
Which way should I choose?</h2>
<p>The source code for this demonstration resides in <a class="el" href="userdata_2userdata_run2_8c-example.html">userdata/userdata_run2.c</a> (2D) and <a class="el" href="userdata_2userdata_run3_8c-example.html">userdata/userdata_run3.c</a> (3D). You may run any of these examples and examine the difference in the VTK outputs of the two methods (easiest when configured <code>--disable-vtk-binary</code>). There will be some (too small to affect the rate of convergence) in line with the following analysis.</p>
<p>The demo with internal data interpolates and projects data on the fly In the same round of adaptation. It may happen that a quadrant is refined and immediately coarsened, or coarsened and immediately refined again. Both cases waste some amount of computation, and in the latter case, we slightly decrease accuracy. While such is usually harmless, it can be avoided altogether by extending the quadrant data with refinement metadata. This is left as an exercise to the reader.</p>
<p>We have specifically written the demo with external data such that it avoids the above issue by design. Since quadrant data and application data are independent, we can execute a full round of refinement, coarsening and 2:1 balance on the mesh and only update the application data once after that is done.</p>
<p>We lean towards keeping flags and other small context data in the quadrant storage internal to <a class="el" href="structp4est.html" title="The p4est forest datatype.">p4est</a>, and possibly the simulation data when writing examples quickly. For more serious applications and memory demands, the data may be kept explicitly in user-allocated arrays as demonstrated here. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/>
</body>
</html>
