<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>p4est: spheres/spheres2.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">p4est
   &#160;<span id="projectnumber">2.8.6.259-54a6</span>
   </div>
   <div id="projectbrief">p4est is a software library for parallel adaptive mesh refinement.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">spheres/spheres2.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>This 2D example program (3D counterpart: <a class="el" href="spheres_2spheres3_8c-example.html">spheres/spheres3.c</a>) randomly generates parallel distributed sets of 2D sphere shells (annuli) and refines all quadrants of a 2D forest intersecting any of the cells. The sphere shells are entered as query objects into a partition search, which assigns them to all their intersecting processes. Subsequently, the processes are informed about incoming messages using a notify algorithm. Then the spheres' definitions are sent using non-blocking point-to-point communication. The receiving processes enter the sphere shells into a local search. When any sphere intersects a leaf quadrant, the quadrant is marked for refinement. The refined forest gets repartitioned before entering the next iteration of adaptive refinement. During the searches there are two tests to decide if a sphere shell intersects a quadrant. On the leaf level an exact test is performed. On shallower levels an approximate test compares the distance of the sphere center and the quadrant center with their radii to determine if an intersection is theoretically possible.</p>
<p>Usage: <code>p4est_spheres</code> with the following options: </p><pre class="fragment">*    -l | --minlevel  &lt;INT&gt;       Lowest level
*    -L | --maxlevel  &lt;INT&gt;       Highest level
*    -r | --rmax      &lt;REAL&gt;      Max sphere radius
*    -t | --thickness &lt;REAL&gt;      Relative sphere thickness
*    -f | --lfraction &lt;REAL&gt;      Length density of spheres
*    -s | --spherelems &lt;REAL&gt;     Min elements per sphere diameter
*    -N | --nbottom   &lt;INT&gt;       Notify bottom multiplicator
*    -A | --alltoall  &lt;BOOLEAN&gt; Notify alltoall implementation
*    -S | --scaling   &lt;BOOLEAN&gt; Configure for scaling test
*    -R | --repetitions &lt;INT&gt;     Repeat run multiple times
*    -V | --write-vtk &lt;BOOLEAN&gt; Output VTK files
*    -P | --prefix    &lt;STRING&gt;    Prefix for file output </pre><div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">  This file is part of p4est.</span></div>
<div class="line"><span class="comment">  p4est is a C library to manage a collection (a forest) of multiple</span></div>
<div class="line"><span class="comment">  connected adaptive quadtrees or octrees in parallel.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  Copyright (C) 2010 The University of Texas System</span></div>
<div class="line"><span class="comment">  Additional copyright (C) 2011 individual authors</span></div>
<div class="line"><span class="comment">  Written by Carsten Burstedde, Lucas C. Wilcox, and Tobin Isaac</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  p4est is free software; you can redistribute it and/or modify</span></div>
<div class="line"><span class="comment">  it under the terms of the GNU General Public License as published by</span></div>
<div class="line"><span class="comment">  the Free Software Foundation; either version 2 of the License, or</span></div>
<div class="line"><span class="comment">  (at your option) any later version.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  p4est is distributed in the hope that it will be useful,</span></div>
<div class="line"><span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><span class="comment">  GNU General Public License for more details.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  You should have received a copy of the GNU General Public License</span></div>
<div class="line"><span class="comment">  along with p4est; if not, write to the Free Software Foundation, Inc.,</span></div>
<div class="line"><span class="comment">  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;sc_functions.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sc_notify.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sc_options.h&gt;</span></div>
<div class="line"><span class="preprocessor">#ifndef P4_TO_P8</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p4est__bits_8h.html">p4est_bits.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p4est__communication_8h.html">p4est_communication.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p4est__extended_8h.html">p4est_extended.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p4est__search_8h.html">p4est_search.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p4est__vtk_8h.html">p4est_vtk.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#define SPHERES_DIM_G           &quot;%g %g&quot;</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p8est__bits_8h.html">p8est_bits.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p8est__communication_8h.html">p8est_communication.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p8est__extended_8h.html">p8est_extended.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p8est__search_8h.html">p8est_search.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="p8est__vtk_8h.html">p8est_vtk.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#define SPHERES_DIM_G           &quot;%g %g %g&quot;</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* P4_TO_P8 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#include &quot;spheres_global.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line"><span class="preprocessor">#define SPHERES_CHATTY</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define SPHERES_xstr(s) SPHERES_str(s)</span></div>
<div class="line"><span class="preprocessor">#define SPHERES_str(s) #s</span></div>
<div class="line"><span class="preprocessor">#define SPHERES_48() SPHERES_xstr(P4EST_CHILDREN)</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div>
<div class="line">{</div>
<div class="line">  SPHERES_TAG_SPHERES = P4EST_COMM_TAG_LAST,</div>
<div class="line">  SPHERES_TAG_FIXED,</div>
<div class="line">  SPHERES_TAG_CUSTOM</div>
<div class="line">}</div>
<div class="line">spheres_tags;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div>
<div class="line">{</div>
<div class="line">  STATS_ONCE_FIRST = 0,</div>
<div class="line">  STATS_ONCE_WALL = STATS_ONCE_FIRST,</div>
<div class="line">  STATS_ONCE_NEW,</div>
<div class="line">  STATS_ONCE_GENERATE,</div>
<div class="line">  STATS_ONCE_LAST</div>
<div class="line">}</div>
<div class="line">stats_once_t;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>  *once_names[] = { <span class="stringliteral">&quot;Walltime&quot;</span>, <span class="stringliteral">&quot;New&quot;</span>, <span class="stringliteral">&quot;Generate&quot;</span> };</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div>
<div class="line">{</div>
<div class="line">  STATS_LOOP_FIRST = 0,</div>
<div class="line">  STATS_LOOP_PSEARCH = STATS_LOOP_FIRST,</div>
<div class="line">  STATS_LOOP_SEND,</div>
<div class="line">  STATS_LOOP_NOTIFY,</div>
<div class="line">  STATS_LOOP_RECEIVE,</div>
<div class="line">  STATS_LOOP_WAITSEND,</div>
<div class="line">  STATS_LOOP_LSEARCH,</div>
<div class="line">  STATS_LOOP_REFINE,</div>
<div class="line">  STATS_LOOP_PARTITION,</div>
<div class="line">  STATS_LOOP_TRANSFER,</div>
<div class="line">  STATS_LOOP_LAST</div>
<div class="line">}</div>
<div class="line">stats_loop_t;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>  *loop_names[] = { <span class="stringliteral">&quot;Psearch&quot;</span>, <span class="stringliteral">&quot;Send&quot;</span>, <span class="stringliteral">&quot;Notify&quot;</span>,</div>
<div class="line">  <span class="stringliteral">&quot;Receive&quot;</span>, <span class="stringliteral">&quot;Waitsend&quot;</span>, <span class="stringliteral">&quot;Lsearch&quot;</span>, <span class="stringliteral">&quot;Refine&quot;</span>, <span class="stringliteral">&quot;Partition&quot;</span>, <span class="stringliteral">&quot;Transfer&quot;</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> sc_statinfo_t *</div>
<div class="line">once_index (spheres_global_t * g, stats_once_t once)</div>
<div class="line">{</div>
<div class="line">  P4EST_ASSERT (0 &lt;= once &amp;&amp; once &lt; STATS_ONCE_LAST);</div>
<div class="line">  <span class="keywordflow">return</span> (sc_statinfo_t *) sc_array_index_int (g-&gt;stats, once);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> sc_statinfo_t *</div>
<div class="line">loop_index (spheres_global_t * g, <span class="keywordtype">int</span> lev, stats_loop_t loop)</div>
<div class="line">{</div>
<div class="line">  P4EST_ASSERT (g-&gt;minlevel &lt;= lev &amp;&amp; lev &lt; g-&gt;maxlevel);</div>
<div class="line">  P4EST_ASSERT (0 &lt;= loop &amp;&amp; loop &lt; STATS_LOOP_LAST);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> (sc_statinfo_t *)</div>
<div class="line">    sc_array_index_int (g-&gt;stats, STATS_ONCE_LAST +</div>
<div class="line">                        (lev - g-&gt;minlevel) * STATS_LOOP_LAST + loop);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">accumulate_once (spheres_global_t * g, stats_once_t once, <span class="keywordtype">double</span> t)</div>
<div class="line">{</div>
<div class="line">  sc_stats_accumulate (once_index (g, once), sc_MPI_Wtime () - t);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">accumulate_loop (spheres_global_t * g, <span class="keywordtype">int</span> lev, stats_loop_t loop, <span class="keywordtype">double</span> t)</div>
<div class="line">{</div>
<div class="line">  sc_stats_accumulate (loop_index (g, lev, loop), sc_MPI_Wtime () - t);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> irootlen = 1. / <a name="a0"></a><a class="code" href="p4est_8h.html#ae26167f0411d9845caa84be6d50c0cee">P4EST_ROOT_LEN</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">spheres_init_zero (<a name="_a1"></a><a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>, <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree,</div>
<div class="line">                   <a name="_a2"></a><a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quadrant)</div>
<div class="line">{</div>
<div class="line">  qu_data_t          *qud = (qu_data_t *) quadrant-&gt;<a name="a3"></a><a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a name="a4"></a><a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">  qud-&gt;set_refine = 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">spheres_refine_callback (<a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>, <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree,</div>
<div class="line">                         <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quadrant)</div>
<div class="line">{</div>
<div class="line">  spheres_global_t   *g = (spheres_global_t *) <a class="code" href="structp4est.html">p4est</a>-&gt;<a name="a5"></a><a class="code" href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">user_pointer</a>;</div>
<div class="line">  qu_data_t          *qud = (qu_data_t *) quadrant-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">  <span class="keywordtype">int</span>                 set_refine;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* update variables for the non-refining case */</span></div>
<div class="line">  g-&gt;lsph_offset +=</div>
<div class="line">    (*(<span class="keywordtype">int</span> *) sc_array_index_int (g-&gt;lcounts_refined, g-&gt;lqindex_refined) =</div>
<div class="line">     *(<span class="keywordtype">int</span> *) sc_array_index_int (g-&gt;lcounts, g-&gt;lqindex));</div>
<div class="line">  ++g-&gt;lqindex;</div>
<div class="line">  ++g-&gt;lqindex_refined;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* the replace callback updates the variables if refined */</span></div>
<div class="line">  set_refine = qud-&gt;set_refine;</div>
<div class="line">  qud-&gt;set_refine = 0;</div>
<div class="line">  <span class="keywordflow">return</span> set_refine;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef P4EST_ENABLE_DEBUG</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">center_in_box (<span class="keyword">const</span> p4est_sphere_t * box, <span class="keyword">const</span> p4est_sphere_t * sph)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 i;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; <a name="a6"></a><a class="code" href="p4est__connectivity_8h.html#a2c4786e65053166a16b7afb2711d35cb">P4EST_DIM</a>; ++i) {</div>
<div class="line">    <span class="keywordflow">if</span> (fabs (box-&gt;center[i] - sph-&gt;center[i]) &gt; box-&gt;radius) {</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">spheres_replace_callback (<a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>, <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree,</div>
<div class="line">                          <span class="keywordtype">int</span> num_outgoing, <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * outgoing[],</div>
<div class="line">                          <span class="keywordtype">int</span> num_incoming, <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * incoming[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 c;</div>
<div class="line">  <span class="keywordtype">double</span>              discr[<a class="code" href="p4est__connectivity_8h.html#a2c4786e65053166a16b7afb2711d35cb">P4EST_DIM</a>];</div>
<div class="line">  sc_array_t          neworder[<a name="a7"></a><a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a>];</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      outg_spheres, prev_spheres, li;</div>
<div class="line">  p4est_sphere_t     *sph;</div>
<div class="line"><span class="preprocessor">#ifdef P4EST_ENABLE_DEBUG</span></div>
<div class="line">  p4est_sphere_t      box;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  spheres_global_t   *g = (spheres_global_t *) <a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">user_pointer</a>;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (num_outgoing == 1);</div>
<div class="line">  P4EST_ASSERT (num_incoming == <a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a>);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef P4EST_ENABLE_DEBUG</span></div>
<div class="line">  p4est_quadrant_sphere_box (outgoing[0], &amp;box);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  discr[0] = incoming[1]-&gt;<a name="a8"></a>x * irootlen;</div>
<div class="line">  discr[1] = incoming[2]-&gt;<a name="a9"></a><a class="code" href="structp4est__quadrant.html#ad226034132b973fe7955ef797938dea0">y</a> * irootlen;</div>
<div class="line"><span class="preprocessor">#ifdef P4_TO_P8</span></div>
<div class="line">  discr[2] = incoming[4]-&gt;z * irootlen;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  P4EST_ASSERT (!((qu_data_t *) outgoing[0]-&gt;p.user_data)-&gt;set_refine);</div>
<div class="line">  <span class="keywordflow">for</span> (c = 0; c &lt; <a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a>; ++c) {</div>
<div class="line">    sc_array_init (&amp;neworder[c], <span class="keyword">sizeof</span> (p4est_sphere_t));</div>
<div class="line">    P4EST_ASSERT (!((qu_data_t *) incoming[c]-&gt;p.user_data)-&gt;set_refine);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* we know that the refine callback for this quadrant returned true */</span></div>
<div class="line">  P4EST_ASSERT (g-&gt;lqindex &gt;= 1);</div>
<div class="line">  P4EST_ASSERT (g-&gt;lqindex_refined &gt;= 1);</div>
<div class="line">  (void) sc_array_push_count (g-&gt;lcounts_refined, <a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a> - 1);</div>
<div class="line">  outg_spheres = *(<span class="keywordtype">int</span> *) sc_array_index (g-&gt;lcounts, g-&gt;lqindex - 1);</div>
<div class="line">  prev_spheres = g-&gt;lsph_offset - outg_spheres;</div>
<div class="line">  P4EST_ASSERT (0 &lt;= prev_spheres &amp;&amp; prev_spheres &lt;= g-&gt;lsph);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* sort spheres in child quadrant order */</span></div>
<div class="line">  <span class="keywordflow">for</span> (li = 0; li &lt; outg_spheres; ++li) {</div>
<div class="line">    sph = (p4est_sphere_t *) sc_array_index_int (g-&gt;sphr, prev_spheres + li);</div>
<div class="line">    P4EST_ASSERT (center_in_box (&amp;box, sph));</div>
<div class="line">    c = 0;</div>
<div class="line">    c += (sph-&gt;center[0] &gt; discr[0]);</div>
<div class="line">    c += (sph-&gt;center[1] &gt; discr[1]) &lt;&lt; 1;</div>
<div class="line"><span class="preprocessor">#ifdef P4_TO_P8</span></div>
<div class="line">    c += (sph-&gt;center[2] &gt; discr[2]) &lt;&lt; 2;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    P4EST_ASSERT (0 &lt;= c &amp;&amp; c &lt; <a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a>);</div>
<div class="line">    *(p4est_sphere_t *) sc_array_push (&amp;neworder[c]) = *sph;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* assign sort results by child */</span></div>
<div class="line">  li = prev_spheres;</div>
<div class="line">  <span class="keywordflow">for</span> (c = 0; c &lt; <a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a>; ++c) {</div>
<div class="line">    sc_array_copy_into (g-&gt;sphr, li, &amp;neworder[c]);</div>
<div class="line">    li += (*(<span class="keywordtype">int</span> *) sc_array_index_int (g-&gt;lcounts_refined,</div>
<div class="line">                                        g-&gt;lqindex_refined - 1 + c) =</div>
<div class="line">           (int) neworder[c].elem_count);</div>
<div class="line">    sc_array_reset (&amp;neworder[c]);</div>
<div class="line">  }</div>
<div class="line">  P4EST_ASSERT (li == g-&gt;lsph_offset);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* finally update the running offset */</span></div>
<div class="line">  g-&gt;lqindex_refined += <a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a> - 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">spheres_write_vtk (spheres_global_t * g, <span class="keyword">const</span> <span class="keywordtype">char</span> *str, <span class="keywordtype">int</span> lev)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">char</span>                filename[BUFSIZ];</div>
<div class="line">  sc_array_t         *sdata;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a>      tt;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      lall, lq;</div>
<div class="line">  <a name="_a10"></a><a class="code" href="structp4est__tree.html">p4est_tree_t</a>       *tree;</div>
<div class="line">  <a class="code" href="p4est__vtk_8h.html#aec7e360e192839f06f58cbfc7afb6d6c">p4est_vtk_context_t</a> *cont;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (0 &lt;= g-&gt;minlevel &amp;&amp; g-&gt;maxlevel &lt;= <a name="a11"></a><a class="code" href="p4est_8h.html#a398bac71234696389c90d0f986bb31aa">P4EST_QMAXLEVEL</a>);</div>
<div class="line">  P4EST_ASSERT (g-&gt;minlevel &lt;= lev &amp;&amp; lev &lt;= g-&gt;maxlevel);</div>
<div class="line">  P4EST_ASSERT (g-&gt;lcounts != NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* write VTK output of sphere counts */</span></div>
<div class="line">  <span class="keywordflow">if</span> (!g-&gt;write_vtk) {</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* run-once loop for clean return */</span></div>
<div class="line">  cont = NULL;</div>
<div class="line">  sdata = NULL;</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    <span class="comment">/* open files for output */</span></div>
<div class="line">    snprintf (filename, BUFSIZ, <span class="stringliteral">&quot;%s_sph_%d_%d_%s_%d&quot;</span>,</div>
<div class="line">              g-&gt;prefix, g-&gt;minlevel, g-&gt;maxlevel, str, lev);</div>
<div class="line">    cont = <a name="a12"></a><a class="code" href="p4est__vtk_8h.html#a34dbafa8dbc61172ead1a4da4c7103ca">p4est_vtk_context_new</a> (g-&gt;p4est, filename);</div>
<div class="line">    <span class="keywordflow">if</span> (NULL == <a name="a13"></a><a class="code" href="p4est__vtk_8h.html#a17ce523f11f580944630c6c604a070da">p4est_vtk_write_header</a> (cont)) {</div>
<div class="line">      P4EST_LERRORF (<span class="stringliteral">&quot;Failed to write header for %s\n&quot;</span>, filename);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* prepare cell data for output */</span></div>
<div class="line">    sdata = sc_array_new_count</div>
<div class="line">      (<span class="keyword">sizeof</span> (<span class="keywordtype">double</span>), g-&gt;p4est-&gt;local_num_quadrants);</div>
<div class="line">    <span class="keywordflow">for</span> (lall = 0, tt = g-&gt;p4est-&gt;first_local_tree;</div>
<div class="line">         tt &lt;= g-&gt;<a class="code" href="structp4est.html">p4est</a>-&gt;<a name="a14"></a><a class="code" href="structp4est.html#abd072c07f3197827fe22c16379de6ab8">last_local_tree</a>; ++tt) {</div>
<div class="line">      tree = p4est_tree_array_index (g-&gt;p4est-&gt;trees, tt);</div>
<div class="line">      <span class="keywordflow">for</span> (lq = 0; lq &lt; (<a name="a15"></a><a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) tree-&gt;<a name="a16"></a><a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>.elem_count; ++lq) {</div>
<div class="line">        <span class="comment">/* access number of spheres for this quadrant */</span></div>
<div class="line">        *(<span class="keywordtype">double</span> *) sc_array_index_int (sdata, lall) =</div>
<div class="line">          *(<span class="keywordtype">int</span> *) sc_array_index_int (g-&gt;lcounts, lall);</div>
<div class="line">        ++lall;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    P4EST_ASSERT (lall == g-&gt;p4est-&gt;local_num_quadrants);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if 1</span></div>
<div class="line">    <span class="comment">/* write cell data to file */</span></div>
<div class="line">    <span class="keywordflow">if</span> (NULL == <a name="a17"></a><a class="code" href="p4est__vtk_8h.html#a7120e8be889eed8a43a781db9f12f00a">p4est_vtk_write_cell_dataf</a></div>
<div class="line">        (cont, 1, 1, 1, g-&gt;mpiwrap, 1, 0, <span class="stringliteral">&quot;spheres&quot;</span>, sdata, cont)) {</div>
<div class="line">      P4EST_LERRORF (<span class="stringliteral">&quot;Failed to write cell data for %s\n&quot;</span>, filename);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    sc_array_destroy_null (&amp;sdata);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* finish meta information and close files */</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a18"></a><a class="code" href="p4est__vtk_8h.html#a23950ebd8b9b99877fa152752b5150d4">p4est_vtk_write_footer</a> (cont)) {</div>
<div class="line">      P4EST_LERRORF (<span class="stringliteral">&quot;Failed to write footer for %s\n&quot;</span>, filename);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">while</span> (0);</div>
<div class="line">  <span class="keywordflow">if</span> (sdata != NULL) {</div>
<div class="line">    sc_array_destroy_null (&amp;sdata);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">sphere_offsets (spheres_global_t * g)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 p;</div>
<div class="line">  <span class="keywordtype">int</span>                 mpiret;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>      lg, *gval;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g != NULL &amp;&amp; g-&gt;goffsets != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;goffsets-&gt;elem_size == sizeof (<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>));</div>
<div class="line">  P4EST_ASSERT (g-&gt;goffsets-&gt;elem_count == (<span class="keywordtype">size_t</span>) (g-&gt;mpisize + 1));</div>
<div class="line">  P4EST_ASSERT (g-&gt;sphr-&gt;elem_count == (<span class="keywordtype">size_t</span>) g-&gt;lsph);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* obtain globally unique numbers for the spheres */</span></div>
<div class="line">  *(<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a> *) sc_array_index (g-&gt;goffsets, 0) = 0;</div>
<div class="line">  lg = (<a name="a19"></a><a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>) g-&gt;lsph;</div>
<div class="line">  mpiret = sc_MPI_Allgather (&amp;lg, 1, P4EST_MPI_GLOIDX,</div>
<div class="line">                             sc_array_index (g-&gt;goffsets, 1),</div>
<div class="line">                             1, P4EST_MPI_GLOIDX, g-&gt;mpicomm);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line">  lg = 0;</div>
<div class="line">  <span class="keywordflow">for</span> (p = 1; p &lt;= g-&gt;mpisize; ++p) {</div>
<div class="line">    gval = (<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a> *) sc_array_index (g-&gt;goffsets, p);</div>
<div class="line">    *gval = (lg += *gval);</div>
<div class="line">  }</div>
<div class="line">  P4EST_ASSERT</div>
<div class="line">    (lg == *(<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a> *) sc_array_index (g-&gt;goffsets, g-&gt;mpisize));</div>
<div class="line">  g-&gt;gsoff = *(<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a> *) sc_array_index (g-&gt;goffsets, g-&gt;mpirank);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">create_forest (spheres_global_t * g)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 mpiret;</div>
<div class="line">  <span class="keywordtype">double</span>              rmin, rmax, rgeom2;</div>
<div class="line">  <span class="keywordtype">double</span>              coef, fact, vmult;</div>
<div class="line">  <span class="keywordtype">double</span>              Vexp, Nexp, r;</div>
<div class="line">  <span class="keywordtype">double</span>              vdensity, sumrd, gsrd;</div>
<div class="line">  <span class="keywordtype">double</span>              tnew, tgenerate;</div>
<div class="line">  <span class="keywordtype">char</span>                filename[BUFSIZ];</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a>      which_tree;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      ntrel, tin;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      qunsph;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      sph_excl, sph_incl;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      li;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a05ea8ceb664ae2403fbcf7b1dcc70ea0">p4est_qcoord_t</a>      qh;</div>
<div class="line">  <a class="code" href="structp4est__tree.html">p4est_tree_t</a>       *tree;</div>
<div class="line">  <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a>   *q;</div>
<div class="line">  p4est_sphere_t     *sph;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* create empty initial forest */</span></div>
<div class="line">  tnew = sc_MPI_Wtime ();</div>
<div class="line">  g-&gt;conn = <a name="a20"></a><a class="code" href="p4est__connectivity_8h.html#ae65fe72b77b6f6c6825fc33efc101dab">p4est_connectivity_new_periodic</a> ();</div>
<div class="line">  g-&gt;p4est = <a name="a21"></a><a class="code" href="p4est__extended_8h.html#ac11cf572e8ac72c4beb78465f98b63f3">p4est_new_ext</a> (g-&gt;mpicomm, g-&gt;conn, 0, g-&gt;minlevel, 1,</div>
<div class="line">                            sizeof (qu_data_t), spheres_init_zero, g);</div>
<div class="line">  accumulate_once (g, STATS_ONCE_NEW, tnew);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* output initial mesh */</span></div>
<div class="line">  <span class="keywordflow">if</span> (g-&gt;write_vtk) {</div>
<div class="line">    snprintf (filename, BUFSIZ, <span class="stringliteral">&quot;%s_sph_%d_%d_%s_%d&quot;</span>,</div>
<div class="line">              g-&gt;prefix, g-&gt;minlevel, g-&gt;maxlevel, <span class="stringliteral">&quot;new&quot;</span>, g-&gt;minlevel);</div>
<div class="line">    <a name="a22"></a><a class="code" href="p4est__vtk_8h.html#a9e8a44b027b5372824a2c1ef2c17dea8">p4est_vtk_write_file</a> (g-&gt;p4est, NULL, filename);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* minimum and maximum radius determined by target levels */</span></div>
<div class="line">  tgenerate = sc_MPI_Wtime ();</div>
<div class="line">  rmax = .5 * g-&gt;spherelems * sc_intpowf (.5, g-&gt;minlevel);</div>
<div class="line">  rmax = SC_MIN (rmax, g-&gt;rmax);</div>
<div class="line">  P4EST_ASSERT (0. &lt; rmax);</div>
<div class="line">  rmin = .5 * g-&gt;spherelems * sc_intpowf (.5, g-&gt;maxlevel);</div>
<div class="line">  rmin = SC_MIN (rmin, g-&gt;rmax);</div>
<div class="line">  P4EST_ASSERT (0. &lt; rmin &amp;&amp; rmin &lt;= rmax);</div>
<div class="line">  P4EST_GLOBAL_PRODUCTIONF</div>
<div class="line">    (<span class="stringliteral">&quot;Generating spheres with radii %g to %g\n&quot;</span>, rmin, rmax);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* expected volume */</span></div>
<div class="line">  rgeom2 = rmin * rmax;</div>
<div class="line"><span class="preprocessor">#ifndef P4_TO_P8</span></div>
<div class="line">  Vexp = 4. * rgeom2;</div>
<div class="line">  coef = 1. - rmin / rmax;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  Vexp = 8. * rgeom2 * rgeom2 / (.5 * (rmin + rmax));</div>
<div class="line">  coef = 1. - rmin * rmin / (rmax * rmax);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* the multiplication factor is rescaled to compare to a square/cube */</span></div>
<div class="line">  vdensity = <a name="a23"></a><a class="code" href="p4est__connectivity_8h.html#a5a89ed26f2aa4bf1a3f5887f51601fd3">P4EST_DIM_POW</a> (g-&gt;lfraction);</div>
<div class="line">  vmult = vdensity / Vexp;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* generate the spheres on minimum refinement level */</span></div>
<div class="line">  sumrd = 0.;</div>
<div class="line">  sph_excl = sph_incl = 0;</div>
<div class="line">  g-&gt;sphr = sc_array_new (<span class="keyword">sizeof</span> (p4est_sphere_t));</div>
<div class="line">  g-&gt;lcounts = sc_array_new_count (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>),</div>
<div class="line">                                   g-&gt;p4est-&gt;local_num_quadrants);</div>
<div class="line">  <span class="keywordflow">for</span> (which_tree = g-&gt;p4est-&gt;first_local_tree;</div>
<div class="line">       which_tree &lt;= g-&gt;<a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#abd072c07f3197827fe22c16379de6ab8">last_local_tree</a>; ++which_tree) {</div>
<div class="line">    tree = p4est_tree_array_index (g-&gt;p4est-&gt;trees, which_tree);</div>
<div class="line">    ntrel = (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>.elem_count;</div>
<div class="line">    P4EST_ASSERT (ntrel &gt; 0);</div>
<div class="line">    <span class="keywordflow">for</span> (tin = 0; tin &lt; ntrel; ++tin) {</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* initialize random number generator anew for each element */</span></div>
<div class="line">      q = p4est_quadrant_array_index (&amp;tree-&gt;<a class="code" href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">quadrants</a>, tin);</div>
<div class="line">      <a name="a24"></a><a class="code" href="p4est__bits_8h.html#ad04582a2cbc27b809b437977484078c4">p4est_quadrant_srand</a> (q, &amp;g-&gt;rstate);</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* number of spheres relative to volume ratio of quadrant to tree */</span></div>
<div class="line">      Nexp = vmult * sc_intpowf (.5, <a class="code" href="p4est__connectivity_8h.html#a2c4786e65053166a16b7afb2711d35cb">P4EST_DIM</a> * q-&gt;<a name="a25"></a><a class="code" href="structp4est__quadrant.html#a0f92ad9bd71d9e3f82246d2768ff23ad">level</a>);</div>
<div class="line">      qunsph = (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) sc_rand_poisson (&amp;g-&gt;rstate, Nexp);</div>
<div class="line">      *(<span class="keywordtype">int</span> *) sc_array_index (g-&gt;lcounts, tree-&gt;<a name="a26"></a><a class="code" href="structp4est__tree.html#ab0248e174f0d63c76bbe1ba955f732be">quadrants_offset</a> + tin) =</div>
<div class="line">        (int) qunsph;</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* generate spheres for this element */</span></div>
<div class="line">      <span class="keywordflow">if</span> (qunsph &gt; 0) {</div>
<div class="line">        qh = <a name="a27"></a><a class="code" href="p4est_8h.html#a95dd59166894e55562dd7bb741bb78c5">P4EST_QUADRANT_LEN</a> (q-&gt;<a class="code" href="structp4est__quadrant.html#a0f92ad9bd71d9e3f82246d2768ff23ad">level</a>);</div>
<div class="line">        sph_incl = sph_excl + qunsph;</div>
<div class="line">        sph = (p4est_sphere_t *) sc_array_push_count (g-&gt;sphr, qunsph);</div>
<div class="line">        <span class="keywordflow">for</span> (li = sph_excl; li &lt; sph_incl; ++li, ++sph) {</div>
<div class="line">          sph-&gt;center[0] = (q-&gt;x + qh * sc_rand (&amp;g-&gt;rstate)) * irootlen;</div>
<div class="line">          sph-&gt;center[1] = (q-&gt;<a class="code" href="structp4est__quadrant.html#ad226034132b973fe7955ef797938dea0">y</a> + qh * sc_rand (&amp;g-&gt;rstate)) * irootlen;</div>
<div class="line"><span class="preprocessor">#ifdef P4_TO_P8</span></div>
<div class="line">          sph-&gt;center[2] = (q-&gt;z + qh * sc_rand (&amp;g-&gt;rstate)) * irootlen;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">          <span class="keywordflow">if</span> (coef &lt;= 0.) {</div>
<div class="line">            <span class="comment">/* this happens if rmin == rmax: no need to sample */</span></div>
<div class="line">            r = rmin;</div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">else</span> {</div>
<div class="line">            fact = 1. / (1. - coef * sc_rand (&amp;g-&gt;rstate));</div>
<div class="line"><span class="preprocessor">#ifndef P4_TO_P8</span></div>
<div class="line">            r = rmin * fact;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">            r = rmin * sqrt (fact);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">          }</div>
<div class="line">          P4EST_INFOF (<span class="stringliteral">&quot;Created sphere at &quot;</span> SPHERES_DIM_G <span class="stringliteral">&quot; radius %g\n&quot;</span>,</div>
<div class="line">                       sph-&gt;center[0], sph-&gt;center[1]</div>
<div class="line">                       <a name="a28"></a><a class="code" href="p4est__connectivity_8h.html#ae0cf1d101cb8092f5b759a3d3058e7c4">P4EST_ONLY_P8_COMMA</a> (sph-&gt;center[2]), r);</div>
<div class="line">          sph-&gt;radius = r;</div>
<div class="line">          sumrd += <a class="code" href="p4est__connectivity_8h.html#a5a89ed26f2aa4bf1a3f5887f51601fd3">P4EST_DIM_POW</a> (2. * r);</div>
<div class="line">        }</div>
<div class="line">        sph_excl = sph_incl;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  P4EST_ASSERT (sph_incl == sph_excl);</div>
<div class="line">  P4EST_ASSERT (sph_incl == (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) g-&gt;sphr-&gt;elem_count);</div>
<div class="line">  g-&gt;lsph = sph_incl;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* obtain globally unique numbers for the spheres */</span></div>
<div class="line">  g-&gt;goffsets = sc_array_new_count (<span class="keyword">sizeof</span> (<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>), g-&gt;mpisize + 1);</div>
<div class="line">  sphere_offsets (g);</div>
<div class="line">  P4EST_GLOBAL_PRODUCTIONF</div>
<div class="line">    (<span class="stringliteral">&quot;Expected volume %g count %.1f generated %lld\n&quot;</span>,</div>
<div class="line">     Vexp, vmult * g-&gt;conn-&gt;num_trees, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>)</div>
<div class="line">     *(<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a> *) sc_array_index_int (g-&gt;goffsets, g-&gt;mpisize));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* confirm expected volume */</span></div>
<div class="line">  mpiret = sc_MPI_Allreduce (&amp;sumrd, &amp;gsrd, 1, sc_MPI_DOUBLE,</div>
<div class="line">                             sc_MPI_SUM, g-&gt;mpicomm);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line">  P4EST_GLOBAL_PRODUCTIONF (<span class="stringliteral">&quot;Total volume ideal %g achieved %g\n&quot;</span>,</div>
<div class="line">                            vdensity * g-&gt;conn-&gt;num_trees, gsrd);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* stop sphere generation timer */</span></div>
<div class="line">  accumulate_once (g, STATS_ONCE_GENERATE, tgenerate);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">spheres_partition_quadrant (<a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>, <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree,</div>
<div class="line">                            <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quadrant, <span class="keywordtype">int</span> pfirst,</div>
<div class="line">                            <span class="keywordtype">int</span> plast, <span class="keywordtype">void</span> *point)</div>
<div class="line">{</div>
<div class="line">  spheres_global_t   *g = (spheres_global_t *) <a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">user_pointer</a>;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g != NULL &amp;&amp; g-&gt;p4est == <a class="code" href="structp4est.html">p4est</a>);</div>
<div class="line">  P4EST_ASSERT (0 &lt;= pfirst &amp;&amp; pfirst &lt;= plast &amp;&amp; plast &lt; g-&gt;mpisize);</div>
<div class="line">  P4EST_ASSERT (point == NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* we are not trying to find local spheres */</span></div>
<div class="line">  <span class="keywordflow">if</span> (pfirst == plast &amp;&amp; pfirst == g-&gt;mpirank) {</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* record quadrant&#39;s position and size */</span></div>
<div class="line">  p4est_quadrant_sphere_box (quadrant, &amp;g-&gt;box);</div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">spheres_partition_point (<a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>, <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree,</div>
<div class="line">                         <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quadrant, <span class="keywordtype">int</span> pfirst, <span class="keywordtype">int</span> plast,</div>
<div class="line">                         <span class="keywordtype">void</span> *point)</div>
<div class="line">{</div>
<div class="line">  spheres_global_t   *g = (spheres_global_t *) <a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">user_pointer</a>;</div>
<div class="line">  <span class="keywordtype">int</span>                 last_sphere_proc;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      li;</div>
<div class="line">  p4est_sphere_t     *sph;</div>
<div class="line">  sph_item_t         *item;</div>
<div class="line">  sr_buf_t           *to_proc;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g != NULL &amp;&amp; g-&gt;p4est == <a class="code" href="structp4est.html">p4est</a>);</div>
<div class="line">  P4EST_ASSERT (0 &lt;= pfirst &amp;&amp; pfirst &lt;= plast &amp;&amp; plast &lt; g-&gt;mpisize);</div>
<div class="line">  P4EST_ASSERT (point != NULL);</div>
<div class="line">  P4EST_ASSERT (g-&gt;box.radius ==</div>
<div class="line">                .5 * <a class="code" href="p4est_8h.html#a95dd59166894e55562dd7bb741bb78c5">P4EST_QUADRANT_LEN</a> (quadrant-&gt;<a class="code" href="structp4est__quadrant.html#a0f92ad9bd71d9e3f82246d2768ff23ad">level</a>) * irootlen);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* access sphere under consideration */</span></div>
<div class="line">  li = *(<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> *) point;</div>
<div class="line">  sph = (p4est_sphere_t *) sc_array_index_int (g-&gt;sphr, li);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* we may be up in the tree branches */</span></div>
<div class="line">  <span class="keywordflow">if</span> (pfirst &lt; plast) {</div>
<div class="line">    <span class="keywordflow">if</span> (!p4est_sphere_match_approx (&amp;g-&gt;box, sph, g-&gt;thickness)) {</div>
<div class="line"><span class="preprocessor">#ifdef SPHERES_CHATTY</span></div>
<div class="line">      P4EST_INFOF (<span class="stringliteral">&quot;No approx match in %d %d for %ld\n&quot;</span>,</div>
<div class="line">                   pfirst, plast, (<span class="keywordtype">long</span>) li);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* an optimistic match is good enough when we&#39;re walking the tree */</span></div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* we have found the partition of one remote process */</span></div>
<div class="line">  P4EST_ASSERT (pfirst == plast);</div>
<div class="line">  P4EST_ASSERT (pfirst != g-&gt;mpirank);</div>
<div class="line">  <span class="keywordflow">if</span> (!p4est_sphere_match_exact (&amp;g-&gt;box, sph, g-&gt;thickness)) {</div>
<div class="line"><span class="preprocessor">#ifdef SPHERES_CHATTY</span></div>
<div class="line">    P4EST_INFOF (<span class="stringliteral">&quot;No exact match in %d %d for %ld\n&quot;</span>,</div>
<div class="line">                 pfirst, plast, (<span class="keywordtype">long</span>) li);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef SPHERES_CHATTY</span></div>
<div class="line">  P4EST_INFOF (<span class="stringliteral">&quot;Found in %d %d: %ld\n&quot;</span>, pfirst, plast, (<span class="keywordtype">long</span>) li);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* access send buffer for remote process */</span></div>
<div class="line">  last_sphere_proc = *(<span class="keywordtype">int</span> *) sc_array_index_int (g-&gt;sphere_procs, li);</div>
<div class="line">  <span class="keywordflow">if</span> (pfirst != g-&gt;last_to_rank) {</div>
<div class="line">    P4EST_ASSERT (g-&gt;last_to_rank &lt; pfirst);</div>
<div class="line">    P4EST_ASSERT (last_sphere_proc &lt;= g-&gt;last_to_rank);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* we have found a new receiver process */</span></div>
<div class="line">    *(<span class="keywordtype">int</span> *) sc_array_push (g-&gt;notify) = pfirst;</div>
<div class="line">    *(g-&gt;last_payload = (<span class="keywordtype">int</span> *) sc_array_push (g-&gt;payload)) = 1;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* establish new send buffer for this process */</span></div>
<div class="line">    g-&gt;last_to_rank = pfirst;</div>
<div class="line">    g-&gt;last_to_proc = to_proc = (sr_buf_t *) sc_array_push (g-&gt;to_procs);</div>
<div class="line">    to_proc-&gt;rank = pfirst;</div>
<div class="line">    to_proc-&gt;items = sc_array_new_count (<span class="keyword">sizeof</span> (sph_item_t), 1);</div>
<div class="line">    item = (sph_item_t *) sc_array_index (to_proc-&gt;items, 0);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">/* check whether the sphere is a duplicate */</span></div>
<div class="line">    P4EST_ASSERT (last_sphere_proc &lt;= pfirst);</div>
<div class="line">    <span class="keywordflow">if</span> (last_sphere_proc == pfirst) {</div>
<div class="line"><span class="preprocessor">#ifdef SPHERES_CHATTY</span></div>
<div class="line">      P4EST_INFOF (<span class="stringliteral">&quot;Duplicate in %d %d: %ld\n&quot;</span>, pfirst, plast, (<span class="keywordtype">long</span>) li);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* pust to existing send buffer for current remote process */</span></div>
<div class="line">    to_proc = g-&gt;last_to_proc;</div>
<div class="line">    P4EST_ASSERT (to_proc-&gt;rank == pfirst);</div>
<div class="line">    P4EST_ASSERT (to_proc == (sr_buf_t *)</div>
<div class="line">                  sc_array_index (g-&gt;to_procs, g-&gt;to_procs-&gt;elem_count - 1));</div>
<div class="line">    P4EST_ASSERT (to_proc-&gt;items-&gt;elem_count &gt; 0);</div>
<div class="line">    item = (sph_item_t *) sc_array_push (to_proc-&gt;items);</div>
<div class="line">    ++*g-&gt;last_payload;</div>
<div class="line">  }</div>
<div class="line">  *(<span class="keywordtype">int</span> *) sc_array_index_int (g-&gt;sphere_procs, li) = pfirst;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* pack sphere into send buffer */</span></div>
<div class="line">  item-&gt;sph = *sph;</div>
<div class="line">  item-&gt;gid = g-&gt;gsoff + (<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>) li;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* this return value is ignored */</span></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">spheres_local_quadrant (<a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>, <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree,</div>
<div class="line">                        <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quadrant, <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> local_num,</div>
<div class="line">                        <span class="keywordtype">void</span> *point)</div>
<div class="line">{</div>
<div class="line">  spheres_global_t   *g = (spheres_global_t *) <a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">user_pointer</a>;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g != NULL &amp;&amp; g-&gt;p4est == <a class="code" href="structp4est.html">p4est</a>);</div>
<div class="line">  P4EST_ASSERT (point == NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* record quadrant&#39;s position and size */</span></div>
<div class="line">  p4est_quadrant_sphere_box (quadrant, &amp;g-&gt;box);</div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">spheres_local_point (<a class="code" href="structp4est.html">p4est_t</a> * <a class="code" href="structp4est.html">p4est</a>, <a class="code" href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a> which_tree,</div>
<div class="line">                     <a class="code" href="structp4est__quadrant.html">p4est_quadrant_t</a> * quadrant, <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> local_num,</div>
<div class="line">                     <span class="keywordtype">void</span> *point)</div>
<div class="line">{</div>
<div class="line">  spheres_global_t   *g = (spheres_global_t *) <a class="code" href="structp4est.html">p4est</a>-&gt;<a class="code" href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">user_pointer</a>;</div>
<div class="line">  qu_data_t          *qud = (qu_data_t *) quadrant-&gt;<a class="code" href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p</a>.<a class="code" href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">user_data</a>;</div>
<div class="line">  p4est_sphere_t     *sph;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g != NULL &amp;&amp; g-&gt;p4est == <a class="code" href="structp4est.html">p4est</a>);</div>
<div class="line">  P4EST_ASSERT (point != NULL);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* access sphere under consideration */</span></div>
<div class="line">  sph = *(p4est_sphere_t **) point;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* if quadrant is small enough already, skip this sphere */</span></div>
<div class="line">  <span class="keywordflow">if</span> (.5 * g-&gt;spherelems * <a class="code" href="p4est_8h.html#a95dd59166894e55562dd7bb741bb78c5">P4EST_QUADRANT_LEN</a> (quadrant-&gt;<a class="code" href="structp4est__quadrant.html#a0f92ad9bd71d9e3f82246d2768ff23ad">level</a>) * irootlen &lt;=</div>
<div class="line">      sph-&gt;radius) {</div>
<div class="line"><span class="preprocessor">#ifdef SPHERES_CHATTY</span></div>
<div class="line">    P4EST_INFOF (<span class="stringliteral">&quot;No radius match %g %g in %ld\n&quot;</span>,</div>
<div class="line">                 g-&gt;box.radius, sph-&gt;radius, (<span class="keywordtype">long</span>) local_num);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* we may be up in the tree branches */</span></div>
<div class="line">  <span class="keywordflow">if</span> (local_num &lt; 0) {</div>
<div class="line">    <span class="keywordflow">if</span> (!p4est_sphere_match_approx (&amp;g-&gt;box, sph, g-&gt;thickness)) {</div>
<div class="line"><span class="preprocessor">#ifdef SPHERES_CHATTY</span></div>
<div class="line">      P4EST_INFOF (<span class="stringliteral">&quot;No approx match in %ld\n&quot;</span>, (<span class="keywordtype">long</span>) local_num);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* an optimistic match is good enough when we&#39;re walking the tree */</span></div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (!p4est_sphere_match_exact (&amp;g-&gt;box, sph, g-&gt;thickness)) {</div>
<div class="line"><span class="preprocessor">#ifdef SPHERES_CHATTY</span></div>
<div class="line">    P4EST_INFOF (<span class="stringliteral">&quot;No exact match in %ld\n&quot;</span>, (<span class="keywordtype">long</span>) local_num);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef SPHERES_CHATTY</span></div>
<div class="line">  P4EST_INFOF (<span class="stringliteral">&quot;Found in %ld\n&quot;</span>, (<span class="keywordtype">long</span>) local_num);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  qud-&gt;set_refine = 1;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* this return value is ignored */</span></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">refine_spheres (spheres_global_t * g, <span class="keywordtype">int</span> lev)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 mpiret;</div>
<div class="line">  <span class="keywordtype">int</span>                 q;</div>
<div class="line">  <span class="keywordtype">int</span>                 num_from_spheres;</div>
<div class="line">  <span class="keywordtype">int</span>                 is_refined;</div>
<div class="line">  <span class="keywordtype">double</span>              tpsearch, tsend, tnotify, treceive, twaitsend;</div>
<div class="line">  <span class="keywordtype">double</span>              tlsearch, trefine, tpartition, ttransfer;</div>
<div class="line">  sc_array_t         *points;</div>
<div class="line">  sc_array_t         *pi;</div>
<div class="line">  sc_array_t         *lcounts_partitioned;</div>
<div class="line">  sc_array_t         *sphr_partitioned;</div>
<div class="line">  sc_notify_t        *notifyc;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      li;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>      sri, snum;</div>
<div class="line"><span class="preprocessor">#ifdef P4EST_ENABLE_DEBUG</span></div>
<div class="line">  <a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>      gcur, gnext;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  <a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>      gsloc, gsglo;</div>
<div class="line">  <a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>      gnq;</div>
<div class="line">  <a class="code" href="structp4est.html">p4est_t</a>            *post;</div>
<div class="line">  p4est_sphere_t    **psph;</div>
<div class="line">  sph_item_t         *item;</div>
<div class="line">  sr_buf_t           *proc;</div>
<div class="line"> </div>
<div class="line">  P4EST_ASSERT (g-&gt;minlevel &lt;= lev &amp;&amp; lev &lt; g-&gt;maxlevel);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/*---------------- search partition to find receivers --------------*/</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* prepare data structures for sending spheres */</span></div>
<div class="line">  tpsearch = sc_MPI_Wtime ();</div>
<div class="line">  g-&gt;last_to_proc = NULL;</div>
<div class="line">  g-&gt;last_to_rank = -1;</div>
<div class="line">  g-&gt;to_procs = sc_array_new (<span class="keyword">sizeof</span> (sr_buf_t));</div>
<div class="line">  g-&gt;notify = sc_array_new (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>));</div>
<div class="line">  g-&gt;payload = sc_array_new (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>));</div>
<div class="line">  g-&gt;last_payload = NULL;</div>
<div class="line">  g-&gt;sphere_procs = sc_array_new_count (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>), g-&gt;lsph);</div>
<div class="line">  sc_array_memset (g-&gt;sphere_procs, -1);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* search for remote quadrants that receive spheres */</span></div>
<div class="line">  points = sc_array_new_count (<span class="keyword">sizeof</span> (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>), g-&gt;lsph);</div>
<div class="line">  <span class="keywordflow">for</span> (li = 0; li &lt; g-&gt;lsph; ++li) {</div>
<div class="line">    *(<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a> *) sc_array_index_int (points, li) = li;</div>
<div class="line">  }</div>
<div class="line">  P4EST_INFOF (<span class="stringliteral">&quot;Searching partition for %ld local spheres\n&quot;</span>, (<span class="keywordtype">long</span>) g-&gt;lsph);</div>
<div class="line">  <a name="a29"></a><a class="code" href="p4est__search_8h.html#ac1e3c141fb8e18837819b4b3ab35e4ad">p4est_search_partition</a> (g-&gt;p4est, 0, spheres_partition_quadrant,</div>
<div class="line">                          spheres_partition_point, points);</div>
<div class="line">  sc_array_destroy_null (&amp;points);</div>
<div class="line">  accumulate_loop (g, lev, STATS_LOOP_PSEARCH, tpsearch);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/*------------------------ send the spheres ------------------------*/</span></div>
<div class="line"> </div>
<div class="line">  tsend = sc_MPI_Wtime ();</div>
<div class="line">  P4EST_ASSERT (g-&gt;notify-&gt;elem_count == g-&gt;to_procs-&gt;elem_count);</div>
<div class="line">  P4EST_ASSERT (g-&gt;notify-&gt;elem_count == g-&gt;payload-&gt;elem_count);</div>
<div class="line">  g-&gt;num_to_procs = (int) g-&gt;notify-&gt;elem_count;</div>
<div class="line">  g-&gt;to_requests =</div>
<div class="line">    sc_array_new_count (<span class="keyword">sizeof</span> (sc_MPI_Request), g-&gt;num_to_procs);</div>
<div class="line">  <span class="keywordflow">for</span> (q = 0; q &lt; g-&gt;num_to_procs; ++q) {</div>
<div class="line">    proc = (sr_buf_t *) sc_array_index_int (g-&gt;to_procs, q);</div>
<div class="line">    P4EST_ASSERT (proc-&gt;rank != g-&gt;mpirank);</div>
<div class="line">    P4EST_ASSERT (proc-&gt;rank == *(<span class="keywordtype">int</span> *) sc_array_index_int (g-&gt;notify, q));</div>
<div class="line">    P4EST_ASSERT (proc-&gt;items != NULL);</div>
<div class="line">    pi = proc-&gt;items;</div>
<div class="line">    P4EST_ASSERT (pi-&gt;elem_size == sizeof (sph_item_t));</div>
<div class="line">    mpiret = sc_MPI_Isend</div>
<div class="line">      (pi-&gt;array, pi-&gt;elem_count * pi-&gt;elem_size, sc_MPI_BYTE,</div>
<div class="line">       proc-&gt;rank, SPHERES_TAG_SPHERES, g-&gt;mpicomm,</div>
<div class="line">       (sc_MPI_Request *) sc_array_index_int (g-&gt;to_requests, q));</div>
<div class="line">    SC_CHECK_MPI (mpiret);</div>
<div class="line">  }</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;sphere_procs);</div>
<div class="line">  accumulate_loop (g, lev, STATS_LOOP_SEND, tsend);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/*------------------ reverse communication pattern -----------------*/</span></div>
<div class="line"> </div>
<div class="line">  tnotify = sc_MPI_Wtime ();</div>
<div class="line">  notifyc = sc_notify_new (g-&gt;mpicomm);</div>
<div class="line">  <span class="keywordflow">if</span> (!g-&gt;notify_alltoall) {</div>
<div class="line">    sc_notify_set_type (notifyc, SC_NOTIFY_NARY);</div>
<div class="line">    sc_notify_nary_set_widths (notifyc, g-&gt;ntop, g-&gt;nint, g-&gt;nbot);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> {</div>
<div class="line">    sc_notify_set_type (notifyc, SC_NOTIFY_PEX);</div>
<div class="line">  }</div>
<div class="line">  sc_notify_payload (g-&gt;notify, NULL, g-&gt;payload, NULL, 1, notifyc);</div>
<div class="line">  sc_notify_destroy (notifyc);</div>
<div class="line">  accumulate_loop (g, lev, STATS_LOOP_NOTIFY, tnotify);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/*---------------------- receive the spheres -----------------------*/</span></div>
<div class="line"> </div>
<div class="line">  treceive = sc_MPI_Wtime ();</div>
<div class="line">  P4EST_ASSERT (g-&gt;notify-&gt;elem_count == g-&gt;payload-&gt;elem_count);</div>
<div class="line">  g-&gt;num_from_procs = (int) g-&gt;notify-&gt;elem_count;</div>
<div class="line">  g-&gt;from_requests =</div>
<div class="line">    sc_array_new_count (<span class="keyword">sizeof</span> (sc_MPI_Request), g-&gt;num_from_procs);</div>
<div class="line">  g-&gt;from_procs = sc_array_new_count (<span class="keyword">sizeof</span> (sr_buf_t), g-&gt;num_from_procs);</div>
<div class="line">  <span class="keywordflow">for</span> (q = 0; q &lt; g-&gt;num_from_procs; ++q) {</div>
<div class="line">    proc = (sr_buf_t *) sc_array_index_int (g-&gt;from_procs, q);</div>
<div class="line">    proc-&gt;rank = *(<span class="keywordtype">int</span> *) sc_array_index_int (g-&gt;notify, q);</div>
<div class="line">    P4EST_ASSERT (proc-&gt;rank != g-&gt;mpirank);</div>
<div class="line">    num_from_spheres = *(<span class="keywordtype">int</span> *) sc_array_index_int (g-&gt;payload, q);</div>
<div class="line">    pi = proc-&gt;items =</div>
<div class="line">      sc_array_new_count (<span class="keyword">sizeof</span> (sph_item_t), num_from_spheres);</div>
<div class="line">    mpiret = sc_MPI_Irecv</div>
<div class="line">      (pi-&gt;array, pi-&gt;elem_count * pi-&gt;elem_size, sc_MPI_BYTE,</div>
<div class="line">       proc-&gt;rank, SPHERES_TAG_SPHERES, g-&gt;mpicomm,</div>
<div class="line">       (sc_MPI_Request *) sc_array_index_int (g-&gt;from_requests, q));</div>
<div class="line">    SC_CHECK_MPI (mpiret);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/*--------------- complete receive and first cleanup ---------------*/</span></div>
<div class="line"> </div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;payload);</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;notify);</div>
<div class="line"> </div>
<div class="line">  mpiret = sc_MPI_Waitall</div>
<div class="line">    (g-&gt;num_from_procs, (sc_MPI_Request *) g-&gt;from_requests-&gt;array,</div>
<div class="line">     sc_MPI_STATUSES_IGNORE);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;from_requests);</div>
<div class="line">  accumulate_loop (g, lev, STATS_LOOP_RECEIVE, treceive);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/*---------------- refine based on received spheres ----------------*/</span></div>
<div class="line"> </div>
<div class="line">  tlsearch = sc_MPI_Wtime ();</div>
<div class="line">  points = sc_array_new (<span class="keyword">sizeof</span> (p4est_sphere_t *));</div>
<div class="line">  sri = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* ranks less than ours */</span></div>
<div class="line">  <span class="keywordflow">for</span> (q = 0; q &lt; g-&gt;num_from_procs; ++q) {</div>
<div class="line">    proc = (sr_buf_t *) sc_array_index_int (g-&gt;from_procs, q);</div>
<div class="line">    P4EST_ASSERT (proc-&gt;rank != g-&gt;mpirank);</div>
<div class="line">    <span class="keywordflow">if</span> (proc-&gt;rank &gt;= g-&gt;mpirank) {</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#ifdef P4EST_ENABLE_DEBUG</span></div>
<div class="line">    gcur = *(<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a> *) sc_array_index_int (g-&gt;goffsets, proc-&gt;rank);</div>
<div class="line">    gnext =</div>
<div class="line">      *(<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a> *) sc_array_index_int (g-&gt;goffsets, proc-&gt;rank + 1);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    snum = (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) proc-&gt;items-&gt;elem_count;</div>
<div class="line">    psph = (p4est_sphere_t **) sc_array_push_count (points, snum);</div>
<div class="line">    <span class="keywordflow">for</span> (li = 0; li &lt; snum; ++li) {</div>
<div class="line">      item = (sph_item_t *) sc_array_index_int (proc-&gt;items, li);</div>
<div class="line">      P4EST_ASSERT (gcur &lt;= item-&gt;gid &amp;&amp; item-&gt;gid &lt; gnext);</div>
<div class="line">      *psph++ = &amp;item-&gt;sph;</div>
<div class="line">    }</div>
<div class="line">    sri += snum;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* our local spheres */</span></div>
<div class="line">  snum = g-&gt;lsph;</div>
<div class="line">  P4EST_ASSERT (snum == (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) g-&gt;sphr-&gt;elem_count);</div>
<div class="line">  psph = (p4est_sphere_t **) sc_array_push_count (points, snum);</div>
<div class="line">  <span class="keywordflow">for</span> (li = 0; li &lt; snum; ++li) {</div>
<div class="line">    *psph++ = (p4est_sphere_t *) sc_array_index_int (g-&gt;sphr, li);</div>
<div class="line">  }</div>
<div class="line">  sri += snum;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* ranks greater than ours */</span></div>
<div class="line">  <span class="keywordflow">for</span> (; q &lt; g-&gt;num_from_procs; ++q) {</div>
<div class="line">    proc = (sr_buf_t *) sc_array_index_int (g-&gt;from_procs, q);</div>
<div class="line">    P4EST_ASSERT (proc-&gt;rank &gt; g-&gt;mpirank);</div>
<div class="line"><span class="preprocessor">#ifdef P4EST_ENABLE_DEBUG</span></div>
<div class="line">    gcur = *(<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a> *) sc_array_index_int (g-&gt;goffsets, proc-&gt;rank);</div>
<div class="line">    gnext =</div>
<div class="line">      *(<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a> *) sc_array_index_int (g-&gt;goffsets, proc-&gt;rank + 1);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    snum = (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) proc-&gt;items-&gt;elem_count;</div>
<div class="line">    psph = (p4est_sphere_t **) sc_array_push_count (points, snum);</div>
<div class="line">    <span class="keywordflow">for</span> (li = 0; li &lt; snum; ++li) {</div>
<div class="line">      item = (sph_item_t *) sc_array_index_int (proc-&gt;items, li);</div>
<div class="line">      P4EST_ASSERT (gcur &lt;= item-&gt;gid &amp;&amp; item-&gt;gid &lt; gnext);</div>
<div class="line">      *psph++ = &amp;item-&gt;sph;</div>
<div class="line">    }</div>
<div class="line">    sri += snum;</div>
<div class="line">  }</div>
<div class="line">  P4EST_ASSERT (sri == (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) points-&gt;elem_count);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* report (partially redundant) global sum of spheres */</span></div>
<div class="line">  gsloc = (<a class="code" href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a>) sri;</div>
<div class="line">  mpiret = sc_MPI_Allreduce (&amp;gsloc, &amp;gsglo, 1, P4EST_MPI_GLOIDX,</div>
<div class="line">                             sc_MPI_SUM, g-&gt;mpicomm);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line">  P4EST_GLOBAL_PRODUCTIONF (<span class="stringliteral">&quot;Sphere redundant sum %lld\n&quot;</span>, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>) gsglo);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* search through local elements and set refinement flag */</span></div>
<div class="line">  P4EST_INFOF (<span class="stringliteral">&quot;Searching elements for %ld local spheres\n&quot;</span>, (<span class="keywordtype">long</span>) sri);</div>
<div class="line">  <a name="a30"></a><a class="code" href="p4est__search_8h.html#a08966f233b715e731217a2c2d288bbeb">p4est_search_local</a> (g-&gt;p4est, 0, spheres_local_quadrant,</div>
<div class="line">                      spheres_local_point, points);</div>
<div class="line">  sc_array_destroy_null (&amp;points);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* the information received is no longer necessary */</span></div>
<div class="line">  <span class="keywordflow">for</span> (q = 0; q &lt; g-&gt;num_from_procs; ++q) {</div>
<div class="line">    proc = (sr_buf_t *) sc_array_index_int (g-&gt;from_procs, q);</div>
<div class="line">    P4EST_ASSERT (proc-&gt;rank != g-&gt;mpirank);</div>
<div class="line">    P4EST_ASSERT (proc-&gt;items != NULL);</div>
<div class="line">    sc_array_destroy (proc-&gt;items);</div>
<div class="line">  }</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;from_procs);</div>
<div class="line">  accumulate_loop (g, lev, STATS_LOOP_LSEARCH, tlsearch);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* perform actual refinement */</span></div>
<div class="line">  trefine = sc_MPI_Wtime ();</div>
<div class="line">  g-&gt;lqindex = g-&gt;lqindex_refined = 0;</div>
<div class="line">  g-&gt;lsph_offset = 0;</div>
<div class="line">  P4EST_ASSERT ((<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) g-&gt;lcounts-&gt;elem_count ==</div>
<div class="line">                g-&gt;p4est-&gt;local_num_quadrants);</div>
<div class="line">  g-&gt;lcounts_refined = sc_array_new_count (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>),</div>
<div class="line">                                           g-&gt;p4est-&gt;local_num_quadrants);</div>
<div class="line">  gnq = g-&gt;p4est-&gt;global_num_quadrants;</div>
<div class="line">  <a name="a31"></a><a class="code" href="p4est__extended_8h.html#aad32df9df3630b6bac05e7366a5f1e46">p4est_refine_ext</a> (g-&gt;p4est, 0, <a class="code" href="p4est_8h.html#a398bac71234696389c90d0f986bb31aa">P4EST_QMAXLEVEL</a>, spheres_refine_callback,</div>
<div class="line">                    spheres_init_zero, spheres_replace_callback);</div>
<div class="line">  P4EST_ASSERT (g-&gt;lqindex == (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) g-&gt;lcounts-&gt;elem_count);</div>
<div class="line">  P4EST_ASSERT (g-&gt;lqindex_refined ==</div>
<div class="line">                (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) g-&gt;lcounts_refined-&gt;elem_count);</div>
<div class="line">  P4EST_ASSERT ((<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) g-&gt;lcounts_refined-&gt;elem_count ==</div>
<div class="line">                g-&gt;p4est-&gt;local_num_quadrants);</div>
<div class="line">  P4EST_ASSERT (g-&gt;lsph_offset == g-&gt;lsph);</div>
<div class="line">  P4EST_ASSERT (gnq &lt;= g-&gt;<a class="code" href="structp4est.html">p4est</a>-&gt;<a name="a32"></a><a class="code" href="structp4est.html#a92c7d2fddd5c84a5245f4873d4f2026a">global_num_quadrants</a>);</div>
<div class="line">  is_refined = (gnq &lt; g-&gt;p4est-&gt;global_num_quadrants);</div>
<div class="line">  sc_array_destroy (g-&gt;lcounts);</div>
<div class="line">  g-&gt;lcounts = g-&gt;lcounts_refined;</div>
<div class="line">  accumulate_loop (g, lev, STATS_LOOP_REFINE, trefine);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* output refined forest */</span></div>
<div class="line">  <span class="keywordflow">if</span> (is_refined) {</div>
<div class="line">    spheres_write_vtk (g, <span class="stringliteral">&quot;refined&quot;</span>, lev + 1);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/*---------------- complete send and second cleanup ----------------*/</span></div>
<div class="line"> </div>
<div class="line">  twaitsend = sc_MPI_Wtime ();</div>
<div class="line">  mpiret = sc_MPI_Waitall</div>
<div class="line">    (g-&gt;num_to_procs, (sc_MPI_Request *) g-&gt;to_requests-&gt;array,</div>
<div class="line">     sc_MPI_STATUSES_IGNORE);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;to_requests);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (q = 0; q &lt; g-&gt;num_to_procs; ++q) {</div>
<div class="line">    proc = (sr_buf_t *) sc_array_index_int (g-&gt;to_procs, q);</div>
<div class="line">    P4EST_ASSERT (proc-&gt;rank != g-&gt;mpirank);</div>
<div class="line">    P4EST_ASSERT (proc-&gt;items != NULL);</div>
<div class="line">    sc_array_destroy (proc-&gt;items);</div>
<div class="line">  }</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;to_procs);</div>
<div class="line">  accumulate_loop (g, lev, STATS_LOOP_WAITSEND, twaitsend);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/*-------------- partition and transfer owned spheres --------------*/</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (is_refined) {</div>
<div class="line">    <span class="comment">/* copy the forest and partition it */</span></div>
<div class="line">    tpartition = sc_MPI_Wtime ();</div>
<div class="line">    post = <a name="a33"></a><a class="code" href="p4est_8h.html#a808053321e785b3aba01aaa63f68517d">p4est_copy</a> (g-&gt;p4est, 1);</div>
<div class="line">    (void) <a name="a34"></a><a class="code" href="p4est__extended_8h.html#a124f2669c375fa66dc746be591ca2404">p4est_partition_ext</a> (post, 0, NULL);</div>
<div class="line">    accumulate_loop (g, lev, STATS_LOOP_PARTITION, tpartition);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* we go through this even if there was no change in partition. */</span></div>
<div class="line">    ttransfer = sc_MPI_Wtime ();</div>
<div class="line">    lcounts_partitioned =</div>
<div class="line">      sc_array_new_count (<span class="keyword">sizeof</span> (<span class="keywordtype">int</span>), post-&gt;<a name="a35"></a><a class="code" href="structp4est.html#a40324cbcc175d48f887735afd5c4239f">local_num_quadrants</a>);</div>
<div class="line">    <a name="a36"></a><a class="code" href="p4est__communication_8h.html#a9a9ef6c16f81067f0c917a838a8fdfac">p4est_transfer_fixed</a> (post-&gt;<a name="a37"></a><a class="code" href="structp4est.html#ae89a661282bcbca4e84175d137dbda12">global_first_quadrant</a>,</div>
<div class="line">                          g-&gt;p4est-&gt;global_first_quadrant,</div>
<div class="line">                          g-&gt;mpicomm, SPHERES_TAG_FIXED,</div>
<div class="line">                          lcounts_partitioned-&gt;array, g-&gt;lcounts-&gt;array,</div>
<div class="line">                          sizeof (<span class="keywordtype">int</span>));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* transfer spheres to their new owners */</span></div>
<div class="line">    <span class="keywordflow">for</span> (snum = 0, li = 0; li &lt; post-&gt;<a class="code" href="structp4est.html#a40324cbcc175d48f887735afd5c4239f">local_num_quadrants</a>; ++li) {</div>
<div class="line">      snum += *(<span class="keywordtype">int</span> *) sc_array_index_int (lcounts_partitioned, li);</div>
<div class="line">    }</div>
<div class="line">    sphr_partitioned = sc_array_new_count (<span class="keyword">sizeof</span> (p4est_sphere_t), snum);</div>
<div class="line">    <a name="a38"></a><a class="code" href="p4est__communication_8h.html#aded314b1a4985432b08a21f231da9052">p4est_transfer_items</a> (post-&gt;<a class="code" href="structp4est.html#ae89a661282bcbca4e84175d137dbda12">global_first_quadrant</a>,</div>
<div class="line">                          g-&gt;p4est-&gt;global_first_quadrant,</div>
<div class="line">                          g-&gt;mpicomm, SPHERES_TAG_CUSTOM,</div>
<div class="line">                          sphr_partitioned-&gt;array,</div>
<div class="line">                          (<span class="keywordtype">int</span> *) lcounts_partitioned-&gt;array,</div>
<div class="line">                          g-&gt;sphr-&gt;array, (<span class="keywordtype">int</span> *) g-&gt;lcounts-&gt;array,</div>
<div class="line">                          sizeof (p4est_sphere_t));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* reassign partitioned forest and data */</span></div>
<div class="line">    <a name="a39"></a><a class="code" href="p4est_8h.html#a1e78f347378fe8b097ef019214f2338e">p4est_destroy</a> (g-&gt;p4est);</div>
<div class="line">    g-&gt;p4est = post;</div>
<div class="line">    sc_array_destroy (g-&gt;lcounts);</div>
<div class="line">    g-&gt;lcounts = lcounts_partitioned;</div>
<div class="line">    sc_array_destroy (g-&gt;sphr);</div>
<div class="line">    g-&gt;sphr = sphr_partitioned;</div>
<div class="line">    g-&gt;lsph = (<a class="code" href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a>) g-&gt;sphr-&gt;elem_count;</div>
<div class="line">    sphere_offsets (g);</div>
<div class="line">    accumulate_loop (g, lev, STATS_LOOP_TRANSFER, ttransfer);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* output partitioned forest */</span></div>
<div class="line">    spheres_write_vtk (g, <span class="stringliteral">&quot;partitioned&quot;</span>, lev + 1);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> is_refined;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">destroy_forest (spheres_global_t * g)</div>
<div class="line">{</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;sphr);</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;lcounts);</div>
<div class="line">  sc_array_destroy_null (&amp;g-&gt;goffsets);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="p4est_8h.html#a1e78f347378fe8b097ef019214f2338e">p4est_destroy</a> (g-&gt;p4est);</div>
<div class="line">  <a name="a40"></a><a class="code" href="p4est__connectivity_8h.html#a208e613cae5e1bd3baffb587387b672c">p4est_connectivity_destroy</a> (g-&gt;conn);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">run (spheres_global_t * g)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 mpiret;</div>
<div class="line">  <span class="keywordtype">int</span>                 i;</div>
<div class="line">  <span class="keywordtype">int</span>                 lev;</div>
<div class="line">  <span class="keywordtype">double</span>              twall;</div>
<div class="line">  <span class="keywordtype">char</span>                name[BUFSIZ];</div>
<div class="line">  sc_statinfo_t      *si;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* synchronize before timing begins */</span></div>
<div class="line">  mpiret = sc_MPI_Barrier (g-&gt;mpicomm);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line">  twall = sc_MPI_Wtime ();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* allocate statistics counters */</span></div>
<div class="line">  g-&gt;num_stats =</div>
<div class="line">    STATS_ONCE_LAST + (g-&gt;maxlevel - g-&gt;minlevel) * STATS_LOOP_LAST;</div>
<div class="line">  g-&gt;stats = sc_array_new_count (<span class="keyword">sizeof</span> (sc_statinfo_t), g-&gt;num_stats);</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; STATS_ONCE_LAST; ++i) {</div>
<div class="line">    sc_stats_init_ext (once_index (g, (stats_once_t) i), once_names[i],</div>
<div class="line">                       1, sc_stats_group_all, sc_stats_prio_all);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">for</span> (lev = g-&gt;minlevel; lev &lt; g-&gt;maxlevel; ++lev) {</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; STATS_LOOP_LAST; ++i) {</div>
<div class="line">      snprintf (name, BUFSIZ, <span class="stringliteral">&quot;%10s_%02d&quot;</span>, loop_names[i], lev);</div>
<div class="line">      sc_stats_init_ext (loop_index (g, lev, (stats_loop_t) i), name,</div>
<div class="line">                         1, sc_stats_group_all, sc_stats_prio_all);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* create forest, populate with spheres, loop refine and partition */</span></div>
<div class="line">  create_forest (g);</div>
<div class="line">  <span class="keywordflow">for</span> (lev = g-&gt;minlevel; lev &lt; g-&gt;maxlevel; ++lev) {</div>
<div class="line">    P4EST_GLOBAL_PRODUCTIONF (<span class="stringliteral">&quot;Trying refinement from level %d to %d\n&quot;</span>,</div>
<div class="line">                              lev, lev + 1);</div>
<div class="line">    <span class="keywordflow">if</span> (!refine_spheres (g, lev)) {</div>
<div class="line">      P4EST_GLOBAL_PRODUCTIONF (<span class="stringliteral">&quot;No refinement at level %d\n&quot;</span>, lev);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* free all memory */</span></div>
<div class="line">  destroy_forest (g);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* report performance statistics */</span></div>
<div class="line">  accumulate_once (g, STATS_ONCE_WALL, twall);</div>
<div class="line">  si = once_index (g, STATS_ONCE_FIRST);</div>
<div class="line">  sc_stats_compute (sc_MPI_COMM_WORLD, g-&gt;num_stats, si);</div>
<div class="line">  sc_stats_print (<a name="a41"></a><a class="code" href="p4est__base_8h.html#a8deb5ddec79dfbbadf8bbbf065ec5a9c">p4est_package_id</a>, SC_LP_PRODUCTION, g-&gt;num_stats, si, 0, 1);</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; g-&gt;num_stats; ++i) {</div>
<div class="line">    sc_stats_reset (si + i, 1);</div>
<div class="line">  }</div>
<div class="line">  sc_array_destroy (g-&gt;stats);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">usagerr (sc_options_t * opt, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg)</div>
<div class="line">{</div>
<div class="line">  P4EST_GLOBAL_LERRORF (<span class="stringliteral">&quot;Usage required: %s\n&quot;</span>, msg);</div>
<div class="line">  <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span>                 mpiret;</div>
<div class="line">  <span class="keywordtype">int</span>                 j;</div>
<div class="line">  <span class="keywordtype">int</span>                 ue;</div>
<div class="line">  <span class="keywordtype">int</span>                 first_argc;</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span>         *opt_notify, *opt_vtk, *opt_build;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  sc_options_t       *opt;</div>
<div class="line">  spheres_global_t global, *g = &amp;global;</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** setup mpi environment ***/</span></div>
<div class="line"> </div>
<div class="line">  mpiret = sc_MPI_Init (&amp;argc, &amp;argv);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** initialize global data ***/</span></div>
<div class="line"> </div>
<div class="line">  memset (g, 0, <span class="keyword">sizeof</span> (*g));</div>
<div class="line">  g-&gt;mpicomm = sc_MPI_COMM_WORLD;</div>
<div class="line">  mpiret = sc_MPI_Comm_size (g-&gt;mpicomm, &amp;g-&gt;mpisize);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line">  mpiret = sc_MPI_Comm_rank (g-&gt;mpicomm, &amp;g-&gt;mpirank);</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line">  sc_init (g-&gt;mpicomm, 1, 1, NULL, SC_LP_DEFAULT);</div>
<div class="line">  <a name="a42"></a><a class="code" href="p4est__base_8h.html#aab4b16aa58790d309e0cf46ed665c6b9">p4est_init</a> (NULL, SC_LP_DEFAULT);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef SPHERES_CHATTY</span></div>
<div class="line">  P4EST_GLOBAL_INFOF (<span class="stringliteral">&quot;Sizeof sphere %u item %u\n&quot;</span>,</div>
<div class="line">                      (<span class="keywordtype">unsigned</span>) <span class="keyword">sizeof</span> (p4est_sphere_t),</div>
<div class="line">                      (<span class="keywordtype">unsigned</span>) <span class="keyword">sizeof</span> (sph_item_t));</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** read command line parameters ***/</span></div>
<div class="line"> </div>
<div class="line">  opt = sc_options_new (argv[0]);</div>
<div class="line">  sc_options_add_int (opt, <span class="charliteral">&#39;l&#39;</span>, <span class="stringliteral">&quot;minlevel&quot;</span>, &amp;g-&gt;minlevel, 2, <span class="stringliteral">&quot;Lowest level&quot;</span>);</div>
<div class="line">  sc_options_add_int (opt, <span class="charliteral">&#39;L&#39;</span>, <span class="stringliteral">&quot;maxlevel&quot;</span>, &amp;g-&gt;maxlevel, g-&gt;minlevel + 5,</div>
<div class="line">                      <span class="stringliteral">&quot;Highest level&quot;</span>);</div>
<div class="line">  sc_options_add_double (opt, <span class="charliteral">&#39;r&#39;</span>, <span class="stringliteral">&quot;rmax&quot;</span>, &amp;g-&gt;rmax, .5, <span class="stringliteral">&quot;Max sphere radius&quot;</span>);</div>
<div class="line">  sc_options_add_double (opt, <span class="charliteral">&#39;t&#39;</span>, <span class="stringliteral">&quot;thickness&quot;</span>, &amp;g-&gt;thickness, .05,</div>
<div class="line">                         <span class="stringliteral">&quot;Relative sphere thickness&quot;</span>);</div>
<div class="line">  sc_options_add_double (opt, <span class="charliteral">&#39;f&#39;</span>, <span class="stringliteral">&quot;lfraction&quot;</span>, &amp;g-&gt;lfraction, .7,</div>
<div class="line">                         <span class="stringliteral">&quot;Length density of spheres&quot;</span>);</div>
<div class="line">  sc_options_add_double (opt, <span class="charliteral">&#39;s&#39;</span>, <span class="stringliteral">&quot;spherequads&quot;</span>, &amp;g-&gt;spherelems, 20.,</div>
<div class="line">                         <span class="stringliteral">&quot;Min quadrants per sphere diameter&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  g-&gt;ntop = g-&gt;nint = <a class="code" href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a>;</div>
<div class="line">  sc_options_add_int (opt, <span class="charliteral">&#39;N&#39;</span>, <span class="stringliteral">&quot;nbottom&quot;</span>, &amp;g-&gt;nbot, 24,</div>
<div class="line">                      <span class="stringliteral">&quot;Notify bottom multiplicator&quot;</span>);</div>
<div class="line">  sc_options_add_bool (opt, <span class="charliteral">&#39;A&#39;</span>, <span class="stringliteral">&quot;alltoall&quot;</span>, &amp;g-&gt;notify_alltoall, 0,</div>
<div class="line">                       <span class="stringliteral">&quot;Notify alltoall implementation&quot;</span>);</div>
<div class="line">  sc_options_add_bool (opt, <span class="charliteral">&#39;S&#39;</span>, <span class="stringliteral">&quot;scaling&quot;</span>, &amp;g-&gt;scaling, 0,</div>
<div class="line">                       <span class="stringliteral">&quot;Configure for scaling test&quot;</span>);</div>
<div class="line">  sc_options_add_int (opt, <span class="charliteral">&#39;R&#39;</span>, <span class="stringliteral">&quot;repetitions&quot;</span>, &amp;g-&gt;repetitions, 1,</div>
<div class="line">                      <span class="stringliteral">&quot;Repeat run multiple times&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  sc_options_add_bool (opt, <span class="charliteral">&#39;V&#39;</span>, <span class="stringliteral">&quot;write-vtk&quot;</span>, &amp;g-&gt;write_vtk, 0,</div>
<div class="line">                       <span class="stringliteral">&quot;Output VTK files&quot;</span>);</div>
<div class="line">  sc_options_add_string (opt, <span class="charliteral">&#39;P&#39;</span>, <span class="stringliteral">&quot;prefix&quot;</span>, &amp;g-&gt;prefix,</div>
<div class="line">                         <span class="stringliteral">&quot;sph&quot;</span> SPHERES_48 ()<span class="stringliteral">&quot;res&quot;</span>, <span class="stringliteral">&quot;Prefix for file output&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* set other parameters */</span></div>
<div class="line">  g-&gt;mpiwrap = 16;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* proceed in run-once loop for clean abort */</span></div>
<div class="line">  ue = 0;</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line"><span class="comment">    /*** parse command line and assign configuration variables ***/</span></div>
<div class="line"> </div>
<div class="line">    first_argc = sc_options_parse (<a class="code" href="p4est__base_8h.html#a8deb5ddec79dfbbadf8bbbf065ec5a9c">p4est_package_id</a>, SC_LP_DEFAULT,</div>
<div class="line">                                   opt, argc, argv);</div>
<div class="line">    <span class="keywordflow">if</span> (first_argc &lt; 0 || first_argc != argc) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;Invalid option format or non-option arguments&quot;</span>);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    P4EST_GLOBAL_PRODUCTIONF (<span class="stringliteral">&quot;Dimension is %d\n&quot;</span>, <a class="code" href="p4est__connectivity_8h.html#a2c4786e65053166a16b7afb2711d35cb">P4EST_DIM</a>);</div>
<div class="line">    sc_options_print_summary (<a class="code" href="p4est__base_8h.html#a8deb5ddec79dfbbadf8bbbf065ec5a9c">p4est_package_id</a>, SC_LP_ESSENTIAL, opt);</div>
<div class="line"> </div>
<div class="line"><span class="comment">    /*** check consistency of parameters ***/</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;minlevel &lt; 0 || g-&gt;minlevel &gt; <a class="code" href="p4est_8h.html#a398bac71234696389c90d0f986bb31aa">P4EST_QMAXLEVEL</a>) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;Minlevel between 0 and P4EST_QMAXLEVEL&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;maxlevel == -1) {</div>
<div class="line">      g-&gt;maxlevel = g-&gt;minlevel;</div>
<div class="line">      P4EST_GLOBAL_ESSENTIALF (<span class="stringliteral">&quot;Maxlevel set to %d\n&quot;</span>, g-&gt;maxlevel);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;maxlevel &lt; g-&gt;minlevel || g-&gt;maxlevel &gt; <a class="code" href="p4est_8h.html#a398bac71234696389c90d0f986bb31aa">P4EST_QMAXLEVEL</a>) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;Maxlevel between minlevel and P4EST_QMAXLEVEL&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;rmax &lt;= 0.) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;Maximum sphere radius positive&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;lfraction &lt; 0.) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;Length density non-negative&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;spherelems &lt; 1.) {</div>
<div class="line">      ue = usagerr (opt, <span class="stringliteral">&quot;Elements per sphere no less than 1.&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (ue) {</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="comment">    /*** run program ***/</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (g-&gt;scaling) {</div>
<div class="line">      sc_package_set_verbosity (sc_package_id, SC_LP_PRODUCTION);</div>
<div class="line">      sc_package_set_verbosity (<a class="code" href="p4est__base_8h.html#a8deb5ddec79dfbbadf8bbbf065ec5a9c">p4est_package_id</a>, SC_LP_PRODUCTION);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (j = 0; j &lt; g-&gt;repetitions; ++j) {</div>
<div class="line">      P4EST_GLOBAL_PRODUCTIONF (<span class="stringliteral">&quot;Spheres run repetition %d of %d\n&quot;</span>,</div>
<div class="line">                                j, g-&gt;repetitions);</div>
<div class="line">      run (g);</div>
<div class="line">    }</div>
<div class="line">    P4EST_GLOBAL_PRODUCTIONF (<span class="stringliteral">&quot;Spheres run %d repetitions done\n&quot;</span>,</div>
<div class="line">                              g-&gt;repetitions);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">while</span> (0);</div>
<div class="line">  <span class="keywordflow">if</span> (ue) {</div>
<div class="line">    sc_options_print_usage (<a class="code" href="p4est__base_8h.html#a8deb5ddec79dfbbadf8bbbf065ec5a9c">p4est_package_id</a>, SC_LP_ERROR, opt, NULL);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"><span class="comment">  /*** clean up and exit ***/</span></div>
<div class="line"> </div>
<div class="line">  sc_options_destroy (opt);</div>
<div class="line">  sc_finalize ();</div>
<div class="line"> </div>
<div class="line">  mpiret = sc_MPI_Finalize ();</div>
<div class="line">  SC_CHECK_MPI (mpiret);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> ue ? EXIT_FAILURE : EXIT_SUCCESS;</div>
<div class="line">}</div>
<div class="ttc" id="ap4est_8h_html_a1e78f347378fe8b097ef019214f2338e"><div class="ttname"><a href="p4est_8h.html#a1e78f347378fe8b097ef019214f2338e">p4est_destroy</a></div><div class="ttdeci">void p4est_destroy(p4est_t *p4est)</div><div class="ttdoc">Destroy a p4est.</div></div>
<div class="ttc" id="ap4est_8h_html_a398bac71234696389c90d0f986bb31aa"><div class="ttname"><a href="p4est_8h.html#a398bac71234696389c90d0f986bb31aa">P4EST_QMAXLEVEL</a></div><div class="ttdeci">#define P4EST_QMAXLEVEL</div><div class="ttdoc">The finest level of the quadtree for representing quadrant corners.</div><div class="ttdef"><b>Definition:</b> p4est.h:59</div></div>
<div class="ttc" id="ap4est_8h_html_a808053321e785b3aba01aaa63f68517d"><div class="ttname"><a href="p4est_8h.html#a808053321e785b3aba01aaa63f68517d">p4est_copy</a></div><div class="ttdeci">p4est_t * p4est_copy(p4est_t *input, int copy_data)</div><div class="ttdoc">Make a deep copy of a p4est.</div></div>
<div class="ttc" id="ap4est_8h_html_a95dd59166894e55562dd7bb741bb78c5"><div class="ttname"><a href="p4est_8h.html#a95dd59166894e55562dd7bb741bb78c5">P4EST_QUADRANT_LEN</a></div><div class="ttdeci">#define P4EST_QUADRANT_LEN(l)</div><div class="ttdoc">The length of a quadrant of level l.</div><div class="ttdef"><b>Definition:</b> p4est.h:65</div></div>
<div class="ttc" id="ap4est_8h_html_ae26167f0411d9845caa84be6d50c0cee"><div class="ttname"><a href="p4est_8h.html#ae26167f0411d9845caa84be6d50c0cee">P4EST_ROOT_LEN</a></div><div class="ttdeci">#define P4EST_ROOT_LEN</div><div class="ttdoc">The length of a side of the root quadrant.</div><div class="ttdef"><b>Definition:</b> p4est.h:62</div></div>
<div class="ttc" id="ap4est__base_8h_html_a05ea8ceb664ae2403fbcf7b1dcc70ea0"><div class="ttname"><a href="p4est__base_8h.html#a05ea8ceb664ae2403fbcf7b1dcc70ea0">p4est_qcoord_t</a></div><div class="ttdeci">int32_t p4est_qcoord_t</div><div class="ttdoc">Typedef for quadrant coordinates.</div><div class="ttdef"><b>Definition:</b> p4est_base.h:81</div></div>
<div class="ttc" id="ap4est__base_8h_html_a8deb5ddec79dfbbadf8bbbf065ec5a9c"><div class="ttname"><a href="p4est__base_8h.html#a8deb5ddec79dfbbadf8bbbf065ec5a9c">p4est_package_id</a></div><div class="ttdeci">int p4est_package_id</div><div class="ttdoc">the libsc package id for p4est (set in p4est_init())</div></div>
<div class="ttc" id="ap4est__base_8h_html_a8e849f705b0d4d1702b8f5102823f48c"><div class="ttname"><a href="p4est__base_8h.html#a8e849f705b0d4d1702b8f5102823f48c">p4est_topidx_t</a></div><div class="ttdeci">int32_t p4est_topidx_t</div><div class="ttdoc">Typedef for counting topological entities (trees, tree vertices).</div><div class="ttdef"><b>Definition:</b> p4est_base.h:93</div></div>
<div class="ttc" id="ap4est__base_8h_html_a9f350ee78755ec6e7d25fb1dca474573"><div class="ttname"><a href="p4est__base_8h.html#a9f350ee78755ec6e7d25fb1dca474573">p4est_locidx_t</a></div><div class="ttdeci">int32_t p4est_locidx_t</div><div class="ttdoc">Typedef for processor-local indexing of quadrants and nodes.</div><div class="ttdef"><b>Definition:</b> p4est_base.h:106</div></div>
<div class="ttc" id="ap4est__base_8h_html_aab4b16aa58790d309e0cf46ed665c6b9"><div class="ttname"><a href="p4est__base_8h.html#aab4b16aa58790d309e0cf46ed665c6b9">p4est_init</a></div><div class="ttdeci">void p4est_init(sc_log_handler_t log_handler, int log_threshold)</div><div class="ttdoc">Registers p4est with the SC Library and sets the logging behavior.</div></div>
<div class="ttc" id="ap4est__base_8h_html_af4d787f9b2520af0cfe9a10b89235749"><div class="ttname"><a href="p4est__base_8h.html#af4d787f9b2520af0cfe9a10b89235749">p4est_gloidx_t</a></div><div class="ttdeci">int64_t p4est_gloidx_t</div><div class="ttdoc">Typedef for globally unique indexing of quadrants.</div><div class="ttdef"><b>Definition:</b> p4est_base.h:118</div></div>
<div class="ttc" id="ap4est__bits_8h_html"><div class="ttname"><a href="p4est__bits_8h.html">p4est_bits.h</a></div><div class="ttdoc">Routines for manipulating quadrants (neighbors, parents, children, etc.)</div></div>
<div class="ttc" id="ap4est__bits_8h_html_ad04582a2cbc27b809b437977484078c4"><div class="ttname"><a href="p4est__bits_8h.html#ad04582a2cbc27b809b437977484078c4">p4est_quadrant_srand</a></div><div class="ttdeci">void p4est_quadrant_srand(const p4est_quadrant_t *q, sc_rand_state_t *rstate)</div><div class="ttdoc">Initialize a random number generator by quadrant coordinates.</div></div>
<div class="ttc" id="ap4est__communication_8h_html"><div class="ttname"><a href="p4est__communication_8h.html">p4est_communication.h</a></div><div class="ttdoc">Parallel messaging and support code.</div></div>
<div class="ttc" id="ap4est__communication_8h_html_a9a9ef6c16f81067f0c917a838a8fdfac"><div class="ttname"><a href="p4est__communication_8h.html#a9a9ef6c16f81067f0c917a838a8fdfac">p4est_transfer_fixed</a></div><div class="ttdeci">void p4est_transfer_fixed(const p4est_gloidx_t *dest_gfq, const p4est_gloidx_t *src_gfq, sc_MPI_Comm mpicomm, int tag, void *dest_data, const void *src_data, size_t data_size)</div><div class="ttdoc">Transfer data associated with one forest partition to another.</div></div>
<div class="ttc" id="ap4est__communication_8h_html_aded314b1a4985432b08a21f231da9052"><div class="ttname"><a href="p4est__communication_8h.html#aded314b1a4985432b08a21f231da9052">p4est_transfer_items</a></div><div class="ttdeci">void p4est_transfer_items(const p4est_gloidx_t *dest_gfq, const p4est_gloidx_t *src_gfq, sc_MPI_Comm mpicomm, int tag, void *dest_data, const int *dest_counts, const void *src_data, const int *src_counts, size_t item_size)</div><div class="ttdoc">Transfer variable-count item data between partitions.</div></div>
<div class="ttc" id="ap4est__connectivity_8h_html_a208e613cae5e1bd3baffb587387b672c"><div class="ttname"><a href="p4est__connectivity_8h.html#a208e613cae5e1bd3baffb587387b672c">p4est_connectivity_destroy</a></div><div class="ttdeci">void p4est_connectivity_destroy(p4est_connectivity_t *connectivity)</div><div class="ttdoc">Destroy a connectivity structure.</div></div>
<div class="ttc" id="ap4est__connectivity_8h_html_a2c4786e65053166a16b7afb2711d35cb"><div class="ttname"><a href="p4est__connectivity_8h.html#a2c4786e65053166a16b7afb2711d35cb">P4EST_DIM</a></div><div class="ttdeci">#define P4EST_DIM</div><div class="ttdoc">The spatial dimension.</div><div class="ttdef"><b>Definition:</b> p4est_connectivity.h:71</div></div>
<div class="ttc" id="ap4est__connectivity_8h_html_a5a89ed26f2aa4bf1a3f5887f51601fd3"><div class="ttname"><a href="p4est__connectivity_8h.html#a5a89ed26f2aa4bf1a3f5887f51601fd3">P4EST_DIM_POW</a></div><div class="ttdeci">#define P4EST_DIM_POW(a)</div><div class="ttdoc">Exponentiate with dimension.</div><div class="ttdef"><b>Definition:</b> p4est_connectivity.h:88</div></div>
<div class="ttc" id="ap4est__connectivity_8h_html_acb49ce9f7b688a2c6b6d62bda9ff5555"><div class="ttname"><a href="p4est__connectivity_8h.html#acb49ce9f7b688a2c6b6d62bda9ff5555">P4EST_CHILDREN</a></div><div class="ttdeci">#define P4EST_CHILDREN</div><div class="ttdoc">The number of children of a quadrant, also the number of corners.</div><div class="ttdef"><b>Definition:</b> p4est_connectivity.h:75</div></div>
<div class="ttc" id="ap4est__connectivity_8h_html_ae0cf1d101cb8092f5b759a3d3058e7c4"><div class="ttname"><a href="p4est__connectivity_8h.html#ae0cf1d101cb8092f5b759a3d3058e7c4">P4EST_ONLY_P8_COMMA</a></div><div class="ttdeci">#define P4EST_ONLY_P8_COMMA(x)</div><div class="ttdoc">Only use comma and expression in 3D.</div><div class="ttdef"><b>Definition:</b> p4est_connectivity.h:85</div></div>
<div class="ttc" id="ap4est__connectivity_8h_html_ae65fe72b77b6f6c6825fc33efc101dab"><div class="ttname"><a href="p4est__connectivity_8h.html#ae65fe72b77b6f6c6825fc33efc101dab">p4est_connectivity_new_periodic</a></div><div class="ttdeci">p4est_connectivity_t * p4est_connectivity_new_periodic(void)</div><div class="ttdoc">Create a connectivity structure for an all-periodic unit square.</div></div>
<div class="ttc" id="ap4est__extended_8h_html"><div class="ttname"><a href="p4est__extended_8h.html">p4est_extended.h</a></div><div class="ttdoc">Interface routines with extended capabilities.</div></div>
<div class="ttc" id="ap4est__extended_8h_html_a124f2669c375fa66dc746be591ca2404"><div class="ttname"><a href="p4est__extended_8h.html#a124f2669c375fa66dc746be591ca2404">p4est_partition_ext</a></div><div class="ttdeci">p4est_gloidx_t p4est_partition_ext(p4est_t *p4est, int partition_for_coarsening, p4est_weight_t weight_fn)</div><div class="ttdoc">Repartition the forest.</div></div>
<div class="ttc" id="ap4est__extended_8h_html_aad32df9df3630b6bac05e7366a5f1e46"><div class="ttname"><a href="p4est__extended_8h.html#aad32df9df3630b6bac05e7366a5f1e46">p4est_refine_ext</a></div><div class="ttdeci">void p4est_refine_ext(p4est_t *p4est, int refine_recursive, int maxlevel, p4est_refine_t refine_fn, p4est_init_t init_fn, p4est_replace_t replace_fn)</div><div class="ttdoc">Refine a forest with a bounded refinement level and a replace option.</div></div>
<div class="ttc" id="ap4est__extended_8h_html_ac11cf572e8ac72c4beb78465f98b63f3"><div class="ttname"><a href="p4est__extended_8h.html#ac11cf572e8ac72c4beb78465f98b63f3">p4est_new_ext</a></div><div class="ttdeci">p4est_t * p4est_new_ext(sc_MPI_Comm mpicomm, p4est_connectivity_t *connectivity, p4est_locidx_t min_quadrants, int min_level, int fill_uniform, size_t data_size, p4est_init_t init_fn, void *user_pointer)</div><div class="ttdoc">Create a new forest.</div></div>
<div class="ttc" id="ap4est__search_8h_html"><div class="ttname"><a href="p4est__search_8h.html">p4est_search.h</a></div><div class="ttdoc">Search through quadrants, the local part of a forest, or the partition.</div></div>
<div class="ttc" id="ap4est__search_8h_html_a08966f233b715e731217a2c2d288bbeb"><div class="ttname"><a href="p4est__search_8h.html#a08966f233b715e731217a2c2d288bbeb">p4est_search_local</a></div><div class="ttdeci">void p4est_search_local(p4est_t *p4est, int call_post, p4est_search_local_t quadrant_fn, p4est_search_local_t point_fn, sc_array_t *points)</div><div class="ttdoc">Search through the local part of a forest.</div></div>
<div class="ttc" id="ap4est__search_8h_html_ac1e3c141fb8e18837819b4b3ab35e4ad"><div class="ttname"><a href="p4est__search_8h.html#ac1e3c141fb8e18837819b4b3ab35e4ad">p4est_search_partition</a></div><div class="ttdeci">void p4est_search_partition(p4est_t *p4est, int call_post, p4est_search_partition_t quadrant_fn, p4est_search_partition_t point_fn, sc_array_t *points)</div><div class="ttdoc">Traverse the global partition top-down.</div></div>
<div class="ttc" id="ap4est__vtk_8h_html"><div class="ttname"><a href="p4est__vtk_8h.html">p4est_vtk.h</a></div><div class="ttdoc">Routines for printing a forest and associated fields to VTK format.</div></div>
<div class="ttc" id="ap4est__vtk_8h_html_a17ce523f11f580944630c6c604a070da"><div class="ttname"><a href="p4est__vtk_8h.html#a17ce523f11f580944630c6c604a070da">p4est_vtk_write_header</a></div><div class="ttdeci">p4est_vtk_context_t * p4est_vtk_write_header(p4est_vtk_context_t *cont)</div><div class="ttdoc">Write the VTK header.</div></div>
<div class="ttc" id="ap4est__vtk_8h_html_a23950ebd8b9b99877fa152752b5150d4"><div class="ttname"><a href="p4est__vtk_8h.html#a23950ebd8b9b99877fa152752b5150d4">p4est_vtk_write_footer</a></div><div class="ttdeci">int p4est_vtk_write_footer(p4est_vtk_context_t *cont)</div><div class="ttdoc">Write the VTU footer and clean up.</div></div>
<div class="ttc" id="ap4est__vtk_8h_html_a34dbafa8dbc61172ead1a4da4c7103ca"><div class="ttname"><a href="p4est__vtk_8h.html#a34dbafa8dbc61172ead1a4da4c7103ca">p4est_vtk_context_new</a></div><div class="ttdeci">p4est_vtk_context_t * p4est_vtk_context_new(p4est_t *p4est, const char *filename)</div><div class="ttdoc">The first call to write a VTK file using individual functions.</div></div>
<div class="ttc" id="ap4est__vtk_8h_html_a7120e8be889eed8a43a781db9f12f00a"><div class="ttname"><a href="p4est__vtk_8h.html#a7120e8be889eed8a43a781db9f12f00a">p4est_vtk_write_cell_dataf</a></div><div class="ttdeci">p4est_vtk_context_t * p4est_vtk_write_cell_dataf(p4est_vtk_context_t *cont, int write_tree, int write_level, int write_rank, int wrap_rank, int num_cell_scalars, int num_cell_vectors,...)</div><div class="ttdoc">Write VTK cell data.</div></div>
<div class="ttc" id="ap4est__vtk_8h_html_a9e8a44b027b5372824a2c1ef2c17dea8"><div class="ttname"><a href="p4est__vtk_8h.html#a9e8a44b027b5372824a2c1ef2c17dea8">p4est_vtk_write_file</a></div><div class="ttdeci">void p4est_vtk_write_file(p4est_t *p4est, p4est_geometry_t *geom, const char *filename)</div><div class="ttdoc">Write the p4est in VTK format.</div></div>
<div class="ttc" id="ap4est__vtk_8h_html_aec7e360e192839f06f58cbfc7afb6d6c"><div class="ttname"><a href="p4est__vtk_8h.html#aec7e360e192839f06f58cbfc7afb6d6c">p4est_vtk_context_t</a></div><div class="ttdeci">struct p4est_vtk_context p4est_vtk_context_t</div><div class="ttdoc">Opaque context type for writing VTK output with multiple function calls.</div><div class="ttdef"><b>Definition:</b> p4est_vtk.h:42</div></div>
<div class="ttc" id="ap8est__bits_8h_html"><div class="ttname"><a href="p8est__bits_8h.html">p8est_bits.h</a></div><div class="ttdoc">Routines for manipulating quadrants (neighbors, parents, children, etc.)</div></div>
<div class="ttc" id="ap8est__communication_8h_html"><div class="ttname"><a href="p8est__communication_8h.html">p8est_communication.h</a></div><div class="ttdoc">Parallel messaging and support code.</div></div>
<div class="ttc" id="ap8est__extended_8h_html"><div class="ttname"><a href="p8est__extended_8h.html">p8est_extended.h</a></div><div class="ttdoc">Interface routines with extended capabilities.</div></div>
<div class="ttc" id="ap8est__search_8h_html"><div class="ttname"><a href="p8est__search_8h.html">p8est_search.h</a></div><div class="ttdoc">Search through quadrants, the local part of a forest, or the partition.</div></div>
<div class="ttc" id="ap8est__vtk_8h_html"><div class="ttname"><a href="p8est__vtk_8h.html">p8est_vtk.h</a></div><div class="ttdoc">Routines for printing a forest and associated fields to VTK format.</div></div>
<div class="ttc" id="astructp4est__quadrant_html"><div class="ttname"><a href="structp4est__quadrant.html">p4est_quadrant</a></div><div class="ttdoc">The 2D quadrant datatype.</div><div class="ttdef"><b>Definition:</b> p4est.h:76</div></div>
<div class="ttc" id="astructp4est__quadrant_html_a0f92ad9bd71d9e3f82246d2768ff23ad"><div class="ttname"><a href="structp4est__quadrant.html#a0f92ad9bd71d9e3f82246d2768ff23ad">p4est_quadrant::level</a></div><div class="ttdeci">int8_t level</div><div class="ttdoc">level of refinement</div><div class="ttdef"><b>Definition:</b> p4est.h:80</div></div>
<div class="ttc" id="astructp4est__quadrant_html_a84896efd4c9ace3225253e379fb48a6e"><div class="ttname"><a href="structp4est__quadrant.html#a84896efd4c9ace3225253e379fb48a6e">p4est_quadrant::p</a></div><div class="ttdeci">union p4est_quadrant::p4est_quadrant_data p</div><div class="ttdoc">a union of additional data attached to a quadrant</div></div>
<div class="ttc" id="astructp4est__quadrant_html_ad226034132b973fe7955ef797938dea0"><div class="ttname"><a href="structp4est__quadrant.html#ad226034132b973fe7955ef797938dea0">p4est_quadrant::y</a></div><div class="ttdeci">p4est_qcoord_t y</div><div class="ttdoc">coordinates</div><div class="ttdef"><b>Definition:</b> p4est.h:78</div></div>
<div class="ttc" id="astructp4est__tree_html"><div class="ttname"><a href="structp4est__tree.html">p4est_tree</a></div><div class="ttdoc">The p4est tree datatype.</div><div class="ttdef"><b>Definition:</b> p4est.h:129</div></div>
<div class="ttc" id="astructp4est__tree_html_aa17e5be92cc11b1f53f31a8174c19345"><div class="ttname"><a href="structp4est__tree.html#aa17e5be92cc11b1f53f31a8174c19345">p4est_tree::quadrants</a></div><div class="ttdeci">sc_array_t quadrants</div><div class="ttdoc">locally stored quadrants</div><div class="ttdef"><b>Definition:</b> p4est.h:130</div></div>
<div class="ttc" id="astructp4est__tree_html_ab0248e174f0d63c76bbe1ba955f732be"><div class="ttname"><a href="structp4est__tree.html#ab0248e174f0d63c76bbe1ba955f732be">p4est_tree::quadrants_offset</a></div><div class="ttdeci">p4est_locidx_t quadrants_offset</div><div class="ttdoc">cumulative sum over earlier trees on this processor (locals only)</div><div class="ttdef"><b>Definition:</b> p4est.h:133</div></div>
<div class="ttc" id="astructp4est_html"><div class="ttname"><a href="structp4est.html">p4est</a></div><div class="ttdoc">The p4est forest datatype.</div><div class="ttdef"><b>Definition:</b> p4est.h:150</div></div>
<div class="ttc" id="astructp4est_html_a40324cbcc175d48f887735afd5c4239f"><div class="ttname"><a href="structp4est.html#a40324cbcc175d48f887735afd5c4239f">p4est::local_num_quadrants</a></div><div class="ttdeci">p4est_locidx_t local_num_quadrants</div><div class="ttdoc">number of quadrants on all trees on this processor</div><div class="ttdef"><b>Definition:</b> p4est.h:167</div></div>
<div class="ttc" id="astructp4est_html_a486eacc9c8e6ce28ff34429d297e703f"><div class="ttname"><a href="structp4est.html#a486eacc9c8e6ce28ff34429d297e703f">p4est::user_pointer</a></div><div class="ttdeci">void * user_pointer</div><div class="ttdoc">convenience pointer for users, never touched by p4est</div><div class="ttdef"><b>Definition:</b> p4est.h:157</div></div>
<div class="ttc" id="astructp4est_html_a92c7d2fddd5c84a5245f4873d4f2026a"><div class="ttname"><a href="structp4est.html#a92c7d2fddd5c84a5245f4873d4f2026a">p4est::global_num_quadrants</a></div><div class="ttdeci">p4est_gloidx_t global_num_quadrants</div><div class="ttdoc">number of quadrants on all trees on all processors</div><div class="ttdef"><b>Definition:</b> p4est.h:169</div></div>
<div class="ttc" id="astructp4est_html_abd072c07f3197827fe22c16379de6ab8"><div class="ttname"><a href="structp4est.html#abd072c07f3197827fe22c16379de6ab8">p4est::last_local_tree</a></div><div class="ttdeci">p4est_topidx_t last_local_tree</div><div class="ttdoc">0-based index of last local tree, must be -2 for an empty processor</div><div class="ttdef"><b>Definition:</b> p4est.h:164</div></div>
<div class="ttc" id="astructp4est_html_ae89a661282bcbca4e84175d137dbda12"><div class="ttname"><a href="structp4est.html#ae89a661282bcbca4e84175d137dbda12">p4est::global_first_quadrant</a></div><div class="ttdeci">p4est_gloidx_t * global_first_quadrant</div><div class="ttdoc">first global quadrant index for each process and 1 beyond</div><div class="ttdef"><b>Definition:</b> p4est.h:171</div></div>
<div class="ttc" id="aunionp4est__quadrant_1_1p4est__quadrant__data_html_aff6684573d249ebf6af9f035aff5e1a0"><div class="ttname"><a href="unionp4est__quadrant_1_1p4est__quadrant__data.html#aff6684573d249ebf6af9f035aff5e1a0">p4est_quadrant::p4est_quadrant_data::user_data</a></div><div class="ttdeci">void * user_data</div><div class="ttdoc">never changed by p4est</div><div class="ttdef"><b>Definition:</b> p4est.h:94</div></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/>
</body>
</html>
